<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Poka-Yoke PRO â€¢ Scanner IBRIDO</title>

<!-- ZXing fallback -->
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<!-- jsPDF per PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --bg:#0F172A;        /* sfondo app (blu notte) */
    --panel:#16223A;     /* pannelli */
    --panel-2:#0b162c;   /* pannelli scuri */
    --border:#273449;    /* bordi */
    --text:#E6EDF7;      /* testo primario */
    --muted:#9FB1CB;     /* testo secondario */
    --accent:#38BDF8;    /* azioni */
    --ok:#22C55E;        /* successo */
    --err:#EF4444;       /* errore */
    --warn:#F59E0B;      /* offline */
  }

  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Inter,Segoe UI,Roboto,Arial}
  .app{min-height:100%;display:flex;flex-direction:column}

  /* Header + topbar */
  header{padding:12px 16px;border-bottom:1px solid var(--border);background:#0B1325}
  .topbar{display:flex;align-items:center;gap:10px;justify-content:space-between}
  .brand{font-weight:800}
  .rightTop{display:flex;gap:10px;align-items:center}
  #langSelect,#langSelect2{
    background:#0d182f;border:1px solid var(--border);border-radius:8px;color:var(--text);
    padding:8px 10px;font-size:14px
  }
  #netBadge{font-size:12px;padding:4px 8px;border-radius:8px;border:1px solid var(--border)}
  #netBadge.online{background:rgba(34,197,94,.12);color:#86efac;border-color:#14532d}
  #netBadge.offline{background:rgba(245,158,11,.12);color:#FCD34D;border-color:#B45309}

  /* Tabs */
  .tabs{display:flex;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);background:#0E1A32}
  .tab{padding:10px 14px;border-radius:999px;border:1px solid var(--border);color:var(--muted);cursor:pointer;font-weight:700}
  .tab.active{background:var(--accent);border-color:var(--accent);color:#05263A}

  main{flex:1;display:flex;flex-direction:column}
  .view{display:none;padding:14px}
  .view.active{display:block}

  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px}

  /* Inputs / buttons */
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label.field{display:flex;flex-direction:column;gap:6px;flex:1 1 220px;min-width:200px}
  label.field span{font-size:12px;color:var(--muted)}
  .input, select{background:#0d182f;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px 12px;font-size:16px}
  .btn{padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#11203d;color:var(--text);font-weight:800;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .btn-primary{background:var(--accent);border-color:var(--accent);color:#05263A}
  .btn-ok{background:#0f2a1a;border-color:#14532d}
  .btn-outline{background:#0d182f}

  /* Scanner status */
  .status{display:flex;flex-direction:column;gap:8px;align-items:center;text-align:center}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;border:1px solid var(--border)}
  .badge.ok{background:rgba(34,197,94,.15);color:#86efac;border-color:#14532d}
  .badge.err{background:rgba(239,68,68,.15);color:#fecaca;border-color:#7f1d1d}

  #codes{display:flex;flex-direction:column;gap:10px;align-items:stretch;margin-top:4px;width:100%;max-width:680px}
  .codeBox{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--panel-2)}
  .codeLabel{font-size:13px;color:var(--muted);font-weight:800}
  .codeValue{flex:1;text-align:right;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-weight:900;letter-spacing:.5px;font-size:clamp(22px,3.6vh,40px);color:var(--text);word-break:break-all}
  .codeBox.ok{border-color:#14532d;background:rgba(34,197,94,.10)}
  .codeBox.err{border-color:#7f1d1d;background:rgba(239,68,68,.08)}
  .codeValue.ok{color:#86efac}
  .codeValue.err{color:#fecaca}

  /* Righe raccolte */
  #righeBox{max-height:50vh;overflow:auto;border:1px solid var(--border);border-radius:10px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:14px}
  th{position:sticky;top:0;background:#0f1b35;text-align:left;font-weight:800}
  .countPill{margin-left:8px;font-size:12px;padding:3px 8px;border-radius:10px;background:#0d2230;border:1px solid var(--border);color:var(--muted)}

  /* Fullscreen camera overlay */
  #camFS{position:fixed;inset:0;display:none;background:#000;z-index:9999}
  #camFS.active{display:block}
  .camTop{position:absolute;top:0;left:0;right:0;height:56px;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:linear-gradient(to bottom, rgba(0,0,0,.65), rgba(0,0,0,.0))}
  .camBtn{background:rgba(0,0,0,.45);color:#fff;border:1px solid rgba(255,255,255,.2);padding:8px 12px;border-radius:10px;font-weight:800}
  .camWrap{position:absolute;inset:0}
  #video{position:absolute;inset:0;object-fit:cover;width:100%;height:100%}
  #overlay{position:absolute;inset:0;pointer-events:none}
  #guide{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:34%;height:34%;border:3px solid rgba(255,255,255,.95);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,.35) inset;pointer-events:none}
  #laser{position:absolute;left:50%;top:50%;width:54px;height:54px;border:2px solid rgba(255,60,60,.9);border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 12px rgba(255,60,60,.85);pointer-events:none}

  /* Modale quantitÃ  */
  #qtyModal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:10000}
  .modalCard{background:var(--panel-2);border:1px solid var(--border);border-radius:14px;padding:16px;min-width:280px;max-width:92vw;box-shadow:0 10px 30px rgba(0,0,0,.6)}
  .modalTitle{font-weight:800;margin-bottom:8px}
  .qtyRow{display:flex;gap:10px;align-items:center;justify-content:center;margin:12px 0}
  .qtyBtn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#0f203c;color:var(--text);font-weight:800;font-size:20px;cursor:pointer}
  .qtyInput{width:110px;text-align:center;font-size:22px;font-weight:900;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0f1b35;color:var(--text)}
  .modalActions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}

  /* Toast */
  #toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);min-width:220px;max-width:90vw;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0d2230;color:var(--text);display:none;z-index:10001;text-align:center;font-weight:700}
  #toast.ok{background:rgba(34,197,94,.15);border-color:#14532d;color:#86efac}
  #toast.err{background:rgba(239,68,68,.15);border-color:#7f1d1d;color:#fecaca}

  .muted{color:var(--muted)}
</style>
</head>

<body>
<div class="app">
  <header>
    <div class="topbar">
      <div class="brand" data-i18n="brand">Poka-Yoke PRO â€¢ Scanner IBRIDO</div>
      <div class="rightTop">
        <select id="langSelect" aria-label="Language">
          <option value="it">Italiano</option>
          <option value="pt-BR">PortuguÃªs (BR)</option>
          <option value="en">English</option>
          <option value="ur">Ø§Ø±Ø¯Ùˆ</option>
        </select>
        <span id="netBadge" class="offline">Offline</span>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="commessa" data-i18n="tabs.job">Commessa</button>
    <button class="tab" data-tab="scanner" data-i18n="tabs.scanner">Scanner</button>
    <button class="tab" data-tab="righe" data-i18n="tabs.rows">Righe raccolte</button>
    <button class="tab" data-tab="impostazioni" data-i18n="tabs.settings">Impostazioni</button>
  </div>

  <main>
    <!-- COMMESSA -->
    <section id="commessa" class="view active">
      <div class="panel">
        <div class="row">
          <label class="field">
            <span data-i18n="fields.job">Numero commessa</span>
            <input id="commessaInput" class="input" placeholder="024830" autocomplete="off"/>
          </label>
          <label class="field">
            <span data-i18n="fields.pos">Posizione</span>
            <input id="posizioneInput" class="input" placeholder="POS 0020" autocomplete="off"/>
          </label>
          <label class="field">
            <span data-i18n="fields.op">Operatore</span>
            <input id="operatoreInput" class="input" placeholder="Cognome / ID" autocomplete="off"/>
          </label>
          <label class="field" style="min-width:200px;flex:1 1 260px">
            <span data-i18n="fields.camera">Fotocamera</span>
            <select id="cameraSelect" class="input">
              <option value="">(automatica)</option>
            </select>
          </label>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="goScanner" class="btn btn-primary" data-i18n="actions.goScanner">Vai allo Scanner</button>
        </div>
      </div>
      <div class="panel muted" data-i18n="hints.persist">Commessa/Posizione/Operatore restano salvati sul dispositivo.</div>
    </section>

    <!-- SCANNER -->
    <section id="scanner" class="view">
      <div class="panel status">
        <div id="badge" class="badge">Pronto</div>
        <div id="resultText" data-i18n="status.hint">Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b></div>
        <div id="codes"></div>
        <div class="muted" data-i18n="status.tip">Allinea il codice nel <b>quadrato</b> e centra nel cerchio rosso ğŸ”´.</div>
      </div>

      <div class="panel">
        <div class="row">
          <button id="scanList" class="btn btn-primary" data-i18n="actions.scanList">ğŸ“‹ LISTA (fullscreen)</button>
          <button id="scanItem" class="btn btn-primary" data-i18n="actions.scanItem">ğŸ“¦ PEZZO (fullscreen)</button>
          <button id="reset" class="btn btn-outline" data-i18n="actions.reset">ğŸ”„ Reset</button>
        </div>
      </div>
    </section>

    <!-- RIGHE -->
    <section id="righe" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <div style="font-weight:800">
            <span data-i18n="rows.title">Righe raccolte</span>
            <span class="countPill" id="countPill">0</span>
          </div>
          <div class="row" style="gap:8px">
            <button id="scaricaCSV" class="btn btn-outline" disabled data-i18n="actions.csv">â¬‡ï¸ Scarica CSV</button>
            <button id="scaricaPDF" class="btn btn-outline" disabled data-i18n="actions.pdf">â¬‡ï¸ Scarica PDF</button>
            <button id="saveSession" class="btn btn-outline" data-i18n="actions.save">ğŸ’¾ Salva sessione</button>
            <button id="loadSession" class="btn btn-outline" data-i18n="actions.load">ğŸ“‚ Carica sessione</button>
            <button id="svuota" class="btn btn-outline" disabled data-i18n="actions.clear">ğŸ—‘ï¸ Svuota</button>
          </div>
        </div>
        <div id="righeBox" style="margin-top:10px">
          <table>
            <thead><tr>
              <th data-i18n="table.time">Ora</th>
              <th data-i18n="table.code">Codice</th>
              <th data-i18n="table.qty">Q.tÃ </th>
              <th data-i18n="table.job">Commessa</th>
              <th data-i18n="table.pos">Posizione</th>
            </tr></thead>
            <tbody id="righeBody"></tbody>
          </table>
        </div>
      </div>
      <div class="panel muted" data-i18n="hints.offline">Dati locali. Usa â€œSalva sessioneâ€ per conservarli e â€œCarica sessioneâ€ per ripristinare.</div>
    </section>

    <!-- IMPOSTAZIONI -->
    <section id="impostazioni" class="view">
      <div class="panel">
        <div style="font-weight:800;margin-bottom:8px" data-i18n="settings.title">Impostazioni</div>
        <div class="row">
          <label class="field" style="flex:0 0 260px">
            <span data-i18n="settings.confirm">Conferma doppia</span>
            <select id="optConfirm" class="input">
              <option value="on" selected data-i18n="settings.confirmOn">Attiva (piÃ¹ sicuro)</option>
              <option value="off" data-i18n="settings.confirmOff">Disattiva (piÃ¹ veloce)</option>
            </select>
          </label>
          <label class="field" style="flex:0 0 260px">
            <span data-i18n="settings.voice">Annuncio vocale</span>
            <select id="optVoice" class="input">
              <option value="on" selected data-i18n="common.on">Attivo</option>
              <option value="off" data-i18n="common.off">Disattivo</option>
            </select>
          </label>
          <label class="field" style="flex:0 0 260px">
            <span data-i18n="settings.vibrate">Vibrazione</span>
            <select id="optVibrate" class="input">
              <option value="on" selected data-i18n="common.on">Attiva</option>
              <option value="off" data-i18n="common.off">Disattiva</option>
            </select>
          </label>
          <label class="field" style="flex:0 0 260px">
            <span data-i18n="settings.lang">Lingua</span>
            <select id="langSelect2" class="input">
              <option value="it">Italiano</option>
              <option value="pt-BR">PortuguÃªs (BR)</option>
              <option value="en">English</option>
              <option value="ur">Ø§Ø±Ø¯Ùˆ</option>
            </select>
          </label>
        </div>
      </div>
      <div class="panel muted">UI v1.1 â€¢ Solo locale â€¢ Aggiungi alla Home per esperienza tipo app.</div>
    </section>
  </main>
</div>

<!-- Fullscreen Camera -->
<div id="camFS">
  <div class="camTop">
    <button id="camClose" class="camBtn" data-i18n="actions.close">âœ• Chiudi</button>
    <div id="camHint" class="camBtn" style="pointer-events:none" data-i18n="status.tip">Inquadra e centra nel cerchio</div>
  </div>
  <div class="camWrap">
    <video id="video" muted playsinline></video>
    <canvas id="overlay"></canvas>
    <div id="guide"></div>
    <div id="laser"></div>
  </div>
</div>

<!-- Modale quantitÃ  -->
<div id="qtyModal">
  <div class="modalCard">
    <div class="modalTitle" data-i18n="modal.title">Inserisci quantitÃ  prelevata</div>
    <div id="qtyInfo" class="muted" style="margin-bottom:6px"></div>
    <div class="qtyRow">
      <button id="qtyMinus" class="qtyBtn">âˆ’</button>
      <input id="qtyInput" class="qtyInput" type="number" min="1" step="1" placeholder=""/>
      <button id="qtyPlus" class="qtyBtn">+</button>
    </div>
    <div class="modalActions">
      <button id="qtyCancel" class="btn btn-outline" data-i18n="actions.cancel">Annulla</button>
      <button id="qtyOk" class="btn btn-ok" data-i18n="actions.confirm">Conferma</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
/* ===== i18n (PT-BR / IT / EN / UR) ===== */
const i18n = {
  "it": {
    brand:"Poka-Yoke PRO â€¢ Scanner IBRIDO",
    tabs:{job:"Commessa", scanner:"Scanner", rows:"Righe raccolte", settings:"Impostazioni"},
    fields:{job:"Numero commessa", pos:"Posizione", op:"Operatore", camera:"Fotocamera"},
    actions:{
      goScanner:"Vai allo Scanner", scanList:"ğŸ“‹ LISTA (fullscreen)", scanItem:"ğŸ“¦ PEZZO (fullscreen)",
      reset:"ğŸ”„ Reset", csv:"â¬‡ï¸ Scarica CSV", pdf:"â¬‡ï¸ Scarica PDF",
      save:"ğŸ’¾ Salva sessione", load:"ğŸ“‚ Carica sessione", clear:"ğŸ—‘ï¸ Svuota",
      close:"âœ• Chiudi", cancel:"Annulla", confirm:"Conferma"
    },
    rows:{title:"Righe raccolte"},
    table:{time:"Ora", code:"Codice", qty:"Q.tÃ ", job:"Commessa", pos:"Posizione"},
    status:{ready:"Pronto", hint:"Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b>", tip:"Allinea il codice nel <b>quadrato</b> e centra nel cerchio rosso ğŸ”´"},
    settings:{
      title:"Impostazioni", confirm:"Conferma doppia", confirmOn:"Attiva (piÃ¹ sicuro)", confirmOff:"Disattiva (piÃ¹ veloce)",
      voice:"Annuncio vocale", vibrate:"Vibrazione", lang:"Lingua"
    },
    hints:{persist:"Commessa/Posizione/Operatore restano salvati sul dispositivo.",
           offline:"Dati locali. Usa â€œSalva sessioneâ€ per conservarli e â€œCarica sessioneâ€ per ripristinare."},
    common:{on:"Attivo", off:"Disattivo"},
    toast:{rowAdded:"Riga aggiunta", saved:"Sessione salvata", loaded:"Sessione caricata", cleared:"Sessione svuotata"},
    msg:{needFields:"Inserisci Numero commessa e Posizione prima di scansionare.", qtyRequired:"Inserisci una quantitÃ  valida (>0).", online:"Online", offline:"Offline",
         matchOk:"Codice corretto", matchErr:"Errore, codice diverso"},
    pdf:{
      title:"Scheda Picking",
      meta:{op:"Operatore", job:"Commessa", pos:"Posizione", date:"Data"},
      th:{time:"Ora", code:"Codice", qty:"Q.tÃ "},
      summary:{rows:"Righe totali", pieces:"Pezzi totali"},
      generated:"Generato"
    }
  },
  "pt-BR": {
    brand:"Poka-Yoke PRO â€¢ Scanner HÃBRIDO",
    tabs:{job:"Ordem", scanner:"Scanner", rows:"Linhas coletadas", settings:"ConfiguraÃ§Ãµes"},
    fields:{job:"NÃºmero da ordem", pos:"PosiÃ§Ã£o", op:"Operador(a)", camera:"CÃ¢mera"},
    actions:{
      goScanner:"Ir para o Scanner", scanList:"ğŸ“‹ LISTA (tela cheia)", scanItem:"ğŸ“¦ PEÃ‡A (tela cheia)",
      reset:"ğŸ”„ Resetar", csv:"â¬‡ï¸ Baixar CSV", pdf:"â¬‡ï¸ Baixar PDF",
      save:"ğŸ’¾ Salvar sessÃ£o", load:"ğŸ“‚ Carregar sessÃ£o", clear:"ğŸ—‘ï¸ Limpar",
      close:"âœ• Fechar", cancel:"Cancelar", confirm:"Confirmar"
    },
    rows:{title:"Linhas coletadas"},
    table:{time:"Hora", code:"CÃ³digo", qty:"Qtd.", job:"Ordem", pos:"PosiÃ§Ã£o"},
    status:{ready:"Pronto", hint:"Escaneie primeiro a <b>LISTA</b>, depois a <b>PEÃ‡A</b>", tip:"Alinhe o cÃ³digo no <b>quadrado</b> e centre no cÃ­rculo vermelho ğŸ”´"},
    settings:{
      title:"ConfiguraÃ§Ãµes", confirm:"ConfirmaÃ§Ã£o dupla", confirmOn:"Ativar (mais seguro)", confirmOff:"Desativar (mais rÃ¡pido)",
      voice:"AnÃºncio de voz", vibrate:"VibraÃ§Ã£o", lang:"Idioma"
    },
    hints:{persist:"Ordem/PosiÃ§Ã£o/Operador ficam salvos no dispositivo.",
           offline:"Dados locais. Use â€œSalvar sessÃ£oâ€ para preservar e â€œCarregar sessÃ£oâ€ para restaurar."},
    common:{on:"Ativo", off:"Desativado"},
    toast:{rowAdded:"Linha adicionada", saved:"SessÃ£o salva", loaded:"SessÃ£o carregada", cleared:"SessÃ£o limpa"},
    msg:{needFields:"Informe NÃºmero da ordem e PosiÃ§Ã£o antes de escanear.", qtyRequired:"Informe uma quantidade vÃ¡lida (>0).", online:"Online", offline:"Offline",
         matchOk:"CÃ³digo correto", matchErr:"Erro, cÃ³digo diferente"},
    pdf:{
      title:"Ficha de Picking",
      meta:{op:"Operador(a)", job:"Ordem", pos:"PosiÃ§Ã£o", date:"Data"},
      th:{time:"Hora", code:"CÃ³digo", qty:"Qtd."},
      summary:{rows:"Total de linhas", pieces:"Total de peÃ§as"},
      generated:"Gerado"
    }
  },
  "en": {
    brand:"Poka-Yoke PRO â€¢ Hybrid Scanner",
    tabs:{job:"Job", scanner:"Scanner", rows:"Collected rows", settings:"Settings"},
    fields:{job:"Job number", pos:"Position", op:"Operator", camera:"Camera"},
    actions:{
      goScanner:"Go to Scanner", scanList:"ğŸ“‹ LIST (fullscreen)", scanItem:"ğŸ“¦ ITEM (fullscreen)",
      reset:"ğŸ”„ Reset", csv:"â¬‡ï¸ Download CSV", pdf:"â¬‡ï¸ Download PDF",
      save:"ğŸ’¾ Save session", load:"ğŸ“‚ Load session", clear:"ğŸ—‘ï¸ Clear",
      close:"âœ• Close", cancel:"Cancel", confirm:"Confirm"
    },
    rows:{title:"Collected rows"},
    table:{time:"Time", code:"Code", qty:"Qty", job:"Job", pos:"Position"},
    status:{ready:"Ready", hint:"Scan the <b>LIST</b> first, then the <b>ITEM</b>", tip:"Align the code in the <b>square</b> and center in the red circle ğŸ”´"},
    settings:{
      title:"Settings", confirm:"Double confirmation", confirmOn:"On (safer)", confirmOff:"Off (faster)",
      voice:"Voice prompt", vibrate:"Vibration", lang:"Language"
    },
    hints:{persist:"Job/Position/Operator are saved on device.",
           offline:"Local data only. Use â€œSave sessionâ€ to preserve and â€œLoad sessionâ€ to restore."},
    common:{on:"On", off:"Off"},
    toast:{rowAdded:"Row added", saved:"Session saved", loaded:"Session loaded", cleared:"Session cleared"},
    msg:{needFields:"Enter Job number and Position before scanning.", qtyRequired:"Enter a valid quantity (>0).", online:"Online", offline:"Offline",
         matchOk:"Correct code", matchErr:"Error, different code"},
    pdf:{
      title:"Picking Sheet",
      meta:{op:"Operator", job:"Job", pos:"Position", date:"Date"},
      th:{time:"Time", code:"Code", qty:"Qty"},
      summary:{rows:"Total rows", pieces:"Total pieces"},
      generated:"Generated"
    }
  },
  "ur": {
    brand:"Ù¾ÙˆÚ©Ø§ ÛŒÙˆÚ©Û’ Ù¾Ø±Ùˆ â€¢ ÛØ§Ø¦Ø¨Ø±Úˆ Ø§Ø³Ú©ÛŒÙ†Ø±",
    tabs:{job:"Ø¢Ø±ÚˆØ±", scanner:"Ø§Ø³Ú©ÛŒÙ†Ø±", rows:"Ø§Ú©Ù¹Ú¾ÛŒ Ù„Ø§Ø¦Ù†ÛŒÚº", settings:"ØªØ±ØªÛŒØ¨Ø§Øª"},
    fields:{job:"Ø¢Ø±ÚˆØ± Ù†Ù…Ø¨Ø±", pos:"Ù¾ÙˆØ²ÛŒØ´Ù†", op:"Ø¢Ù¾Ø±ÛŒÙ¹Ø±", camera:"Ú©ÛŒÙ…Ø±Û"},
    actions:{
      goScanner:"Ø§Ø³Ú©ÛŒÙ†Ø± Ù¾Ø± Ø¬Ø§Ø¦ÛŒÚº", scanList:"ğŸ“‹ Ù„Ø³Ù¹ (ÙÙ„ Ø§Ø³Ú©Ø±ÛŒÙ†)", scanItem:"ğŸ“¦ Ø¢Ø¦Ù¹Ù… (ÙÙ„ Ø§Ø³Ú©Ø±ÛŒÙ†)",
      reset:"ğŸ”„ Ø±ÛŒ Ø³ÛŒÙ¹", csv:"â¬‡ï¸ Ø³ÛŒ Ø§ÛŒØ³ ÙˆÛŒ ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆ", pdf:"â¬‡ï¸ Ù¾ÛŒ ÚˆÛŒ Ø§ÛŒÙ ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆ",
      save:"ğŸ’¾ Ø³ÛŒØ´Ù† Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº", load:"ğŸ“‚ Ø³ÛŒØ´Ù† Ù„ÙˆÚˆ Ú©Ø±ÛŒÚº", clear:"ğŸ—‘ï¸ ØµØ§Ù Ú©Ø±ÛŒÚº",
      close:"âœ• Ø¨Ù†Ø¯ Ú©Ø±ÛŒÚº", cancel:"Ù…Ù†Ø³ÙˆØ®", confirm:"ØªØµØ¯ÛŒÙ‚"
    },
    rows:{title:"Ø§Ú©Ù¹Ú¾ÛŒ Ù„Ø§Ø¦Ù†ÛŒÚº"},
    table:{time:"ÙˆÙ‚Øª", code:"Ú©ÙˆÚˆ", qty:"ØªØ¹Ø¯Ø§Ø¯", job:"Ø¢Ø±ÚˆØ±", pos:"Ù¾ÙˆØ²ÛŒØ´Ù†"},
    status:{ready:"ØªÛŒØ§Ø±", hint:"Ù¾ÛÙ„Û’ <b>Ù„Ø³Ù¹</b> Ø§Ø³Ú©ÛŒÙ† Ú©Ø±ÛŒÚºØŒ Ù¾Ú¾Ø± <b>Ø¢Ø¦Ù¹Ù…</b>", tip:"Ú©ÙˆÚˆ Ú©Ùˆ <b>Ø®Ø§Ù†Û’</b> Ù…ÛŒÚº Ø³ÛŒØ¯Ú¾ Ù…ÛŒÚº Ú©Ø±ÛŒÚº Ø§ÙˆØ± Ø³Ø±Ø® Ø¯Ø§Ø¦Ø±Û’ Ù…ÛŒÚº Ù…Ø±Ú©Ø² Ú©Ø±ÛŒÚº ğŸ”´"},
    settings:{
      title:"ØªØ±ØªÛŒØ¨Ø§Øª", confirm:"ÚˆØ¨Ù„ ØªØµØ¯ÛŒÙ‚", confirmOn:"Ø¢Ù† (Ø²ÛŒØ§Ø¯Û Ù…Ø­ÙÙˆØ¸)", confirmOff:"Ø¢Ù (ØªÛŒØ²)",
      voice:"ÙˆØ§Ø¦Ø³ Ù¾Ø±Ø§Ù…Ù¾Ù¹", vibrate:"ÙˆØ§Ø¦Ø¨Ø±ÛŒØ´Ù†", lang:"Ø²Ø¨Ø§Ù†"
    },
    hints:{persist:"Ø¢Ø±ÚˆØ±/Ù¾ÙˆØ²ÛŒØ´Ù†/Ø¢Ù¾Ø±ÛŒÙ¹Ø± ÚˆÛŒÙˆØ§Ø¦Ø³ Ù¾Ø± Ù…Ø­ÙÙˆØ¸ Ø±ÛØªÛ’ ÛÛŒÚºÛ”",
           offline:"Ù…Ù‚Ø§Ù…ÛŒ ÚˆÛŒÙ¹Ø§Û” Ù…Ø­ÙÙˆØ¸ Ú©Ø±Ù†Û’ Ú©ÛŒÙ„Ø¦Û’ â€œØ³ÛŒØ´Ù† Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚºâ€ Ø§ÙˆØ± Ø¨Ø­Ø§Ù„ Ú©Ø±Ù†Û’ Ú©ÛŒÙ„Ø¦Û’ â€œØ³ÛŒØ´Ù† Ù„ÙˆÚˆ Ú©Ø±ÛŒÚºâ€ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ú©Ø±ÛŒÚºÛ”"},
    common:{on:"Ø¢Ù†", off:"Ø¢Ù"},
    toast:{rowAdded:"Ù‚Ø·Ø§Ø± Ø´Ø§Ù…Ù„ ÛÙˆ Ú¯Ø¦ÛŒ", saved:"Ø³ÛŒØ´Ù† Ù…Ø­ÙÙˆØ¸ ÛÙˆ Ú¯ÛŒØ§", loaded:"Ø³ÛŒØ´Ù† Ù„ÙˆÚˆ ÛÙˆ Ú¯ÛŒØ§", cleared:"Ø³ÛŒØ´Ù† ØµØ§Ù ÛÙˆ Ú¯ÛŒØ§"},
    msg:{needFields:"Ø§Ø³Ú©ÛŒÙ† Ú©Ø±Ù†Û’ Ø³Û’ Ù¾ÛÙ„Û’ Ø¢Ø±ÚˆØ± Ù†Ù…Ø¨Ø± Ø§ÙˆØ± Ù¾ÙˆØ²ÛŒØ´Ù† Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”", qtyRequired:"Ø¯Ø±Ø³Øª Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº (>0)Û”", online:"Ø¢Ù† Ù„Ø§Ø¦Ù†", offline:"Ø¢Ù Ù„Ø§Ø¦Ù†",
         matchOk:"Ø¯Ø±Ø³Øª Ú©ÙˆÚˆ", matchErr:"ØºÙ„Ø·ÛŒØŒ Ù…Ø®ØªÙ„Ù Ú©ÙˆÚˆ"},
    pdf:{
      title:"Ù¾Ú©Ù†Ú¯ Ø´ÛŒÙ¹",
      meta:{op:"Ø¢Ù¾Ø±ÛŒÙ¹Ø±", job:"Ø¢Ø±ÚˆØ±", pos:"Ù¾ÙˆØ²ÛŒØ´Ù†", date:"ØªØ§Ø±ÛŒØ®"},
      th:{time:"ÙˆÙ‚Øª", code:"Ú©ÙˆÚˆ", qty:"ØªØ¹Ø¯Ø§Ø¯"},
      summary:{rows:"Ú©Ù„ Ù„Ø§Ø¦Ù†ÛŒÚº", pieces:"Ú©Ù„ Ù¾ÛŒØ³Ø²"},
      generated:"ØªÛŒØ§Ø± Ú©Ø±Ø¯Û"
    }
  }
};

/* ===== Stato rete (solo badge) ===== */
const netBadge = document.getElementById('netBadge');
function setNetBadge(){
  const lang = getLang();
  const txt = navigator.onLine ? i18n[lang].msg.online : i18n[lang].msg.offline;
  netBadge.textContent = txt;
  netBadge.className = navigator.onLine ? 'online' : 'offline';
}
window.addEventListener('online', setNetBadge);
window.addEventListener('offline', setNetBadge);

/* ===== Helper generali ===== */
const $ = id => document.getElementById(id);
const tabs = Array.from(document.querySelectorAll('.tab'));
const views = { commessa:$('commessa'), scanner:$('scanner'), righe:$('righe'), impostazioni:$('impostazioni') };
function activateTab(name){ tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===name)); Object.entries(views).forEach(([k,el])=> el.classList.toggle('active', k===name)); }
tabs.forEach(t=> t.addEventListener('click', ()=> activateTab(t.dataset.tab)));
$('goScanner').addEventListener('click', ()=> activateTab('scanner'));

/* ===== Lingua ===== */
const LSKEY_LANG = 'poka_lang_v1';
function getLang(){
  return localStorage.getItem(LSKEY_LANG) || 'it';
}
function setLang(l){
  localStorage.setItem(LSKEY_LANG, l);
}
function t(path){
  const parts = path.split('.');
  let cur = i18n[getLang()];
  for(const p of parts){ if(!cur) break; cur = cur[p]; }
  return cur || path;
}
function applyI18n(){
  // elementi con data-i18n
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    const val = t(key);
    if(el.tagName==='INPUT' || el.tagName==='TEXTAREA'){ el.placeholder = val; }
    else el.innerHTML = val;
  });
  // topbar brand
  document.querySelector('.brand').textContent = t('brand');
  // net badge
  setNetBadge();
}
const langSelect = $('langSelect');
const langSelect2 = $('langSelect2');
function initLang(){
  let lang = getLang();
  if(!lang){ // primissimo avvio
    const nav = (navigator.language || 'it').toLowerCase();
    if(nav.startsWith('pt')) lang='pt-BR'; else if(nav.startsWith('en')) lang='en'; else if(nav.startsWith('ur')) lang='ur'; else lang='it';
    setLang(lang);
  }
  langSelect.value = lang; langSelect2.value = lang;
  applyI18n();
}
langSelect.addEventListener('change', e=>{ setLang(e.target.value); langSelect2.value=e.target.value; applyI18n(); });
langSelect2.addEventListener('change', e=>{ setLang(e.target.value); langSelect.value=e.target.value; applyI18n(); });

/* ===== Stato app ===== */
let expected=null, scanned=null, currentMode=null;
let picks=[]; // {ts, codice, qty, commessa, posizione}
let pendingOK=null;
let confirmBuf=[], lastVal=null;
let lastScanTs=0;

/* ===== Impostazioni (localStorage) ===== */
const LSKEY_SETTINGS='poka_settings_v1';
const LSKEY_SESSION_FIELDS='poka_session_fields_v1';
const LSKEY_SNAPSHOT='poka_snapshot_v1';
const settings = { confirm:true, voice:true, vibrate:true };

function loadSettings(){
  try{ Object.assign(settings, JSON.parse(localStorage.getItem(LSKEY_SETTINGS)||'{}')); }catch{}
  $('optConfirm').value = settings.confirm ? 'on':'off';
  $('optVoice').value = settings.voice ? 'on':'off';
  $('optVibrate').value = settings.vibrate ? 'on':'off';
}
function saveSettings(){ localStorage.setItem(LSKEY_SETTINGS, JSON.stringify(settings)); }
$('optConfirm').addEventListener('change', e=>{ settings.confirm=(e.target.value==='on'); saveSettings(); });
$('optVoice').addEventListener('change', e=>{ settings.voice=(e.target.value==='on'); saveSettings(); });
$('optVibrate').addEventListener('change', e=>{ settings.vibrate=(e.target.value==='on'); saveSettings(); });

/* ===== Commessa / posizione / operatore (persist) ===== */
function sanitize(s,max=64){return String(s||'').replace(/[^\w\-\. \/]/g,'').slice(0,max)}
function loadSessionFields(){
  try{
    const s = JSON.parse(localStorage.getItem(LSKEY_SESSION_FIELDS)||'{}');
    $('commessaInput').value = s.commessa||'';
    $('posizioneInput').value = s.posizione||'';
    $('operatoreInput').value = s.operatore||'';
  }catch{}
}
function saveSessionFields(){
  const data = {
    commessa: sanitize($('commessaInput').value,64),
    posizione: sanitize($('posizioneInput').value,64),
    operatore: sanitize($('operatoreInput').value,64)
  };
  localStorage.setItem(LSKEY_SESSION_FIELDS, JSON.stringify(data));
}
['commessaInput','posizioneInput','operatoreInput'].forEach(id=> $(id).addEventListener('change', saveSessionFields));

/* ===== Audio/voce/vibrazione ===== */
let actx;
function tone(f=880,d=120,t='sine',v=.25){try{if(!actx)actx=new (window.AudioContext||window.webkitAudioContext)();const o=actx.createOscillator(),g=actx.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(actx.destination);o.start();setTimeout(()=>o.stop(),d);}catch(e){}}
function okSound(){tone(900,100);setTimeout(()=>tone(1200,110),120)}
function errSound(){tone(250,120,'square',.22);setTimeout(()=>tone(180,140,'square',.20),150)}
function speak(msg){ if(!settings.voice) return; try{ const u=new SpeechSynthesisUtterance(msg); u.lang=langMap[getLang()]||'it-IT'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} }
function vibrate(p){ if(settings.vibrate && navigator.vibrate) navigator.vibrate(p) }
const langMap={ 'it':'it-IT', 'pt-BR':'pt-BR', 'en':'en-US', 'ur':'ur-PK' };

/* ===== UI scanner ===== */
const codesEl = $('codes'), badge=$('badge'), resultText=$('resultText');
function norm(s){return s?String(s).trim().toUpperCase():s}
function codeBox(label,val,cls){
  return `<div class="codeBox ${cls||''}">
    <div class="codeLabel">${label}</div>
    <div class="codeValue ${cls||''}">${val?val:'-'}</div>
  </div>`;
}
function updateUI(){
  const lang = getLang();
  const same = expected && scanned && (norm(expected)===norm(scanned));
  const stateClass = same ? 'ok' : (expected && scanned ? 'err' : '');
  codesEl.innerHTML = codeBox('LISTA', expected||'', same?'ok':'') + codeBox('PEZZO', scanned||'', stateClass);

  if(expected && scanned){
    if(same){
      badge.textContent='âœ… ' + i18n[lang].status.ready; badge.className='badge ok';
      resultText.innerHTML=i18n[lang].status.hint;
      okSound(); speak(i18n[lang].msg.matchOk); vibrate(60);
      pendingOK = expected;
      openQtyModal(pendingOK);
    }else{
      badge.textContent='âŒ'; badge.className='badge err';
      resultText.innerHTML=i18n[lang].msg.matchErr;
      errSound(); speak(i18n[lang].msg.matchErr); vibrate([60,60,180]);
      pendingOK=null;
    }
  }else{
    badge.textContent=i18n[lang].status.ready; badge.className='badge';
    resultText.innerHTML=i18n[lang].status.hint;
  }
}

/* ===== Toast ===== */
const toast=$('toast'); let toastTimer=null;
function showToast(text,kind='ok',ms=1800){
  toast.textContent=text; toast.className=''; toast.classList.add(kind); toast.style.display='block';
  clearTimeout(toastTimer); toastTimer=setTimeout(()=> toast.style.display='none', ms);
}

/* ===== Tab Righe ===== */
function renderRighe(){
  const tb=$('righeBody');
  tb.innerHTML = picks.map((p,idx)=>{
    const hh=p.ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const zebra = (idx%2===0) ? 'style="background:#0f1b35"' : '';
    return `<tr ${zebra}><td>${hh}</td><td>${p.codice}</td><td>${p.qty}</td><td>${p.commessa||'-'}</td><td>${p.posizione||'-'}</td></tr>`;
  }).join('');
  const disabled = picks.length===0;
  $('scaricaCSV').disabled = disabled;
  $('scaricaPDF').disabled = disabled;
  $('svuota').disabled = disabled;
  $('countPill').textContent = String(picks.length);
}
function toCSV(){
  const head='timestamp_ms,iso,codice,quantita,commessa,posizione\n';
  const body=picks.map(p=>{
    return [p.ts.getTime(), p.ts.toISOString(), p.codice, p.qty, p.commessa||'', p.posizione||'']
      .map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
  }).join('\n');
  return head+body;
}
$('scaricaCSV').addEventListener('click', ()=>{
  if(!picks.length) return;
  const csv=toCSV();
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`scheda_picking_${($('commessaInput').value||'commessa')}.csv`; a.click();
  URL.revokeObjectURL(url);
});
$('svuota').addEventListener('click', ()=>{
  if(!picks.length) return;
  if(confirm('Sicuro di svuotare la sessione corrente?')){
    picks=[]; renderRighe(); updateUI(); showToast(t('toast.cleared'),'err',1400);
  }
});

/* ===== Snapshot manuale ===== */
$('saveSession').addEventListener('click', ()=>{
  const snap = {
    when: Date.now(),
    fields:{
      commessa: sanitize($('commessaInput').value,64),
      posizione: sanitize($('posizioneInput').value,64),
      operatore: sanitize($('operatoreInput').value,64)
    },
    picks: picks.map(p=>({ts:p.ts.getTime(), codice:p.codice, qty:p.qty, commessa:p.commessa, posizione:p.posizione}))
  };
  localStorage.setItem(LSKEY_SNAPSHOT, JSON.stringify(snap));
  showToast(t('toast.saved'),'ok',1500);
});
$('loadSession').addEventListener('click', ()=>{
  const raw = localStorage.getItem(LSKEY_SNAPSHOT);
  if(!raw) return;
  try{
    const snap = JSON.parse(raw);
    // ripristino campi
    $('commessaInput').value = snap.fields?.commessa || '';
    $('posizioneInput').value = snap.fields?.posizione || '';
    $('operatoreInput').value = snap.fields?.operatore || '';
    saveSessionFields();
    // ripristino righe
    picks = (snap.picks||[]).map(x=>({ts:new Date(x.ts), codice:x.codice, qty:x.qty, commessa:x.commessa, posizione:x.posizione}));
    renderRighe();
    showToast(t('toast.loaded'),'ok',1500);
  }catch(e){}
});

/* ===== Modale quantitÃ  ===== */
const qtyModal=$('qtyModal'), qtyInput=$('qtyInput'), qtyMinus=$('qtyMinus'), qtyPlus=$('qtyPlus'), qtyOk=$('qtyOk'), qtyCancel=$('qtyCancel'), qtyInfo=$('qtyInfo');
function openQtyModal(code){
  qtyInfo.innerHTML = `${t('table.code')}: <b>${code}</b>`;
  qtyInput.value=''; // campo vuoto di default
  qtyModal.style.display='flex';
  setTimeout(()=>qtyInput.focus(),50);
}
function closeQtyModal(){ qtyModal.style.display='none'; }
qtyMinus.onclick=()=>{ const cur=parseInt(qtyInput.value||'0',10)||0; const v=Math.max(1, cur-1); qtyInput.value=v; };
qtyPlus.onclick =()=>{ const cur=parseInt(qtyInput.value||'0',10)||0; const v=Math.max(1, cur+1); qtyInput.value=v; };
qtyCancel.onclick=()=>{ closeQtyModal(); };
qtyOk.onclick=()=>{
  const lang=getLang();
  const val = parseInt(qtyInput.value||'0',10);
  if(!(val>0)){ alert(i18n[lang].msg.qtyRequired); return; }
  if(!pendingOK){ closeQtyModal(); return; }
  const ts=new Date();
  const cm=sanitize($('commessaInput').value,64), ps=sanitize($('posizioneInput').value,64);
  picks.push({ts, codice: sanitize(pendingOK,128), qty:val, commessa:cm, posizione:ps});
  renderRighe(); showToast(t('toast.rowAdded'),'ok',1400);
  pendingOK=null; scanned=null; updateUI(); closeQtyModal();
};

/* ===== Reset ===== */
$('reset').addEventListener('click', ()=>{ expected=null; scanned=null; pendingOK=null; updateUI(); });

/* ===== Camera fullscreen (BarcodeDetector â‡’ ZXing) ===== */
const camFS=$('camFS'), camClose=$('camClose'), video=$('video'), overlay=$('overlay'), guide=$('guide'), laser=$('laser');
let stream=null, track=null;

camClose.addEventListener('click', stopCameraFS);
$('scanList').addEventListener('click', ()=>startScanFS('list'));
$('scanItem').addEventListener('click', ()=>startScanFS('item'));

function canAccept(){
  const now=performance.now();
  if(now-lastScanTs<600) return false;
  lastScanTs=now; return true;
}

async function startScanFS(which){
  activateTab('scanner');
  saveSessionFields(); // salva campi
  const lang=getLang();
  const cm=sanitize($('commessaInput').value,64), ps=sanitize($('posizioneInput').value,64);
  if(!cm || !ps){ alert(i18n[lang].msg.needFields); return; }

  currentMode=which;
  camFS.classList.add('active');
  try{ await startDetectorHybrid(); }
  catch(e){ await startZXingHybrid(); }
}

function stopCameraFS(){
  try{
    if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
    if(track) track.stop();
  }catch(e){}
  stream=null; track=null; camFS.classList.remove('active');
}

async function startDetectorHybrid(){
  const constraints={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720},focusMode:"continuous"}};
  const chosen=$('cameraSelect').value; if(chosen) constraints.video.deviceId={exact:chosen};

  stream=await navigator.mediaDevices.getUserMedia(constraints);
  track=stream.getVideoTracks()[0]; video.srcObject=stream; await video.play();

  const detector=new BarcodeDetector({formats:['qr_code','code_128','ean_13','ean_8','upc_a','code_39']});
  const ctx=overlay.getContext('2d');

  const loop=()=>{
    if(!stream){return;}
    if(video.readyState<2){ requestAnimationFrame(loop); return; }
    overlay.width=video.videoWidth; overlay.height=video.videoHeight; ctx.clearRect(0,0,overlay.width,overlay.height);

    detector.detect(video).then(codes=>{
      const g=guide.getBoundingClientRect(), v=video.getBoundingClientRect();
      const gx=g.left-v.left, gy=g.top-v.top, gw=g.width, gh=g.height;
      const sx=overlay.width/v.width, sy=overlay.height/v.height;

      let accepted=null;
      for(const c of codes){
        const r=c.boundingBox; const cx=r.x+r.width/2, cy=r.y+r.height/2;
        const domX=cx/sx, domY=cy/sy;
        const inGuide=(domX>=gx&&domX<=gx+gw&&domY>=gy&&domY<=gy+gh);
        const g2=laser.getBoundingClientRect();
        const lx=g2.left-v.left+g2.width/2, ly=g2.top-v.top+g2.height/2;
        const dist=Math.sqrt((domX-lx)**2+(domY-ly)**2);
        const radius=g2.width/2;
        if(inGuide && dist<radius){ accepted=c.rawValue; break; }
      }

      if(accepted && canAccept()){
        if(settings.confirm){
          if(lastVal===accepted){ confirmBuf.push(accepted); } else { confirmBuf=[accepted]; lastVal=accepted; }
          if(confirmBuf.length>=2){ processScan(accepted); return; }
        } else { processScan(accepted); return; }
      }
      requestAnimationFrame(loop);
    }).catch(()=>requestAnimationFrame(loop));
  };
  loop();
}

async function startZXingHybrid(){
  const constraints={video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}}};
  const chosen=$('cameraSelect').value; if(chosen) constraints.video.deviceId={ exact: chosen };

  stream=await navigator.mediaDevices.getUserMedia(constraints);
  track=stream.getVideoTracks()[0];

  const formats=[ZXing.BarcodeFormat.QR_CODE,ZXing.BarcodeFormat.CODE_128,ZXing.BarcodeFormat.EAN_13,ZXing.BarcodeFormat.UPC_A,ZXing.BarcodeFormat.CODE_39];
  const hints=new Map(); hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,formats);
  const reader=new ZXing.BrowserMultiFormatReader(hints);

  video.srcObject=stream; await video.play();

  const loop=async()=>{
    try{
      const res=await reader.decodeFromVideoDevice(null, video);
      if(res && canAccept()){ if(pointInGuideZXing(res,video)){ processScan(res.text); return; } }
    }catch(e){}
    requestAnimationFrame(loop);
  };
  loop();
}
function pointInGuideZXing(result,vidEl){
  try{
    const pts=result.resultPoints||[]; if(pts.length===0) return true;
    let cx=0,cy=0; for(const p of pts){ cx+=p.x; cy+=p.y; } cx/=pts.length; cy/=pts.length;

    const vrect=vidEl.getBoundingClientRect();
    const vw=vidEl.videoWidth, vh=vidEl.videoHeight;
    const scale=Math.min(vrect.width/vw, vrect.height/vh);
    const dispW=vw*scale, dispH=vh*scale;
    const offX=(vrect.width-dispW)/2, offY=(vrect.height-dispH)/2;

    const domX=offX+cx*scale, domY=offY+cy*scale;
    const g2=laser.getBoundingClientRect();
    const lx=g2.left-vrect.left+g2.width/2, ly=g2.top-vrect.top+g2.height/2;
    const dist=Math.sqrt((domX-lx)**2+(domY-ly)**2);
    return (dist < g2.width/2);
  }catch(e){ return true; }
}

/* Gestione lettura singola */
function processScan(text){
  const val = sanitize(text,128);
  if(currentMode==='list'){ expected=val; } else { scanned=val; }
  stopCameraFS(); // chiudiamo camera ma restiamo nella tab Scanner
  updateUI();
}

/* ===== Camera select ===== */
async function populateCameras(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const vids = devices.filter(d=>d.kind==='videoinput');
    $('cameraSelect').innerHTML = '<option value="">(automatica)</option>' +
      vids.map(v=>`<option value="${v.deviceId}">${v.label||'Fotocamera'}</option>`).join('');
  }catch(_){}
}

/* ===== PDF (alto contrasto) ===== */
$('scaricaPDF').addEventListener('click', ()=>{
  if(!picks.length) return;
  const lang=getLang();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'mm', format:'a4', compress:true});
  const W=210, L=297, margin=12;

  // Header barra scura
  doc.setFillColor(11,19,37); // #0B1325
  doc.rect(0,0,W,20,'F');
  doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255); doc.setFontSize(16);
  doc.text(t('pdf.title'), margin, 13);

  // Metadati su fondo bianco, testo nero
  doc.setTextColor(0,0,0);
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  let y = 28;
  const meta = [
    [t('pdf.meta.op'), $('operatoreInput').value || '-'],
    [t('pdf.meta.job'), $('commessaInput').value || '-'],
    [t('pdf.meta.pos'), $('posizioneInput').value || '-'],
    [t('pdf.meta.date'), new Date().toLocaleString()]
  ];
  // Disegna etichette bold e valori
  meta.forEach(([k,v],i)=>{
    doc.setFont('helvetica','bold'); doc.text(`${k}:`, margin, y);
    doc.setFont('helvetica','normal'); doc.text(String(v), margin+33, y);
    y += 7;
  });
  // separatore
  doc.setDrawColor(176,183,195); // #B0B7C3
  doc.line(margin, y, W-margin, y); y += 6;

  // Tabella header scuro
  const thH=9, rowH=8;
  const cols = [
    { key:'time', label:t('pdf.th.time'), w:28 },
    { key:'code', label:t('pdf.th.code'), w:110 },
    { key:'qty',  label:t('pdf.th.qty'),  w:28 }
  ];
  function drawHeader(yh){
    doc.setFillColor(15,27,53); // #0f1b35
    doc.setTextColor(255,255,255);
    doc.rect(margin,yh, cols.reduce((a,c)=>a+c.w,0), thH, 'F');
    doc.setFont('helvetica','bold'); doc.setFontSize(11);
    let x=margin+3;
    cols.forEach(c=>{ doc.text(c.label, x, yh+6); x+=c.w; });
  }
  drawHeader(y); y += thH;

  // Righe con zebratura
  doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(0,0,0);
  let zebra = false, totalQty=0;
  for(let i=0;i<picks.length;i++){
    const p=picks[i];
    const hh=p.ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const vals=[hh, p.codice, String(p.qty)];
    const rowW = cols.reduce((a,c)=>a+c.w,0);
    if(zebra){ doc.setFillColor(242,244,248); doc.rect(margin,y,rowW,rowH,'F'); } // #F2F4F8
    // contenuto
    let x=margin+3;
    vals.forEach((v,idx)=>{
      if(idx===1){
        // codice: gestione testo lungo
        const wMax = cols[1].w - 4;
        const lines = doc.splitTextToSize(v, wMax);
        // multi-line: se piÃ¹ di 1 riga, aumentiamo dinamicamente l'altezza riga
        if(lines.length>1){
          // ridisegna fondo per tutta l'altezza
          const extraH = (lines.length-1)*5;
          if(zebra){ doc.setFillColor(242,244,248); doc.rect(margin,y,rowW,rowH+extraH,'F'); }
          // stampa tutte le linee
          for(let li=0;li<lines.length;li++){
            doc.text(lines[li], x, y+5+(li*5));
          }
          // time e qty verticalmente centrati sulla prima riga
          doc.text(vals[0], margin+3, y+5);
          doc.text(vals[2], margin+3+cols[0].w+cols[1].w, y+5);
          y += rowH + extraH;
        }else{
          // singola riga
          doc.text(vals[0], margin+3, y+5);
          doc.text(v, x, y+5);
          doc.text(vals[2], margin+3+cols[0].w+cols[1].w, y+5);
          y += rowH;
        }
      }else{
        // handled above to keep alignment
      }
    });
    totalQty += p.qty;
    // nuova pagina se oltre
    if(y > L-30){
      doc.addPage(); y = 20;
      drawHeader(y); y += thH;
      zebra=false;
    }else{
      zebra = !zebra;
    }
  }

  // separatore
  doc.setDrawColor(176,183,195); doc.line(margin, y, W-margin, y); y += 6;

  // Sommarietto
  doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.setTextColor(0,0,0);
  doc.text(`${t('pdf.summary.rows')}: ${picks.length}`, margin, y); y+=6;
  doc.text(`${t('pdf.summary.pieces')}: ${totalQty}`, margin, y); y+=10;

  // Footer
  doc.setFont('helvetica','normal'); doc.setFontSize(9);
  doc.text(`${t('pdf.generated')}: ${new Date().toLocaleString()}`, margin, L-10);

  const filename = `scheda_picking_${($('commessaInput').value||'commessa')}_${($('operatoreInput').value||'op')}.pdf`;
  doc.save(filename);
});

/* ===== Download CSV attiva/disattiva anche da UI ===== */
$('scaricaPDF').disabled = true;

/* ===== Avvio ===== */
initLang();
loadSettings();
loadSessionFields();
applyI18n();
updateUI();
renderRighe();
setNetBadge();
if(navigator.mediaDevices?.enumerateDevices){ populateCameras(); }
</script>
</body>
</html>