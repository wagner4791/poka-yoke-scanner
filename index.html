<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Poka-Yoke PRO ‚Ä¢ Scanner IBRIDO (QR + Barcode)</title>
<style>
  :root{--ok:#16a34a;--err:#dc2626;--panel:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--ink:#e5e7eb;--line:#1f2937}
  html,body{margin:0;height:100%;background:#000;color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{min-height:100%;display:flex;flex-direction:column}
  header{padding:10px 12px;background:#0a0f1d;border-bottom:1px solid var(--line)}
  .topbar{display:flex;align-items:center;gap:10px}
  .brand{font-weight:800}
  .tabs{display:flex;gap:6px;margin-left:8px}
  .tab{padding:8px 10px;border:1px solid #334155;background:#0b1220;border-radius:10px;cursor:pointer;font-weight:700}
  .tab.active{background:#111827}
  .spacer{flex:1}
  .gear{border:1px solid #334155;background:#0b1220;border-radius:10px;padding:8px 10px;cursor:pointer}
  main{flex:1;padding:12px;display:flex;flex-direction:column;gap:12px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .input,select{background:#0b1220;border:1px solid #243045;border-radius:10px;color:var(--fg);padding:10px 12px;font-size:16px;flex:1 1 180px}
  .input::placeholder{color:#64748b}
  label.field{display:flex;flex-direction:column;gap:6px;flex:1 1 220px;min-width:200px}
  label.field span{font-size:12px;color:#9ca3af}
  .btn{flex:1 1 150px;padding:12px 14px;border-radius:12px;border:1px solid #243045;background:#111827;color:#fff;font-size:16px;font-weight:800;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .btn-blue{background:#1e293b;border-color:#334155}
  .btn-green{background:#14532d;border-color:#14532d}
  .btn-ghost{background:#0b1220;border-color:#334155}
  .small{font-size:12px;color:#9ca3af}
  /* status */
  .status{display:flex;flex-direction:column;gap:6px;align-items:center;text-align:center}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;border:1px solid #374151}
  .badge.ok{background:rgba(22,163,74,.15);color:#86efac;border-color:#14532d}
  .badge.err{background:rgba(220,38,38,.15);color:#fecaca;border-color:#7f1d1d}
  #resultText{font-size:20px;margin:4px 0 2px}
  #codes{display:flex;flex-direction:column;gap:10px;width:100%;max-width:700px}
  .codeBox{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-radius:12px;border:1px solid #334155;background:#0b1220}
  .codeLabel{font-size:14px;color:#9ca3af;font-weight:800}
  .codeValue{flex:1;text-align:right;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-weight:900;letter-spacing:.5px;font-size:clamp(22px,3.6vh,40px);color:#e5e7eb;word-break:break-all}
  .codeBox.ok{border-color:#14532d;background:rgba(22,163,74,.10)}
  .codeBox.err{border-color:#7f1d1d;background:rgba(220,38,38,.08)}
  .codeValue.ok{color:#86efac}.codeValue.err{color:#fecaca}
  #statusLine{font-size:12px;color:#cbd5e1;text-align:center;margin-top:6px;min-height:1em}
  /* camera */
  #cameraPanel{display:none}
  #fsCam{position:fixed;inset:0;display:none;background:#000;z-index:9999}
  #preview{position:relative;width:100%;height:100%}
  #video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  #overlay{position:absolute;inset:0;pointer-events:none}
  #guide{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(60vmin,60%);height:min(60vmin,60%);border:3px solid rgba(255,255,255,.95);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,.4) inset;pointer-events:none}
  #laser{position:absolute;left:50%;top:50%;width:56px;height:56px;border:2px solid rgba(255,60,60,.9);border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 14px rgba(255,60,60,.85);pointer-events:none}
  .fsTop{position:absolute;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;align-items:center;gap:8px;z-index:2}
  .fsBtn{background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.2);color:#fff;border-radius:10px;padding:8px 12px;font-weight:800}
  #flash{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .18s}
  /* table */
  #righeBox{max-height:54vh;overflow:auto;border:1px solid var(--line);border-radius:10px}
  .tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{padding:10px;border-bottom:1px solid var(--line);font-size:14px}
  .tbl th{position:sticky;top:0;background:#0a0f1d;text-align:left;font-weight:900}
  /* pin gate */
  #pinGate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.85);z-index:10000}
  .pinCard{background:#0b1220;border:1px solid #334155;border-radius:16px;padding:18px;min-width:300px;max-width:92vw;box-shadow:0 10px 30px rgba(0,0,0,.6);display:flex;flex-direction:column;gap:10px}
  .pinTitle{font-weight:900}
  .pinInput{font-size:22px;letter-spacing:4px;text-align:center;padding:10px;border-radius:10px;border:1px solid #334155;background:#0a0f1d;color:#fff}
  .pinGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:6px}
  .pinBtn{padding:14px 0;border-radius:12px;border:1px solid #334155;background:#111827;color:#fff;font-weight:800;font-size:18px}
  .pinRow{display:flex;gap:8px;justify-content:center}
  .pinMsg{min-height:1em;font-size:12px;color:#cbd5e1;text-align:center}
  .cooldown{color:#fecaca}
  /* settings drawer */
  #settings{position:fixed;right:10px;top:56px;width:min(92vw,380px);background:#0b1220;border:1px solid #334155;border-radius:14px;padding:14px;display:none;z-index:9000}
  .setRow{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #253046}
  .setRow:last-child{border-bottom:none}
  .switch{appearance:none;width:42px;height:24px;border-radius:999px;background:#253046;position:relative;outline:none;cursor:pointer}
  .switch:checked{background:#14532d}
  .switch::after{content:"";position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:transform .18s}
  .switch:checked::after{transform:translateX(18px)}
  footer{padding:10px 12px;color:#94a3b8;font-size:12px;text-align:center;border-top:1px solid var(--line)}
  .hidden{display:none!important}
</style>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>
</head>
<body>
<!-- ===== PIN GATE + LICENZA ===== -->
<div id="pinGate">
  <div class="pinCard">
    <div class="pinTitle">üîí Accesso protetto</div>
    <input id="pinInput" class="pinInput" type="password" inputmode="numeric" autocomplete="one-time-code" placeholder="PIN" maxlength="8"/>
    <div class="pinGrid">
      <button class="pinBtn">1</button><button class="pinBtn">2</button><button class="pinBtn">3</button>
      <button class="pinBtn">4</button><button class="pinBtn">5</button><button class="pinBtn">6</button>
      <button class="pinBtn">7</button><button class="pinBtn">8</button><button class="pinBtn">9</button>
    </div>
    <div class="pinRow">
      <button id="pinClear" class="pinBtn" style="flex:1">Cancella</button>
      <button class="pinBtn" style="flex:1">0</button>
      <button id="pinOk" class="pinBtn btn-green" style="flex:1">OK</button>
    </div>
    <div id="pinMsg" class="pinMsg"></div>
  </div>
</div>

<div class="wrap" aria-hidden="true">
  <header>
    <div class="topbar">
      <div class="brand">Poka-Yoke PRO</div>
      <div class="tabs">
        <button class="tab active" data-tab="commessa">Commessa</button>
        <button class="tab" data-tab="scanner">Scanner</button>
        <button class="tab" data-tab="righe">Righe raccolte</button>
      </div>
      <div class="spacer"></div>
      <button id="btnGear" class="gear">‚öôÔ∏è</button>
    </div>
  </header>

  <!-- ===== SEZIONE COMMESSA ===== -->
  <section id="tab-commessa">
    <div class="panel">
      <div class="row">
        <label class="field">
          <span>Numero commessa</span>
          <input id="commessa" class="input" placeholder="Es. 024830" autocomplete="off"/>
        </label>
        <label class="field">
          <span>Posizione</span>
          <input id="posizione" class="input" placeholder="Es. POS 0020" autocomplete="off"/>
        </label>
        <label class="field" style="min-width:200px;flex:1 1 260px">
          <span>Fotocamera</span>
          <select id="cameraSelect" class="input"><option value="">(automatica)</option></select>
        </label>
      </div>
      <div class="small" style="margin-top:6px">Compila <b>commessa</b> e <b>posizione</b> prima di scansionare.</div>
    </div>
  </section>

  <!-- ===== SEZIONE SCANNER ===== -->
  <section id="tab-scanner" class="hidden">
    <div class="panel status">
      <div id="badge" class="badge">Pronto</div>
      <div id="resultText">Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b></div>
      <div id="codes"></div>
      <div class="small">Allinea il codice nel <b>quadrato</b> e centra nel cerchio rosso üî¥.</div>
    </div>

    <div class="panel">
      <div class="row">
        <button id="scanList" class="btn btn-blue">üìã LISTA</button>
        <button id="scanItem" class="btn btn-blue">üì¶ PEZZO</button>
        <button id="reset" class="btn btn-ghost">üîÑ Reset</button>
      </div>
      <div id="statusLine" class="small"></div>
    </div>
  </section>

  <!-- ===== SEZIONE RIGHE ===== -->
  <section id="tab-righe" class="hidden">
    <div class="panel">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="small">Righe raccolte (scheda in tempo reale)</div>
        <div class="row" style="gap:8px;flex:0 0 auto">
          <button id="scaricaCSV" class="btn btn-blue" disabled>‚¨áÔ∏è Scarica CSV</button>
          <button id="svuota" class="btn btn-ghost" disabled>üóëÔ∏è Svuota</button>
        </div>
      </div>
      <div id="righeBox" style="margin-top:8px">
        <table class="tbl" id="righeTbl">
          <thead><tr><th>Ora</th><th>Codice</th><th>Q.t√†</th><th>Commessa</th><th>Posizione</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="small" style="margin-top:6px;color:#9ca3af">Dati salvati localmente sul dispositivo. Nessun invio in rete.</div>
    </div>
  </section>

  <footer>Modalit√† locale ‚Ä¢ Aggiungi alla Home per esperienza tipo app</footer>
</div>

<!-- ===== SETTINGS DRAWER ===== -->
<div id="settings">
  <div class="setRow"><div>Conferma doppia</div><input id="setConfirm" type="checkbox" class="switch"></div>
  <div class="setRow"><div>Annuncio vocale</div><input id="setVoice" type="checkbox" class="switch"></div>
  <div class="setRow"><button id="resetDefaults" class="btn btn-ghost" style="width:100%">Ripristina predefiniti</button></div>
</div>

<!-- ===== FULLSCREEN CAMERA LAYER ===== -->
<div id="fsCam">
  <div class="fsTop">
    <button id="fsClose" class="fsBtn">‚úï Chiudi</button>
    <div class="small" id="fsHint">Inquadra e centra nel cerchio rosso</div>
  </div>
  <div id="preview">
    <video id="video" muted playsinline></video>
    <canvas id="overlay"></canvas>
    <div id="guide"></div>
    <div id="laser"></div>
  </div>
</div>

<div id="flash"></div>

<script>
/* ====== SICUREZZA: PIN + LICENZA + NO TIME TRAVEL ====== */
const PIN_MODE = 'fixed';
const PIN_HASH = 'srLxBNMsY4kD4VGpsg1uJ7QdjAyEz4RYc4+Dyi8d10Q='; // sha256 base64 di "2025"
const LICENSE_EXPIRY = '2027-01-01'; // ISO yyyy-mm-dd
const NO_BACK_KEY='py_no_back_epoch'; // anti time-travel

const pinGate = document.getElementById('pinGate');
const pinInput = document.getElementById('pinInput');
const pinMsg = document.getElementById('pinMsg');
const pinButtons = Array.from(document.querySelectorAll('.pinBtn'));
const pinClear = document.getElementById('pinClear');
const pinOk = document.getElementById('pinOk');
let pinAttempts = 0, pinLockedUntil = 0;

function lockApp(msg){ document.querySelector('.wrap').setAttribute('aria-hidden','true'); pinGate.style.display='flex'; pinMsg.textContent=msg||''; pinInput.value=''; }
function unlockApp(){ pinGate.style.display='none'; document.querySelector('.wrap').removeAttribute('aria-hidden'); pinMsg.textContent=''; pinAttempts=0; pinLockedUntil=0; }

function licExpired(){
  const today = new Date(); today.setHours(0,0,0,0);
  const exp = new Date(LICENSE_EXPIRY+'T00:00:00'); exp.setHours(0,0,0,0);
  return (today > exp);
}
function noTimeTravelViolated(){
  const now = Date.now();
  const last = Number(localStorage.getItem(NO_BACK_KEY)||'0');
  if(last && now + 5*60*1000 < last){ // tolleranza 5 minuti
    return true;
  }
  localStorage.setItem(NO_BACK_KEY, String(now));
  return false;
}
async function sha256B64(str){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
  let bin=''; new Uint8Array(buf).forEach(b=>bin+=String.fromCharCode(b));
  return btoa(bin);
}
pinButtons.forEach(b=>{
  if(b.id==='pinOk'||b.id==='pinClear') return;
  b.addEventListener('click',()=> pinInput.value = (pinInput.value||'') + b.textContent.trim());
});
pinClear.addEventListener('click',()=> pinInput.value='');
pinOk.addEventListener('click', async ()=>{
  const now = Date.now();
  if(now < pinLockedUntil){
    const left = Math.ceil((pinLockedUntil-now)/1000);
    pinMsg.textContent = `‚è≥ Attendi ${left}s`; pinMsg.classList.add('cooldown'); return;
  }
  pinMsg.classList.remove('cooldown');

  if(licExpired()){ pinMsg.textContent='üîë Licenza scaduta. Contatta il fornitore.'; return; }
  if(noTimeTravelViolated()){ pinMsg.textContent='üõë Data dispositivo non valida (spostata indietro).'; return; }

  const entered=(pinInput.value||'').trim();
  if(!entered){ pinMsg.textContent='Inserisci il PIN'; return; }
  const h = await sha256B64(entered);
  if(h===PIN_HASH){ unlockApp(); }
  else{
    pinAttempts++;
    if(pinAttempts>=5){ pinLockedUntil=Date.now()+60*1000; pinMsg.textContent='Troppi tentativi. Attendi 60s.'; pinAttempts=0; }
    else{ pinMsg.textContent=`PIN errato. Tentativi: ${pinAttempts}/5`; }
    pinInput.value='';
  }
});
/* Avvio bloccato */
lockApp( licExpired() ? 'üîë Licenza scaduta. Contatta il fornitore.' : '' );

/* ====== IMPOSTAZIONI (localStorage) ====== */
const settingsEl = document.getElementById('settings');
document.getElementById('btnGear').onclick=()=>{ settingsEl.style.display = (settingsEl.style.display==='block'?'none':'block'); };
document.addEventListener('click',(e)=>{
  if(!settingsEl.contains(e.target) && e.target.id!=='btnGear'){ settingsEl.style.display='none'; }
});
const SKEY='py_settings_v1';
const setConfirm=document.getElementById('setConfirm');
const setVoice=document.getElementById('setVoice');

function loadSettings(){
  try{
    const s = JSON.parse(localStorage.getItem(SKEY)||'{}');
    setConfirm.checked = s.confirm ?? true;
    setVoice.checked   = s.voice ?? true;
  }catch(_){ setConfirm.checked=true; setVoice.checked=true; }
}
function saveSettings(){
  const s = { confirm: !!setConfirm.checked, voice: !!setVoice.checked };
  localStorage.setItem(SKEY, JSON.stringify(s));
}
setConfirm.onchange=saveSettings; setVoice.onchange=saveSettings;
document.getElementById('resetDefaults').onclick=()=>{
  setConfirm.checked=true; setVoice.checked=true; saveSettings();
};
loadSettings();

/* ====== CORE APP ====== */
document.addEventListener('click',()=>{ speechSynthesis.getVoices(); },{once:true});

let expected=null, scanned=null, mode=null, stream, track, confirmBuf=[], lastVal=null;
let picks=[]; // {ts, codice, qty, commessa, posizione}
let lastScanTs=0;

/* helpers */
const $=id=>document.getElementById(id);
function norm(s){return s?String(s).trim().toUpperCase():s}
function sanitize(s,max=64){return String(s||'').replace(/[^\w\-\. \/]/g,'').slice(0,max)}
function vibrate(p){ if(navigator.vibrate) navigator.vibrate(p); }
let actx;
function tone(f=880,d=150,t='sine',v=.25){try{if(!actx)actx=new (window.AudioContext||window.webkitAudioContext)();const o=actx.createOscillator(),g=actx.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(actx.destination);o.start();setTimeout(()=>o.stop(),d);}catch(e){}}
function okSound(){tone(900,120);setTimeout(()=>tone(1200,140),130)}
function errSound(){tone(250,240,'square',.22);setTimeout(()=>tone(180,250,'square',.20),220)}
function speak(msg,rate=1,pitch=1,vol=1){ if(!setVoice.checked) return; try{const u=new SpeechSynthesisUtterance(msg);u.lang='it-IT';u.volume=vol;u.rate=rate;u.pitch=pitch;const v=speechSynthesis.getVoices().find(x=>x.lang.startsWith('it'));if(v)u.voice=v; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} }
function flashScreen(c){ const f=$('flash'); f.style.background=c; f.style.opacity=.6; setTimeout(()=>f.style.opacity=0,160); }
function status(m){ $('statusLine').textContent = m||''; }

/* Tabs */
const tabs = Array.from(document.querySelectorAll('.tab'));
const sections = { commessa:$('tab-commessa'), scanner:$('tab-scanner'), righe:$('tab-righe') };
tabs.forEach(t=>t.addEventListener('click',()=>{
  tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
  const k = t.dataset.tab;
  Object.entries(sections).forEach(([id,el])=> el.classList.toggle('hidden', id!==k));
}));

/* UI codici */
function updateUI(){
  const codes=$('codes'), badge=$('badge'), result=$('resultText');
  const same = expected && scanned && (norm(expected)===norm(scanned));
  const stateClass = same ? 'ok' : (expected && scanned ? 'err' : '');
  const box = (label,val,cls)=>`
    <div class="codeBox ${cls||''}">
      <div class="codeLabel">${label}</div>
      <div class="codeValue ${cls||''}">${val?val:'-'}</div>
    </div>`;
  codes.innerHTML = box('LISTA', expected||'', same?'ok':'') + box('PEZZO', scanned||'', stateClass);
  if(expected && scanned){
    if(same){
      badge.textContent='‚úÖ CORRETTO'; badge.className='badge ok';
      result.innerHTML='Match perfetto!'; flashScreen('rgba(22,163,74,.5)'); okSound(); speak('Codice corretto',1,1.1,1); vibrate(60);
      openQtyModal(expected);
    }else{
      badge.textContent='‚ùå ERRATO'; badge.className='badge err';
      result.innerHTML='Codice diverso!'; flashScreen('rgba(220,38,38,.55)'); errSound(); speak('Errore, codice diverso',0.95,0.9,1); vibrate([60,60,180]);
    }
  }else{
    badge.textContent='Pronto'; badge.className='badge';
    result.innerHTML='Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b>';
  }
}

/* Quantit√† (prompt semplice per leggerezza) */
function openQtyModal(code){
  const qty = Math.max(1, parseInt(prompt(`Quantit√† per ${code}`, '1')||'1',10));
  const ts = new Date();
  picks.push({ ts, codice:sanitize(code,128), qty, commessa:sanitize($('commessa').value,64), posizione:sanitize($('posizione').value,64) });
  renderPicks();
  scanned=null; expected=null; updateUI();
  // passa automaticamente alla tab RIGHE per conferma
  document.querySelector('.tab[data-tab="righe"]').click();
}

/* Righe tabella */
function renderPicks(){
  const tb = document.querySelector('#righeTbl tbody');
  tb.innerHTML = picks.map(p=>{
    const hh = p.ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    return `<tr><td>${hh}</td><td>${p.codice}</td><td>${p.qty}</td><td>${p.commessa||'-'}</td><td>${p.posizione||'-'}</td></tr>`;
  }).join('');
  $('scaricaCSV').disabled = picks.length===0;
  $('svuota').disabled = picks.length===0;
}

/* CSV */
function toCSV(){
  const head='timestamp_ms,iso,codice,quantita,commessa,posizione\n';
  const body=picks.map(p=>[p.ts.getTime(),p.ts.toISOString(),p.codice,p.qty,p.commessa||'',p.posizione||''].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  return head+body;
}
function downloadCSV(){
  if(!picks.length) return;
  const blob=new Blob([toCSV()],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download=`scheda_picking_${($('commessa').value||'commessa')}.csv`; a.click(); URL.revokeObjectURL(url);
}

/* Pulsanti base */
$('scanList').onclick=()=>startScan('list');
$('scanItem').onclick=()=>startScan('item');
$('reset').onclick = ()=>{ expected=null; scanned=null; updateUI(); };
$('scaricaCSV').onclick = downloadCSV;
$('svuota').onclick = ()=>{ if(!picks.length) return; if(!confirm('Sicuro di svuotare la scheda?')) return; picks=[]; renderPicks(); };

/* Camera list */
async function populateCameras(){
  try{
    const devs = await navigator.mediaDevices.enumerateDevices();
    const vids = devs.filter(d=>d.kind==='videoinput');
    $('cameraSelect').innerHTML = '<option value="">(automatica)</option>' + vids.map(v=>`<option value="${v.deviceId}">${v.label||'Fotocamera'}</option>`).join('');
  }catch(_){}
}
if(navigator.mediaDevices?.enumerateDevices){ populateCameras(); }

/* ===== FULLSCREEN SCAN ===== */
const fsCam = $('fsCam'), video=$('video'), overlay=$('overlay'), guide=$('guide'), laser=$('laser');
$('fsClose').onclick = ()=> stopStream();

async function enterFullscreen(){
  fsCam.style.display='block';
  if (fsCam.requestFullscreen) { try{ await fsCam.requestFullscreen(); }catch(_){/* fallback css already visible */} }
}
async function exitFullscreen(){
  if (document.fullscreenElement) { try{ await document.exitFullscreen(); }catch(_){} }
  fsCam.style.display='none';
}
function stopStream(){
  try{ if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; } }catch(_){}
  exitFullscreen();
  status('');
}
function canAccept(){
  const now = performance.now();
  if(now - lastScanTs < 600) return false;
  lastScanTs = now; return true;
}

async function startScan(which){
  const cm=sanitize($('commessa').value,64), ps=sanitize($('posizione').value,64);
  if(!cm||!ps){ alert('Inserisci Numero commessa e Posizione prima di scansionare.'); return; }
  $('commessa').value=cm; $('posizione').value=ps;
  mode=which; await enterFullscreen(); await runDetector();
}

async function runDetector(){
  status('Avvio camera‚Ä¶');
  const c={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720},focusMode:"continuous"}};
  const chosen=$('cameraSelect').value; if(chosen) c.video.deviceId={exact:chosen};
  const stream=await navigator.mediaDevices.getUserMedia(c).catch(()=>null);
  if(!stream){ alert('Fotocamera non disponibile o permesso negato.'); stopStream(); return; }
  video.srcObject=stream; await video.play();

  const useNative = ('BarcodeDetector' in window);
  if(useNative){
    const detector=new BarcodeDetector({formats:['qr_code','code_128','ean_13','ean_8','upc_a','code_39']});
    const ctx=overlay.getContext('2d');

    const loop=()=>{
      if(!video.srcObject){ return; }
      if(video.readyState<2){ requestAnimationFrame(loop); return; }
      overlay.width=video.videoWidth; overlay.height=video.videoHeight; ctx.clearRect(0,0,overlay.width,overlay.height);
      detector.detect(video).then(list=>{
        const g=guide.getBoundingClientRect(), v=video.getBoundingClientRect();
        const gx=g.left-v.left, gy=g.top-v.top, gw=g.width, gh=g.height;
        const sx=overlay.width/v.width, sy=overlay.height/v.height;
        let accepted=null;
        for(const c of list){
          const r=c.boundingBox; const cx=r.x+r.width/2, cy=r.y+r.height/2;
          const domX=cx/sx, domY=cy/sy;
          const inGuide=(domX>=gx&&domX<=gx+gw&&domY>=gy&&domY<=gy+gh);
          const g2=laser.getBoundingClientRect();
          const lx=g2.left-v.left+g2.width/2, ly=g2.top-v.top+g2.height/2;
          const dist=Math.sqrt((domX-lx)**2+(domY-ly)**2);
          if(inGuide && dist<g2.width/2){ accepted=c.rawValue; break; }
        }
        if(accepted && canAccept()){
          if(setConfirm.checked){
            if(lastVal===accepted) confirmBuf.push(accepted); else { confirmBuf=[accepted]; lastVal=accepted; }
            if(confirmBuf.length>=2){ onScan(accepted); return; }
          }else{ onScan(accepted); return; }
        }
        requestAnimationFrame(loop);
      }).catch(()=>requestAnimationFrame(loop));
    };
    loop();
  }else{
    // ZXing fallback
    const hints=new Map();
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,[ZXing.BarcodeFormat.QR_CODE,ZXing.BarcodeFormat.CODE_128,ZXing.BarcodeFormat.EAN_13,ZXing.BarcodeFormat.UPC_A,ZXing.BarcodeFormat.CODE_39]);
    const reader=new ZXing.BrowserMultiFormatReader(hints);
    const loop=async()=>{
      try{
        const res=await reader.decodeFromVideoElement(video);
        if(res && canAccept()){ onScan(res.text); return; }
      }catch(_){}
      requestAnimationFrame(loop);
    };
    loop();
  }
}

function onScan(text){
  const val=sanitize(text,128);
  if(mode==='list') expected=val; else scanned=val;
  stopStream();
  // Torna alla tab Scanner per feedback, poi UI decide
  document.querySelector('.tab[data-tab="scanner"]').click();
  updateUI();
}

/* ===== INIT ===== */
updateUI();
</script>
</body>
</html>
```Ó®Å0Ó®Ç