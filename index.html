<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Poka-Yoke PRO ‚Ä¢ Scanner IBRIDO</title>

<!-- ZXing fallback -->
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>

<style>
:root{
  --bg:#000; --panel:#0f172a; --panel-2:#0b1220; --stroke:#1f2937; --stroke-2:#334155;
  --fg:#e5e7eb; --muted:#94a3b8;
  --ok:#16a34a; --ok-2:#14532d; --err:#dc2626; --err-2:#7f1d1d;
  --brand:#1e293b; --brand-2:#334155;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
a{color:inherit}
.wrap{min-height:100%;display:flex;flex-direction:column}

/* Header / tab bar */
header{padding:10px 12px;background:#0a0f1d;border-bottom:1px solid var(--stroke);position:sticky;top:0;z-index:30}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.brand{font-weight:900}
.tabs{display:flex;gap:10px;margin-top:8px}
.tab{padding:12px 16px;border-radius:16px;border:1px solid var(--stroke-2);background:#0c1426;font-weight:800}
.tab.active{background:#182235}
.badge-net{margin-left:auto;padding:4px 8px;border-radius:10px;font-size:12px;border:1px solid var(--stroke-2)}
.badge-net.online{background:rgba(22,163,74,.12);color:#86efac;border-color:var(--ok-2)}
.badge-net.offline{background:rgba(220,38,38,.10);color:#fecaca;border-color:var(--err-2)}

main{flex:1;display:flex;flex-direction:column;gap:14px;padding:12px}
.panel{background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:14px}
.btn{padding:14px 16px;border-radius:14px;border:1px solid var(--brand-2);background:var(--brand);color:#fff;font-weight:900;cursor:pointer}
.btn:active{transform:scale(.98)}
.btn-outline{background:var(--panel-2);border-color:var(--stroke-2);color:var(--fg)}
.btn-green{background:var(--ok-2);border-color:var(--ok-2)}
.btn-red{background:#7a1d1d;border-color:#7a1d1d}
.btn-ghost{background:transparent;border-color:var(--stroke-2)}
.btn-sm{padding:10px 12px;border-radius:12px;font-size:14px}

.hint{font-size:12px;color:var(--muted)}
.section-title{font-size:14px;color:var(--muted);margin-bottom:6px}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:720px){.grid2{grid-template-columns:1fr}}

/* Big status */
.statusWrap{text-align:center;display:flex;flex-direction:column;gap:10px;align-items:center}
.statusBadge{padding:6px 12px;border-radius:20px;border:1px solid var(--stroke-2);font-weight:900}
.statusBadge.ok{background:rgba(22,163,74,.12);border-color:var(--ok-2);color:#86efac}
.statusBadge.err{background:rgba(220,38,38,.10);border-color:var(--err-2);color:#fecaca}
.bigBox{min-width:240px; padding:16px;border-radius:16px;border:1px solid var(--stroke-2);background:#111b2b;display:flex;justify-content:space-between;gap:12px}
.bigLabel{font-weight:900;letter-spacing:.4px;color:#AEB8C7}
.bigVal{font-family:ui-monospace,Consolas,Menlo,monospace;font-size:26px;font-weight:900;letter-spacing:.6px;color:#cbd5e1}
.bigBox.ok{outline:2px solid rgba(22,163,74,.35);background:rgba(22,163,74,.08)}
.bigVal.ok{color:#86efac}

/* Scanner section controls */
.scn-actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
.scn-actions .btn{flex:1 1 220px}

/* Floating settings (FAB) only in Scanner tab) */
.fab{position:fixed;right:16px;top:80px;z-index:31;background:#0d1628;border:1px solid var(--stroke-2);border-radius:999px;padding:10px 12px;display:flex;gap:8px;align-items:center}
.fab span{font-weight:800}
.fab svg{width:18px;height:18px}

/* Bottom sheet settings */
.sheet{position:fixed;left:0;right:0;bottom:-100%;background:var(--panel);border-top:1px solid var(--stroke);border-radius:18px 18px 0 0;padding:14px;z-index:40;transition:bottom .25s}
.sheet.show{bottom:0}
.sheet .row{justify-content:space-between}
.switch{display:flex;align-items:center;gap:10px}
.switch input{width:44px;height:24px}

/* Immersive Scan Overlay (full screen reliable) */
#scanOverlay{position:fixed;inset:0;background:#000;display:none;flex-direction:column;z-index:50}
#scanOverlay.show{display:flex}
.scanTopBar{display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
.closeX{padding:10px 12px;border:1px solid var(--stroke-2);border-radius:12px;background:#111827}
.scanViewport{position:relative;width:100%;height:100dvh;overflow:hidden}
#video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
#overlay{position:absolute;inset:0;pointer-events:none}
#guide{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(62vw,340px);height:min(62vw,340px);border:3px solid rgba(255,255,255,.95);border-radius:16px;box-shadow:0 0 0 9999px rgba(0,0,0,.45) inset}
#laser{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:64px;height:64px;border:2px solid rgba(255,60,60,.85);border-radius:50%;box-shadow:0 0 16px rgba(255,60,60,.85)}

/* Qty modal */
#qtyModal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:60}
.modal{background:var(--panel);border:1px solid var(--stroke-2);border-radius:16px;min-width:280px;max-width:92vw;padding:16px}
.modal h3{margin:0 0 8px}
.qtyRow{display:flex;gap:10px;align-items:center;justify-content:center;margin:10px 0}
.qtyBtn{padding:10px 14px;border-radius:12px;border:1px solid var(--stroke-2);background:#111827;color:#fff;font-weight:900}
.qtyInput{width:110px;text-align:center;font-size:22px;font-weight:900;border:1px solid var(--stroke-2);border-radius:10px;background:#0a0f1d;color:#fff;padding:8px 10px}

/* Lists panel */
.tbl{width:100%;border-collapse:collapse}
.tbl th,.tbl td{padding:8px 10px;border-bottom:1px solid var(--stroke);font-size:14px}
.tbl th{background:#0a0f1d;position:sticky;top:0}

/* Utility */
.hide{display:none}
.mt8{margin-top:8px}
.center{text-align:center}
</style>
</head>
<body>
<div class="wrap">

  <!-- Header + Tabs -->
  <header>
    <div class="row">
      <div class="brand">Poka-Yoke <span style="opacity:.8">PRO</span></div>
      <div id="netBadge" class="badge-net offline">Offline</div>
    </div>
    <div class="tabs">
      <button class="tab" data-tab="comm">Commessa</button>
      <button class="tab active" data-tab="scan">Scanner</button>
      <button class="tab" data-tab="rows">Righe raccolte</button>
      <button id="openSettings" class="tab" title="Impostazioni" style="margin-left:auto">‚öôÔ∏è</button>
    </div>
  </header>

  <main>
    <!-- TAB COMMESSA -->
    <section id="tab-comm" class="panel hide">
      <div class="section-title">Dati testata</div>
      <div class="grid2">
        <div>
          <div class="section-title">Numero commessa</div>
          <input id="commessa" class="btn-ghost" placeholder="Es. 024830" style="width:100%;height:52px;padding:0 14px;border-radius:12px">
        </div>
        <div>
          <div class="section-title">Posizione</div>
          <input id="posizione" class="btn-ghost" placeholder="Es. POS 0020" style="width:100%;height:52px;padding:0 14px;border-radius:12px">
        </div>
      </div>
    </section>

    <!-- TAB SCANNER -->
    <section id="tab-scan" class="panel">
      <div class="statusWrap">
        <div id="statusBadge" class="statusBadge">Pronto</div>
        <div style="font-size:22px">Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b></div>

        <div id="boxList" class="bigBox">
          <div class="bigLabel">LISTA</div>
          <div id="valList" class="bigVal">‚Äî</div>
        </div>
        <div id="boxItem" class="bigBox">
          <div class="bigLabel">PEZZO</div>
          <div id="valItem" class="bigVal">‚Äî</div>
        </div>

        <div class="hint">Allinea il codice nel <b>quadrato</b> e centra nel cerchio rosso üî¥.</div>
      </div>

      <div class="scn-actions mt8">
        <button id="btnList" class="btn">üìã LISTA</button>
        <button id="btnItem" class="btn">üì¶ PEZZO</button>
        <button id="btnReset" class="btn btn-outline">üîÑ Reset</button>
      </div>

      <!-- Floating settings only in this tab -->
      <button id="fabSettings" class="fab" title="Impostazioni">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/><path stroke-width="2" d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82c-.2-.57-.76-.97-1.39-1H3a2 2 0 1 1 0-4h.09c.63-.03 1.19-.43 1.39-1a1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 7 4.39l.06.06c.48.45 1.16.6 1.79.39.6-.2 1.03-.76 1.06-1.39V3a2 2 0 1 1 4 0v.09c.03.63.46 1.19 1.06 1.39.63.21 1.31.06 1.79-.39l.06-.06A2 2 0 1 1 21 7l-.06.06a1.65 1.65 0 0 0-.33 1.82c.2.57.76.97 1.39 1H22a2 2 0 1 1 0 4h-.09c-.63.03-1.19.43-1.39 1Z"/></svg>
        <span>Impostazioni</span>
      </button>
    </section>

    <!-- TAB RIGHE -->
    <section id="tab-rows" class="panel hide">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="section-title">Righe raccolte</div>
        <div class="row" style="gap:8px">
          <button id="btnCSV" class="btn btn-outline btn-sm" disabled>‚¨áÔ∏è Scarica CSV</button>
          <button id="btnClear" class="btn btn-outline btn-sm" disabled>üóëÔ∏è Svuota</button>
        </div>
      </div>
      <div style="max-height:52vh;overflow:auto;margin-top:6px">
        <table class="tbl">
          <thead><tr><th>Ora</th><th>Codice</th><th>Q.t√†</th><th>Commessa</th><th>Posizione</th></tr></thead>
          <tbody id="rowsBody"></tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<!-- Bottom sheet impostazioni -->
<div id="settingsSheet" class="sheet" aria-hidden="true">
  <div class="row" style="margin-bottom:6px">
    <div style="font-weight:900">Impostazioni scanner</div>
    <button id="closeSheet" class="btn-ghost btn-sm">Chiudi</button>
  </div>
  <div class="row">
    <label class="switch"><input type="checkbox" id="confirm2" checked> <span>Conferma doppia</span></label>
    <label class="switch"><input type="checkbox" id="voice" checked> <span>Annuncio vocale</span></label>
  </div>
</div>

<!-- Immersive Scan Overlay -->
<div id="scanOverlay" role="dialog" aria-modal="true">
  <div class="scanTopBar">
    <button id="closeScan" class="closeX">‚úï Chiudi</button>
    <span class="hint">Inquadra e centra nel cerchio rosso</span>
    <div style="width:76px"></div>
  </div>
  <div class="scanViewport">
    <video id="video" muted playsinline></video>
    <canvas id="overlay"></canvas>
    <div id="guide"></div>
    <div id="laser"></div>
  </div>
</div>

<!-- Qty modal -->
<div id="qtyModal">
  <div class="modal">
    <h3>Inserisci quantit√† prelevata</h3>
    <div id="qtyInfo" class="hint"></div>
    <div class="qtyRow">
      <button id="qtyMinus" class="qtyBtn">‚àí</button>
      <input id="qtyInput" class="qtyInput" type="number" min="1" step="1" value="1">
      <button id="qtyPlus" class="qtyBtn">+</button>
    </div>
    <div class="row" style="justify-content:flex-end">
      <button id="qtyCancel" class="btn btn-outline btn-sm">Annulla</button>
      <button id="qtyOk" class="btn btn-green btn-sm">Conferma</button>
    </div>
  </div>
</div>

<script>
/* ---------- Stato rete ---------- */
const netBadge = document.getElementById('netBadge');
function setNet(){ const on=navigator.onLine; netBadge.textContent=on?'Online':'Offline'; netBadge.className='badge-net '+(on?'online':'offline'); }
addEventListener('online',setNet); addEventListener('offline',setNet); setNet();

/* ---------- Tabs ---------- */
const tabs=[...document.querySelectorAll('.tab')];
function showTab(id){
  document.querySelectorAll('main section').forEach(s=>s.classList.add('hide'));
  document.getElementById('tab-'+id).classList.remove('hide');
  tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===id));
}
tabs.forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.tab)));
showTab('scan');

/* ---------- Settings (FAB + sheet) ---------- */
const sheet = document.getElementById('settingsSheet');
const openSettings = ()=> sheet.classList.add('show');
const closeSettings = ()=> sheet.classList.remove('show');
document.getElementById('openSettings').onclick=openSettings;
document.getElementById('fabSettings').onclick=openSettings;
document.getElementById('closeSheet').onclick=closeSettings;

/* ---------- Stato app ---------- */
const el=id=>document.getElementById(id);
const commessa=el('commessa'), posizione=el('posizione');
const valList=el('valList'), valItem=el('valItem');
const boxList=el('boxList'), boxItem=el('boxItem');
const statusBadge=el('statusBadge');

let expected=null, scanned=null, pendingOK=null;
let picks=[]; // {ts,codice,qty,commessa,posizione}

/* Audio / voce */
document.addEventListener('click',()=>{speechSynthesis.getVoices();},{once:true});
let actx; function tone(f=880,d=120,t='sine',v=.25){try{if(!actx)actx=new (window.AudioContext||window.webkitAudioContext)();const o=actx.createOscillator(),g=actx.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(actx.destination);o.start();setTimeout(()=>o.stop(),d);}catch(e){}}
function okSound(){tone(900,110);setTimeout(()=>tone(1200,130),120)}
function errSound(){tone(250,200,'square',.22);setTimeout(()=>tone(180,220,'square',.20),200)}
function speak(msg){if(!el('voice').checked)return; try{const u=new SpeechSynthesisUtterance(msg);u.lang='it-IT';speechSynthesis.cancel();speechSynthesis.speak(u);}catch(e){}}

/* Utils */
const norm=s=>s?String(s).trim().toUpperCase():'';
const sanitize=(s,max=64)=>String(s||'').replace(/[^\w\-\. \/]/g,'').slice(0,max);

/* UI update */
function refreshUI(){
  valList.textContent = expected?expected:'‚Äî';
  valItem.textContent = scanned?scanned:'‚Äî';

  const same = expected && scanned && norm(expected)===norm(scanned);
  boxList.classList.toggle('ok', same);
  boxItem.classList.toggle('ok', same);
  valList.classList.toggle('ok', same);
  valItem.classList.toggle('ok', same);

  if(expected && scanned){
    if(same){
      statusBadge.textContent='Corretto';
      statusBadge.className='statusBadge ok';
      okSound(); speak('Codice corretto');
      pendingOK=expected; openQtyModal(pendingOK);
    }else{
      statusBadge.textContent='Errato';
      statusBadge.className='statusBadge err';
      errSound(); speak('Codice diverso');
      pendingOK=null;
    }
  }else{
    statusBadge.textContent='Pronto';
    statusBadge.className='statusBadge';
  }
}

/* Qty modal */
const qtyModal=el('qtyModal'), qtyInput=el('qtyInput'), qtyInfo=el('qtyInfo');
function openQtyModal(code){
  qtyInfo.innerHTML='Codice: <b>'+code+'</b>';
  qtyInput.value='1'; qtyModal.style.display='flex'; qtyInput.focus({preventScroll:true});
}
function closeQty(){ qtyModal.style.display='none'; }
el('qtyMinus').onclick=()=>{ qtyInput.value=Math.max(1,(+qtyInput.value||1)-1); };
el('qtyPlus').onclick=()=>{ qtyInput.value=Math.max(1,(+qtyInput.value||1)+1); };
el('qtyCancel').onclick=closeQty;
el('qtyOk').onclick=()=>{
  const qty=Math.max(1,parseInt(qtyInput.value||'1',10));
  if(!pendingOK){ closeQty(); return; }
  const ts=new Date();
  picks.push({ts, codice: sanitize(pendingOK,128), qty, commessa: sanitize(commessa.value,64), posizione: sanitize(posizione.value,64)});
  pendingOK=null; scanned=null; refreshUI(); renderRows(); closeQty();
};

/* Righe */
function renderRows(){
  const body=el('rowsBody');
  body.innerHTML = picks.map(p=>{
    const hh=p.ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    return `<tr><td>${hh}</td><td>${p.codice}</td><td>${p.qty}</td><td>${p.commessa||'-'}</td><td>${p.posizione||'-'}</td></tr>`;
  }).join('');
  el('btnCSV').disabled = el('btnClear').disabled = picks.length===0;
}
function toCSV(){
  const head='timestamp_ms,iso,codice,quantita,commessa,posizione\n';
  const body=picks.map(p=>[p.ts.getTime(),p.ts.toISOString(),p.codice,p.qty,p.commessa||'',p.posizione||''].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  return head+body;
}
el('btnCSV').onclick=()=>{
  if(!picks.length) return;
  const blob=new Blob([toCSV()],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`scheda_picking_${(commessa.value||'commessa')}.csv`; a.click();
  URL.revokeObjectURL(url);
};
el('btnClear').onclick=()=>{ if(confirm('Svuotare la lista?')){ picks=[]; renderRows(); } };

/* Reset */
el('btnReset').onclick=()=>{ expected=null; scanned=null; pendingOK=null; refreshUI(); };

/* ----------------- Scanner: Immersive Overlay ----------------- */
const overlayDlg = el('scanOverlay');
const video = el('video'), canvas = el('overlay'), guide = el('guide'), laser = el('laser');
let stream=null, track=null, mode=null, confirmBuf=[], lastVal=null, lastScanTs=0;

function canAccept(){ const now=performance.now(); if(now-lastScanTs<600) return false; lastScanTs=now; return true; }

async function startScan(which){
  // resta nella tab Scanner
  showTab('scan');

  // apri overlay full-screen
  overlayDlg.classList.add('show');
  try{ if(overlayDlg.requestFullscreen) await overlayDlg.requestFullscreen(); }catch(e){}

  mode=which; confirmBuf=[]; lastVal=null;

  // get camera
  const cons={video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}};
  stream = await navigator.mediaDevices.getUserMedia(cons).catch(()=>null);
  if(!stream){ alert('Fotocamera non disponibile.'); closeScan(); return; }
  track=stream.getVideoTracks()[0];
  video.srcObject=stream; await video.play();

  // prefer native BarcodeDetector
  if('BarcodeDetector' in window){
    detectLoopNative();
  }else{
    detectLoopZXing();
  }
}

function closeScan(){
  try{
    if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
    if(track) track.stop();
  }catch(e){}
  overlayDlg.classList.remove('show');
  if(document.fullscreenElement){ document.exitFullscreen().catch(()=>{}); }
}

el('btnList').onclick=()=>startScan('list');
el('btnItem').onclick=()=>startScan('item');
el('closeScan').onclick=closeScan;

/* Native detector */
async function detectLoopNative(){
  const det = new BarcodeDetector({formats:['qr_code','code_128','ean_13','ean_8','upc_a','code_39']});
  const ctx=canvas.getContext('2d');
  (function loop(){
    if(!stream) return;
    if(video.readyState>=2){
      canvas.width=video.videoWidth; canvas.height=video.videoHeight;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      det.detect(video).then(codes=>{
        const g=guide.getBoundingClientRect(), v=video.getBoundingClientRect();
        const gx=g.left-v.left, gy=g.top-v.top, gw=g.width, gh=g.height;
        const sx=canvas.width/v.width, sy=canvas.height/v.height;
        let accepted=null;
        for(const c of codes){
          const r=c.boundingBox; const cx=r.x+r.width/2, cy=r.y+r.height/2;
          const domX=cx/sx, domY=cy/sy;
          const g2=laser.getBoundingClientRect(); const lx=g2.left-v.left+g2.width/2, ly=g2.top-v.top+g2.height/2;
          const dist=Math.hypot(domX-lx,domY-ly);
          if(domX>=gx&&domX<=gx+gw&&domY>=gy&&domY<=gy+gh & dist<g2.width/2){ accepted=c.rawValue; break; }
        }
        if(accepted && canAccept()){
          if(el('confirm2').checked){
            if(lastVal===accepted){ confirmBuf.push(accepted); } else { confirmBuf=[accepted]; lastVal=accepted; }
            if(confirmBuf.length>=2){ onScan(accepted); return; }
          }else{ onScan(accepted); return; }
        }
        requestAnimationFrame(loop);
      }).catch(()=>requestAnimationFrame(loop));
    }else{
      requestAnimationFrame(loop);
    }
  })();
}

/* ZXing fallback */
async function detectLoopZXing(){
  const formats=[ZXing.BarcodeFormat.QR_CODE,ZXing.BarcodeFormat.CODE_128,ZXing.BarcodeFormat.EAN_13,ZXing.BarcodeFormat.UPC_A,ZXing.BarcodeFormat.CODE_39];
  const hints=new Map(); hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,formats);
  const reader=new ZXing.BrowserMultiFormatReader(hints);
  await video.play();
  (async function loop(){
    try{
      const res=await reader.decodeFromVideoElement(video);
      if(res && canAccept()){ onScan(res.text); return; }
    }catch(e){}
    requestAnimationFrame(loop);
  })();
}

/* Handle read */
function onScan(text){
  const val = sanitize(text,128);
  if(mode==='list') expected=val; else scanned=val;
  closeScan(); // chiude overlay ma resta nella tab Scanner
  refreshUI();
}

/* CSV buttons in rows tab are already wired above */
</script>
</body>
</html>
```Ó®Å0Ó®Ç