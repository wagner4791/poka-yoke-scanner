<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Poka-Yoke PRO â€¢ Scanner IBRIDO</title>

<!-- ZXing fallback -->
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>

<!-- PDF: jsPDF + autoTable -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --bg:#0F172A;        /* sfondo app (blu notte) */
    --panel:#16223A;     /* pannelli */
    --panel-2:#0d182f;   /* pannelli scuri */
    --border:#273449;    /* bordi */
    --text:#E6EDF7;      /* testo primario */
    --muted:#B7C6DC;     /* testo secondario (piÃ¹ leggibile) */
    --accent:#38BDF8;    /* azioni */
    --ok:#22C55E;        /* successo */
    --err:#EF4444;       /* errore */
    --warn:#F59E0B;      /* offline */
  }

  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Inter,Segoe UI,Roboto,Arial}
  .app{min-height:100%;display:flex;flex-direction:column}

  /* Header + tabs */
  header{padding:12px 16px;border-bottom:1px solid var(--border);background:#0B1325}
  .topbar{display:flex;align-items:center;gap:10px;justify-content:space-between}
  .brand{font-weight:800}
  .rightBox{display:flex;gap:10px;align-items:center}
  #langSelect{background:#0d182f;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px}
  #netBadge{font-size:12px;padding:4px 8px;border-radius:8px;border:1px solid var(--border)}
  #netBadge.online{background:rgba(34,197,94,.12);color:#86efac;border-color:#14532d}
  #netBadge.offline{background:rgba(245,158,11,.12);color:#FCD34D;border-color:#B45309}

  .tabs{display:flex;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);background:#0E1A32}
  .tab{padding:10px 14px;border-radius:999px;border:1px solid var(--border);color:var(--text);opacity:.8;cursor:pointer;font-weight:700;background:#11203d}
  .tab.active{background:var(--accent);border-color:var(--accent);color:#05263A;opacity:1}

  main{flex:1;display:flex;flex-direction:column}
  .view{display:none;padding:14px}
  .view.active{display:block}

  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px}
  .panel-2{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:12px}
  .note{color:var(--muted);font-size:13px}

  /* Inputs / buttons */
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label.field{display:flex;flex-direction:column;gap:6px;flex:1 1 220px;min-width:200px}
  label.field span{font-size:12px;color:var(--muted)}
  .input, select{background:#0d182f;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px 12px;font-size:16px}
  .btn{padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#11203d;color:var(--text);font-weight:800;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .btn-primary{background:var(--accent);border-color:var(--accent);color:#05263A}
  .btn-ok{background:#0f2a1a;border-color:#14532d}
  .btn-outline{background:#0d182f}

  /* Scanner status */
  .status{display:flex;flex-direction:column;gap:8px;align-items:center;text-align:center}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;border:1px solid var(--border)}
  .badge.ok{background:rgba(34,197,94,.18);color:#b7f7c7;border-color:#14532d}
  .badge.err{background:rgba(239,68,68,.18);color:#ffd5d5;border-color:#7f1d1d}

  #codes{display:flex;flex-direction:column;gap:10px;align-items:stretch;margin-top:4px;width:100%;max-width:680px}
  .codeBox{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0b162c}
  .codeLabel{font-size:13px;color:var(--muted);font-weight:800}
  .codeValue{flex:1;text-align:right;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-weight:900;letter-spacing:.5px;font-size:clamp(22px,3.6vh,40px);color:var(--text);word-break:break-all}
  .codeBox.ok{border-color:#14532d;background:rgba(34,197,94,.10)}
  .codeBox.err{border-color:#7f1d1d;background:rgba(239,68,68,.08)}
  .codeValue.ok{color:#86efac}
  .codeValue.err{color:#fecaca}

  /* Righe raccolte */
  #righeBox{max-height:50vh;overflow:auto;border:1px solid var(--border);border-radius:10px;background:#0b162c}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:14px}
  th{position:sticky;top:0;background:#0b1325;text-align:left;font-weight:800;color:#E9F2FF}
  tbody tr:nth-child(odd){background:#0f1d34}
  tbody tr:nth-child(even){background:#0d182f}
  .countPill{margin-left:8px;font-size:12px;padding:3px 8px;border-radius:10px;background:#0d2230;border:1px solid var(--border);color:var(--text)}

  /* Fullscreen camera overlay */
  #camFS{position:fixed;inset:0;display:none;background:#000;z-index:9999}
  #camFS.active{display:block}
  .camTop{position:absolute;top:0;left:0;right:0;height:56px;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:linear-gradient(to bottom, rgba(0,0,0,.65), rgba(0,0,0,.0))}
  .camBtn{background:rgba(0,0,0,.45);color:#fff;border:1px solid rgba(255,255,255,.2);padding:8px 12px;border-radius:10px;font-weight:800}
  .camWrap{position:absolute;inset:0}
  #video{position:absolute;inset:0;object-fit:cover;width:100%;height:100%}
  #overlay{position:absolute;inset:0;pointer-events:none}
  #guide{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:34%;height:34%;border:3px solid rgba(255,255,255,.95);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,.35) inset;pointer-events:none}
  #laser{position:absolute;left:50%;top:50%;width:54px;height:54px;border:2px solid rgba(255,60,60,.9);border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 12px rgba(255,60,60,.85);pointer-events:none}

  /* Modale quantitÃ  */
  #qtyModal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:10000}
  .modalCard{background:#0b162c;border:1px solid var(--border);border-radius:14px;padding:16px;min-width:280px;max-width:92vw;box-shadow:0 10px 30px rgba(0,0,0,.6)}
  .modalTitle{font-weight:800;margin-bottom:8px}
  .qtyRow{display:flex;gap:10px;align-items:center;justify-content:center;margin:12px 0}
  .qtyBtn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#0f203c;color:var(--text);font-weight:800;font-size:20px;cursor:pointer}
  .qtyInput{width:110px;text-align:center;font-size:22px;font-weight:900;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0f1b35;color:var(--text)}
  .modalActions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}

  /* Toast */
  #toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);min-width:220px;max-width:90vw;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0d2230;color:var(--text);display:none;z-index:10001;text-align:center;font-weight:700}
  #toast.ok{background:rgba(34,197,94,.15);border-color:#14532d;color:#b7f7c7}
  #toast.err{background:rgba(239,68,68,.15);border-color:#7f1d1d;color:#ffd5d5}

  /* Small text */
  .muted{color:var(--muted)}
  .help{font-size:12px;color:var(--muted)}
</style>
</head>

<body>
<div class="app">
  <header>
    <div class="topbar">
      <div class="brand" data-i18n="brand">Poka-Yoke PRO â€¢ Scanner IBRIDO</div>
      <div class="rightBox">
        <select id="langSelect" aria-label="Language">
          <option value="pt-BR">PortuguÃªs (BR)</option>
          <option value="it" selected>Italiano</option>
          <option value="en">English</option>
          <option value="ur">Ø§Ø±Ø¯Ùˆ</option>
        </select>
        <span id="netBadge" class="offline">Offline</span>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="commessa" data-i18n="tab_commessa">Commessa</button>
    <button class="tab" data-tab="scanner" data-i18n="tab_scanner">Scanner</button>
    <button class="tab" data-tab="righe" data-i18n="tab_righe">Righe raccolte</button>
    <button class="tab" data-tab="impostazioni" data-i18n="tab_impostazioni">Impostazioni</button>
  </div>

  <main>
    <!-- COMMESSA -->
    <section id="commessa" class="view active">
      <div class="panel">
        <div class="row">
          <label class="field">
            <span data-i18n="lbl_commessa">Numero commessa</span>
            <input id="commessaInput" class="input" placeholder="024830" autocomplete="off"/>
          </label>
          <label class="field">
            <span data-i18n="lbl_posizione">Posizione</span>
            <input id="posizioneInput" class="input" placeholder="POS 0020" autocomplete="off"/>
          </label>
          <label class="field" style="min-width:200px;flex:1 1 260px">
            <span data-i18n="lbl_camera">Fotocamera</span>
            <select id="cameraSelect" class="input">
              <option value="">(automatica)</option>
            </select>
          </label>
          <label class="field" style="min-width:200px;flex:1 1 220px">
            <span data-i18n="lbl_operatore">Operatore</span>
            <input id="operatoreInput" class="input" placeholder="Junior" autocomplete="off"/>
          </label>
        </div>
        <div class="row" style="margin-top:10px;gap:8px">
          <button id="goScanner" class="btn btn-primary" data-i18n="btn_scanner">Vai allo Scanner</button>
          <button id="saveFields" class="btn btn-outline" data-i18n="btn_salvacampi">Salva campi</button>
        </div>
      </div>
      <div class="panel-2 help" data-i18n="hint_commessa">
        Suggerimento: compila commessa/posizione/operatore e premi â€œSalva campiâ€. Rimarranno sul dispositivo.
      </div>
    </section>

    <!-- SCANNER -->
    <section id="scanner" class="view">
      <div class="panel status">
        <div id="badge" class="badge" data-i18n="badge_ready">Pronto</div>
        <div id="resultText" data-i18n-html="hint_scan">Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b></div>
        <div id="codes"></div>
        <div class="muted" data-i18n="hint_align">Allinea il codice nel quadrato e centra nel cerchio rosso ğŸ”´.</div>
      </div>

      <div class="panel">
        <div class="row">
          <button id="scanList" class="btn btn-primary" data-i18n="btn_list_fs">ğŸ“‹ LISTA (fullscreen)</button>
          <button id="scanItem" class="btn btn-primary" data-i18n="btn_piece_fs">ğŸ“¦ PEZZO (fullscreen)</button>
          <button id="reset" class="btn btn-outline" data-i18n="btn_reset">ğŸ”„ Reset</button>
        </div>
      </div>
    </section>

    <!-- RIGHE -->
    <section id="righe" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:800" data-i18n="title_righe">Righe raccolte <span class="countPill" id="countPill">0</span></div>
          <div class="row" style="gap:8px">
            <button id="scaricaCSV" class="btn btn-outline" disabled data-i18n="btn_csv">â¬‡ï¸ Scarica CSV</button>
            <button id="scaricaPDF" class="btn btn-outline" disabled data-i18n="btn_pdf">ğŸ“ Scarica PDF</button>
            <button id="saveSession" class="btn btn-outline" disabled data-i18n="btn_salvasessione">ğŸ’¾ Salva sessione</button>
            <button id="svuota" class="btn btn-outline" disabled data-i18n="btn_svuota">ğŸ—‘ï¸ Svuota</button>
          </div>
        </div>

        <div id="restoreBox" class="panel-2" style="display:none; margin-top:10px">
          <div class="row" style="justify-content:space-between;gap:8px;align-items:center">
            <div class="help" id="restoreInfo">Ãˆ presente una sessione salvata.</div>
            <div class="row" style="gap:8px">
              <button id="restoreSession" class="btn btn-primary" data-i18n="btn_ripristina">ğŸ“‚ Ripristina</button>
              <button id="deleteSaved" class="btn btn-outline" data-i18n="btn_cancella_salvata">ğŸ—‘ï¸ Elimina salvata</button>
            </div>
          </div>
        </div>

        <div id="righeBox" style="margin-top:10px">
          <table>
            <thead><tr>
              <th data-i18n="col_ora">Ora</th>
              <th data-i18n="col_codice">Codice</th>
              <th data-i18n="col_qta">Q.tÃ </th>
              <th data-i18n="col_commessa">Commessa</th>
              <th data-i18n="col_posizione">Posizione</th>
            </tr></thead>
            <tbody id="righeBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- IMPOSTAZIONI -->
    <section id="impostazioni" class="view">
      <div class="panel">
        <div style="font-weight:800;margin-bottom:8px" data-i18n="title_impostazioni">Impostazioni</div>
        <div class="row">
          <label class="field" style="flex:0 0 260px">
            <span data-i18n="opt_confirm_lbl">Conferma doppia</span>
            <select id="optConfirm" class="input">
              <option value="on" selected data-i18n="opt_confirm_on">Attiva (piÃ¹ sicuro)</option>
              <option value="off" data-i18n="opt_confirm_off">Disattiva (piÃ¹ veloce)</option>
            </select>
          </label>
          <label class="field" style="flex:0 0 260px">
            <span data-i18n="opt_voice_lbl">Annuncio vocale</span>
            <select id="optVoice" class="input">
              <option value="on" selected data-i18n="common_on">Attivo</option>
              <option value="off" data-i18n="common_off">Disattivo</option>
            </select>
          </label>
          <label class="field" style="flex:0 0 260px">
            <span data-i18n="opt_vibrate_lbl">Vibrazione</span>
            <select id="optVibrate" class="input">
              <option value="on" selected data-i18n="common_on">Attiva</option>
              <option value="off" data-i18n="common_off">Disattiva</option>
            </select>
          </label>
        </div>
        <div class="panel-2" style="margin-top:10px">
          <div class="help" data-i18n="hint_refresh">
            Se ci sono righe non salvate, il sistema chiederÃ  conferma prima di chiudere/ricaricare la pagina.
          </div>
        </div>
      </div>
      <div class="panel-2 help">UI 1.1 â€¢ Solo locale (nessun invio in rete).</div>
    </section>
  </main>
</div>

<!-- Fullscreen Camera -->
<div id="camFS">
  <div class="camTop">
    <button id="camClose" class="camBtn">âœ•</button>
    <div id="camHint" class="camBtn" style="pointer-events:none">Inquadra e centra nel cerchio</div>
  </div>
  <div class="camWrap">
    <video id="video" muted playsinline></video>
    <canvas id="overlay"></canvas>
    <div id="guide"></div>
    <div id="laser"></div>
  </div>
</div>

<!-- Modale quantitÃ  -->
<div id="qtyModal">
  <div class="modalCard">
    <div class="modalTitle" data-i18n="modal_qty_title">Inserisci quantitÃ  prelevata</div>
    <div id="qtyInfo" class="muted" style="margin-bottom:6px"></div>
    <div class="qtyRow">
      <button id="qtyMinus" class="qtyBtn">âˆ’</button>
      <input id="qtyInput" class="qtyInput" type="number" min="1" step="1" value="" placeholder=""/>
      <button id="qtyPlus" class="qtyBtn">+</button>
    </div>
    <div class="modalActions">
      <button id="qtyCancel" class="btn btn-outline" data-i18n="btn_annulla">Annulla</button>
      <button id="qtyOk" class="btn btn-ok" data-i18n="btn_conferma">Conferma</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
/* ========= i18n ========= */
const I18N = {
  "it": {
    brand:"Poka-Yoke PRO â€¢ Scanner IBRIDO",
    tab_commessa:"Commessa", tab_scanner:"Scanner", tab_righe:"Righe raccolte", tab_impostazioni:"Impostazioni",
    lbl_commessa:"Numero commessa", lbl_posizione:"Posizione", lbl_camera:"Fotocamera", lbl_operatore:"Operatore",
    btn_scanner:"Vai allo Scanner", btn_salvacampi:"Salva campi",
    badge_ready:"Pronto", hint_scan:"Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b>", hint_align:"Allinea il codice nel quadrato e centra nel cerchio rosso ğŸ”´.",
    btn_list_fs:"ğŸ“‹ LISTA (fullscreen)", btn_piece_fs:"ğŸ“¦ PEZZO (fullscreen)", btn_reset:"ğŸ”„ Reset",
    title_righe:"Righe raccolte", btn_csv:"â¬‡ï¸ Scarica CSV", btn_pdf:"ğŸ“ Scarica PDF", btn_salvasessione:"ğŸ’¾ Salva sessione", btn_svuota:"ğŸ—‘ï¸ Svuota",
    btn_ripristina:"ğŸ“‚ Ripristina", btn_cancella_salvata:"ğŸ—‘ï¸ Elimina salvata",
    col_ora:"Ora", col_codice:"Codice", col_qta:"Q.tÃ ", col_commessa:"Commessa", col_posizione:"Posizione",
    title_impostazioni:"Impostazioni", opt_confirm_lbl:"Conferma doppia", opt_confirm_on:"Attiva (piÃ¹ sicuro)", opt_confirm_off:"Disattiva (piÃ¹ veloce)",
    opt_voice_lbl:"Annuncio vocale", opt_vibrate_lbl:"Vibrazione", common_on:"Attivo/Attiva", common_off:"Disattivo/Disattiva",
    hint_commessa:"Suggerimento: compila commessa/posizione/operatore e premi â€œSalva campiâ€. Rimarranno sul dispositivo.",
    hint_refresh:"Se ci sono righe non salvate, il sistema chiederÃ  conferma prima di chiudere/ricaricare la pagina.",
    modal_qty_title:"Inserisci quantitÃ  prelevata", btn_annulla:"Annulla", btn_conferma:"Conferma",
    toast_riga_ok:"Riga aggiunta", pdf_title:"Scheda Picking", pdf_operatore:"Operatore", pdf_commessa:"Commessa",
    pdf_posizione:"Posizione", pdf_data:"Data", pdf_ora:"Ora", pdf_codice:"Codice", pdf_qta:"Q.tÃ ",
    pdf_totrighe:"Righe totali", pdf_totpezzi:"Pezzi totali", pdf_generato:"Generato"
  },
  "pt-BR": {
    brand:"Poka-Yoke PRO â€¢ Leitor HÃBRIDO",
    tab_commessa:"Pedido", tab_scanner:"Scanner", tab_righe:"Linhas coletadas", tab_impostazioni:"ConfiguraÃ§Ãµes",
    lbl_commessa:"NÃºmero do pedido", lbl_posizione:"PosiÃ§Ã£o", lbl_camera:"CÃ¢mera", lbl_operatore:"Operador",
    btn_scanner:"Ir para o Scanner", btn_salvacampi:"Salvar campos",
    badge_ready:"Pronto", hint_scan:"Leia primeiro a <b>LISTA</b>, depois a <b>PEÃ‡A</b>", hint_align:"Alinhe o cÃ³digo no quadrado e centralize no cÃ­rculo vermelho ğŸ”´.",
    btn_list_fs:"ğŸ“‹ LISTA (tela cheia)", btn_piece_fs:"ğŸ“¦ PEÃ‡A (tela cheia)", btn_reset:"ğŸ”„ Limpar",
    title_righe:"Linhas coletadas", btn_csv:"â¬‡ï¸ Baixar CSV", btn_pdf:"ğŸ“ Baixar PDF", btn_salvasessione:"ğŸ’¾ Salvar sessÃ£o", btn_svuota:"ğŸ—‘ï¸ Esvaziar",
    btn_ripristina:"ğŸ“‚ Restaurar", btn_cancella_salvata:"ğŸ—‘ï¸ Apagar salvo",
    col_ora:"Hora", col_codice:"CÃ³digo", col_qta:"Qtd.", col_commessa:"Pedido", col_posizione:"PosiÃ§Ã£o",
    title_impostazioni:"ConfiguraÃ§Ãµes", opt_confirm_lbl:"ConfirmaÃ§Ã£o dupla", opt_confirm_on:"Ativar (mais seguro)", opt_confirm_off:"Desativar (mais rÃ¡pido)",
    opt_voice_lbl:"AnÃºncio por voz", opt_vibrate_lbl:"VibraÃ§Ã£o", common_on:"Ativo/Ativa", common_off:"Inativo/Desativada",
    hint_commessa:"Dica: preencha pedido/posiÃ§Ã£o/operador e toque em â€œSalvar camposâ€. Ficam no dispositivo.",
    hint_refresh:"Se houver linhas nÃ£o salvas, o sistema pedirÃ¡ confirmaÃ§Ã£o ao sair/atualizar.",
    modal_qty_title:"Informe a quantidade", btn_annulla:"Cancelar", btn_conferma:"Confirmar",
    toast_riga_ok:"Linha adicionada", pdf_title:"Ficha de Picking", pdf_operatore:"Operador", pdf_commessa:"Pedido",
    pdf_posizione:"PosiÃ§Ã£o", pdf_data:"Data", pdf_ora:"Hora", pdf_codice:"CÃ³digo", pdf_qta:"Qtd.",
    pdf_totrighe:"Total de linhas", pdf_totpezzi:"Total de peÃ§as", pdf_generato:"Gerado"
  },
  "en": {
    brand:"Poka-Yoke PRO â€¢ HYBRID Scanner",
    tab_commessa:"Order", tab_scanner:"Scanner", tab_righe:"Collected rows", tab_impostazioni:"Settings",
    lbl_commessa:"Order number", lbl_posizione:"Position", lbl_camera:"Camera", lbl_operatore:"Operator",
    btn_scanner:"Go to Scanner", btn_salvacampi:"Save fields",
    badge_ready:"Ready", hint_scan:"Scan the <b>LIST</b> first, then the <b>ITEM</b>", hint_align:"Align the code inside the square and center in the red circle ğŸ”´.",
    btn_list_fs:"ğŸ“‹ LIST (fullscreen)", btn_piece_fs:"ğŸ“¦ ITEM (fullscreen)", btn_reset:"ğŸ”„ Reset",
    title_righe:"Collected rows", btn_csv:"â¬‡ï¸ Download CSV", btn_pdf:"ğŸ“ Download PDF", btn_salvasessione:"ğŸ’¾ Save session", btn_svuota:"ğŸ—‘ï¸ Clear",
    btn_ripristina:"ğŸ“‚ Restore", btn_cancella_salvata:"ğŸ—‘ï¸ Delete saved",
    col_ora:"Time", col_codice:"Code", col_qta:"Qty", col_commessa:"Order", col_posizione:"Position",
    title_impostazioni:"Settings", opt_confirm_lbl:"Double confirmation", opt_confirm_on:"Enable (safer)", opt_confirm_off:"Disable (faster)",
    opt_voice_lbl:"Voice announcement", opt_vibrate_lbl:"Vibration", common_on:"On", common_off:"Off",
    hint_commessa:"Tip: fill order/position/operator and press â€œSave fieldsâ€. They remain on device.",
    hint_refresh:"If there are unsaved rows, the app will ask before leaving/reloading.",
    modal_qty_title:"Enter picked quantity", btn_annulla:"Cancel", btn_conferma:"Confirm",
    toast_riga_ok:"Row added", pdf_title:"Picking Sheet", pdf_operatore:"Operator", pdf_commessa:"Order",
    pdf_posizione:"Position", pdf_data:"Date", pdf_ora:"Time", pdf_codice:"Code", pdf_qta:"Qty",
    pdf_totrighe:"Rows total", pdf_totpezzi:"Pieces total", pdf_generato:"Generated"
  },
  "ur": {
    brand:"Ù¾ÙˆÚ©Ø§ÛŒÙˆÚ©Û’ Ù¾Ø±Ùˆ â€¢ ÛØ§Ø¦Ø¨Ø±Úˆ Ø§Ø³Ú©ÛŒÙ†Ø±",
    tab_commessa:"Ø¢Ø±ÚˆØ±", tab_scanner:"Ø§Ø³Ú©ÛŒÙ†Ø±", tab_righe:"Ø§Ú©Ù¹Ú¾ÛŒ Ù‚Ø·Ø§Ø±ÛŒÚº", tab_impostazioni:"Ø³ÛŒÙ¹Ù†Ú¯Ø²",
    lbl_commessa:"Ø¢Ø±ÚˆØ± Ù†Ù…Ø¨Ø±", lbl_posizione:"Ù¾ÙˆØ²ÛŒØ´Ù†", lbl_camera:"Ú©ÛŒÙ…Ø±Û", lbl_operatore:"Ø¢Ù¾Ø±ÛŒÙ¹Ø±",
    btn_scanner:"Ø§Ø³Ú©ÛŒÙ†Ø± Ú©Ú¾ÙˆÙ„ÛŒÚº", btn_salvacampi:"ÙÛŒÙ„ÚˆØ² Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº",
    badge_ready:"ØªÛŒØ§Ø±", hint_scan:"Ù¾ÛÙ„Û’ <b>Ù„Ø³Ù¹</b> Ø§Ø³Ú©ÛŒÙ† Ú©Ø±ÛŒÚºØŒ Ù¾Ú¾Ø± <b>Ù¾ÙÛŒØ³</b>", hint_align:"Ú©ÙˆÚˆ Ú©Ùˆ Ù…Ø±Ø¨Ø¹ Ù…ÛŒÚº Ø±Ú©Ú¾ÛŒÚº Ø§ÙˆØ± Ø³Ø±Ø® Ø¯Ø§Ø¦Ø±Û’ Ú©Û’ ÙˆØ³Ø· Ù…ÛŒÚº Ù„Ø§Ø¦ÛŒÚº ğŸ”´Û”",
    btn_list_fs:"ğŸ“‹ Ù„Ø³Ù¹ (ÙÙ„ Ø§Ø³Ú©Ø±ÛŒÙ†)", btn_piece_fs:"ğŸ“¦ Ù¾ÙÛŒØ³ (ÙÙ„ Ø§Ø³Ú©Ø±ÛŒÙ†)", btn_reset:"ğŸ”„ Ø±ÛŒ Ø³ÛŒÙ¹",
    title_righe:"Ø§Ú©Ù¹Ú¾ÛŒ Ù‚Ø·Ø§Ø±ÛŒÚº", btn_csv:"â¬‡ï¸ Ø³ÛŒ Ø§ÛŒØ³ ÙˆÛŒ ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆ", btn_pdf:"ğŸ“ Ù¾ÛŒ ÚˆÛŒ Ø§ÛŒÙ ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆ", btn_salvasessione:"ğŸ’¾ Ø³ÛŒØ´Ù† Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº", btn_svuota:"ğŸ—‘ï¸ Ø®Ø§Ù„ÛŒ Ú©Ø±ÛŒÚº",
    btn_ripristina:"ğŸ“‚ Ø¨Ø­Ø§Ù„ Ú©Ø±ÛŒÚº", btn_cancella_salvata:"ğŸ—‘ï¸ Ù…Ø­ÙÙˆØ¸ Ø´Ø¯Û Ø­Ø°Ù Ú©Ø±ÛŒÚº",
    col_ora:"ÙˆÙ‚Øª", col_codice:"Ú©ÙˆÚˆ", col_qta:"Ù…Ù‚Ø¯Ø§Ø±", col_commessa:"Ø¢Ø±ÚˆØ±", col_posizione:"Ù¾ÙˆØ²ÛŒØ´Ù†",
    title_impostazioni:"Ø³ÛŒÙ¹Ù†Ú¯Ø²", opt_confirm_lbl:"ÚˆØ¨Ù„ ØªØµØ¯ÛŒÙ‚", opt_confirm_on:"Ø¢Ù† (Ù…Ø­ÙÙˆØ¸)", opt_confirm_off:"Ø¢Ù (ØªÛŒØ²)",
    opt_voice_lbl:"Ø¢ÙˆØ§Ø² Ø§Ø¹Ù„Ø§Ù†", opt_vibrate_lbl:"ÙˆØ§Ø¦Ø¨Ø±ÛŒØ´Ù†", common_on:"Ø¢Ù†", common_off:"Ø¢Ù",
    hint_commessa:"Ù…Ø´ÙˆØ±Û: Ø¢Ø±ÚˆØ±/Ù¾ÙˆØ²ÛŒØ´Ù†/Ø¢Ù¾Ø±ÛŒÙ¹Ø± Ù„Ú©Ú¾ Ú©Ø± â€œÙÛŒÙ„ÚˆØ² Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚºâ€ Ø¯Ø¨Ø§Ø¦ÛŒÚºÛ” ÛŒÛ ÚˆÛŒÙˆØ§Ø¦Ø³ Ù…ÛŒÚº Ù…Ø­ÙÙˆØ¸ Ø±ÛÛŒÚº Ú¯Û’Û”",
    hint_refresh:"Ø§Ú¯Ø± ØºÛŒØ± Ù…Ø­ÙÙˆØ¸ Ù‚Ø·Ø§Ø±ÛŒÚº ÛÙˆÚº ØªÙˆ Ø¨Ù†Ø¯/Ø±ÛŒÙØ±ÛŒØ´ Ø³Û’ Ù¾ÛÙ„Û’ Ù¾ÙˆÚ†Ú¾Ø§ Ø¬Ø§Ø¦Û’ Ú¯Ø§Û”",
    modal_qty_title:"Ø§Ù¹Ú¾Ø§Ø¦ÛŒ Ú¯Ø¦ÛŒ Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº", btn_annulla:"Ù…Ù†Ø³ÙˆØ®", btn_conferma:"ØªØµØ¯ÛŒÙ‚",
    toast_riga_ok:"Ù‚Ø·Ø§Ø± Ø´Ø§Ù…Ù„ ÛÙˆ Ú¯Ø¦ÛŒ", pdf_title:"Ù¾Ú©Ù†Ú¯ Ø´ÛŒÙ¹", pdf_operatore:"Ø¢Ù¾Ø±ÛŒÙ¹Ø±", pdf_commessa:"Ø¢Ø±ÚˆØ±",
    pdf_posizione:"Ù¾ÙˆØ²ÛŒØ´Ù†", pdf_data:"ØªØ§Ø±ÛŒØ®", pdf_ora:"ÙˆÙ‚Øª", pdf_codice:"Ú©ÙˆÚˆ", pdf_qta:"Ù…Ù‚Ø¯Ø§Ø±",
    pdf_totrighe:"Ú©Ù„ Ù‚Ø·Ø§Ø±ÛŒÚº", pdf_totpezzi:"Ú©Ù„ Ø¢Ø¦Ù¹Ù…Ø²", pdf_generato:"ØªÛŒØ§Ø± Ú©Ø±Ø¯Û"
  }
};
const LS_LANG='poka_lang_v1';
function setLang(l){
  const dict=I18N[l]||I18N['it'];
  document.querySelectorAll('[data-i18n]').forEach(n=> n.textContent=dict[n.dataset.i18n]||n.textContent);
  document.querySelectorAll('[data-i18n-html]').forEach(n=> n.innerHTML=dict[n.dataset.i18nHtml]||n.innerHTML);
  localStorage.setItem(LS_LANG,l);
}
(function initLang(){
  const saved = localStorage.getItem(LS_LANG) || 'it';
  document.getElementById('langSelect').value = saved;
  setLang(saved);
})();
document.getElementById('langSelect').addEventListener('change', e=> setLang(e.target.value));

/* ===== Stato rete (solo badge) ===== */
const netBadge = document.getElementById('netBadge');
function setNetBadge(){
  const on = navigator.onLine;
  netBadge.textContent = on ? 'Online' : 'Offline';
  netBadge.className = on ? 'online' : 'offline';
}
window.addEventListener('online', setNetBadge);
window.addEventListener('offline', setNetBadge);
setNetBadge();

/* ===== Helper generali ===== */
const $ = id => document.getElementById(id);
const tabs = Array.from(document.querySelectorAll('.tab'));
const views = {commessa:$('commessa'), scanner:$('scanner'), righe:$('righe'), impostazioni:$('impostazioni')};
function activateTab(name){
  tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
  Object.entries(views).forEach(([k,el])=> el.classList.toggle('active', k===name));
}
tabs.forEach(t=> t.addEventListener('click', ()=> activateTab(t.dataset.tab)));
$('goScanner').addEventListener('click', ()=> activateTab('scanner'));

/* ===== Stato app ===== */
let expected=null, scanned=null, currentMode=null;
let picks=[]; // {ts, codice, qty, commessa, posizione}
let pendingOK=null;
let confirmBuf=[], lastVal=null;
let lastScanTs=0;

/* ===== Impostazioni (localStorage) ===== */
const LSKEY_SETTINGS='poka_settings_v1';
const LSKEY_FIELDS='poka_fields_v1';
const LSKEY_SAVED_SESSION='poka_saved_session_v1';
const settings={ confirm:true, voice:true, vibrate:true };
function loadSettings(){
  try{ Object.assign(settings, JSON.parse(localStorage.getItem(LSKEY_SETTINGS)||'{}')); }catch{}
  $('optConfirm').value = settings.confirm ? 'on':'off';
  $('optVoice').value = settings.voice ? 'on':'off';
  $('optVibrate').value = settings.vibrate ? 'on':'off';
}
function saveSettings(){ localStorage.setItem(LSKEY_SETTINGS, JSON.stringify(settings)); }
$('optConfirm').addEventListener('change', e=>{ settings.confirm=(e.target.value==='on'); saveSettings(); });
$('optVoice').addEventListener('change', e=>{ settings.voice=(e.target.value==='on'); saveSettings(); });
$('optVibrate').addEventListener('change', e=>{ settings.vibrate=(e.target.value==='on'); saveSettings(); });

/* ===== Campi Commessa/Posizione/Operatore ===== */
function sanitize(s,max=64){return String(s||'').replace(/[^\w\-\. \/]/g,'').slice(0,max)}
function loadFields(){
  try{
    const f = JSON.parse(localStorage.getItem(LSKEY_FIELDS)||'{}');
    $('commessaInput').value = f.commessa||'';
    $('posizioneInput').value = f.posizione||'';
    $('operatoreInput').value = f.operatore||'';
  }catch{}
}
function saveFields(){
  const data = {
    commessa: sanitize($('commessaInput').value,64),
    posizione: sanitize($('posizioneInput').value,64),
    operatore: sanitize($('operatoreInput').value,64)
  };
  localStorage.setItem(LSKEY_FIELDS, JSON.stringify(data));
  showToast('âœ… Salvato','ok',1200);
}
$('saveFields').addEventListener('click', saveFields);

/* ===== Audio/voce/vibrazione ===== */
let actx;
function tone(f=880,d=120,t='sine',v=.25){try{if(!actx)actx=new (window.AudioContext||window.webkitAudioContext)();const o=actx.createOscillator(),g=actx.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(actx.destination);o.start();setTimeout(()=>o.stop(),d);}catch(e){}}
function okSound(){tone(900,120);setTimeout(()=>tone(1200,140),130)}
function errSound(){tone(250,220,'square',.22);setTimeout(()=>tone(180,230,'square',.20),200)}
function speak(msg){ if(!settings.voice) return; try{ const u=new SpeechSynthesisUtterance(msg); u.lang=document.getElementById('langSelect').value.startsWith('pt')?'pt-BR':document.getElementById('langSelect').value; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} }
function vibrate(p){ if(settings.vibrate && navigator.vibrate) navigator.vibrate(p) }

/* ===== UI scanner ===== */
const codesEl = $('codes'), badge=$('badge'), resultText=$('resultText');
function norm(s){return s?String(s).trim().toUpperCase():s}
function box(label,val,cls){
  return `<div class="codeBox ${cls||''}">
    <div class="codeLabel">${label}</div>
    <div class="codeValue ${cls||''}">${val?val:'-'}</div>
  </div>`;
}
function updateUI(){
  const same = expected && scanned && (norm(expected)===norm(scanned));
  const stateClass = same ? 'ok' : (expected && scanned ? 'err' : '');
  codesEl.innerHTML = box(t('lbl_list','LISTA'), expected||'', same?'ok':'') + box(t('lbl_piece','PEZZO'), scanned||'', stateClass);

  if(expected && scanned){
    if(same){
      badge.textContent='âœ… '+t('badge_ok','CORRETTO'); badge.className='badge ok';
      resultText.innerHTML=t('msg_match','Match perfetto!');
      okSound(); speak(t('speak_ok','Codice corretto')); vibrate(60);
      pendingOK = expected;
      openQtyModal(pendingOK);
    }else{
      badge.textContent='âŒ '+t('badge_err','ERRATO'); badge.className='badge err';
      resultText.innerHTML=t('msg_diff','Codice diverso!');
      errSound(); speak(t('speak_err','Errore, codice diverso')); vibrate([60,60,180]);
      pendingOK=null;
    }
  }else{
    badge.textContent=t('badge_ready','Pronto'); badge.className='badge';
    resultText.innerHTML=t('hint_scan_html','Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b>');
  }
}
function t(key, fallback){ // piccole stringhe runtime non nel dizionario full
  const map = {
    'lbl_list': {'it':'LISTA','pt-BR':'LISTA','en':'LIST','ur':'Ù„Ø³Ù¹'},
    'lbl_piece': {'it':'PEZZO','pt-BR':'PEÃ‡A','en':'ITEM','ur':'Ù¾ÛŒÙØ³'},
    'badge_ok': {'it':'CORRETTO','pt-BR':'CERTO','en':'CORRECT','ur':'Ø¯Ø±Ø³Øª'},
    'badge_err': {'it':'ERRATO','pt-BR':'ERRADO','en':'WRONG','ur':'ØºÙ„Ø·'},
    'msg_match': {'it':'Match perfetto!','pt-BR':'CombinaÃ§Ã£o perfeita!','en':'Perfect match!','ur':'Ù…Ú©Ù…Ù„ Ù…ÛŒÚ†!'},
    'msg_diff': {'it':'Codice diverso!','pt-BR':'CÃ³digo diferente!','en':'Different code!','ur':'Ú©ÙˆÚˆ Ù…Ø®ØªÙ„Ù!'},
    'speak_ok': {'it':'Codice corretto','pt-BR':'CÃ³digo correto','en':'Code correct','ur':'Ú©ÙˆÚˆ Ø¯Ø±Ø³Øª'},
    'speak_err': {'it':'Errore, codice diverso','pt-BR':'Erro, cÃ³digo diferente','en':'Error, different code','ur':'ØºÙ„Ø·ÛŒØŒ Ù…Ø®ØªÙ„Ù Ú©ÙˆÚˆ'},
    'hint_scan_html': {'it':'Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b>','pt-BR':'Leia primeiro a <b>LISTA</b>, depois a <b>PEÃ‡A</b>','en':'Scan the <b>LIST</b> first, then the <b>ITEM</b>','ur':'Ù¾ÛÙ„Û’ <b>Ù„Ø³Ù¹</b> Ø§Ø³Ú©ÛŒÙ† Ú©Ø±ÛŒÚºØŒ Ù¾Ú¾Ø± <b>Ù¾ÛŒÙØ³</b>'}
  };
  const lang = localStorage.getItem(LS_LANG)||'it';
  return (map[key] && map[key][lang]) || fallback || key;
}

/* ===== Toast ===== */
const toast=$('toast'); let toastTimer=null;
function showToast(text,kind='ok',ms=1800){
  toast.textContent=text; toast.className=''; toast.classList.add(kind); toast.style.display='block';
  clearTimeout(toastTimer); toastTimer=setTimeout(()=> toast.style.display='none', ms);
}

/* ===== Tab Righe ===== */
function renderRighe(){
  const tb=$('righeBody');
  tb.innerHTML = picks.map(p=>{
    const hh=p.ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    return `<tr><td>${hh}</td><td>${p.codice}</td><td>${p.qty}</td><td>${p.commessa||'-'}</td><td>${p.posizione||'-'}</td></tr>`;
  }).join('');
  const has = picks.length>0;
  $('scaricaCSV').disabled = !has;
  $('scaricaPDF').disabled = !has;
  $('svuota').disabled = !has;
  $('saveSession').disabled = !has;
  $('countPill').textContent = String(picks.length);
  updateBeforeUnloadGuard();
}
function toCSV(){
  const head='timestamp_ms,iso,codice,quantita,commessa,posizione\n';
  const body=picks.map(p=>{
    return [p.ts.getTime(), p.ts.toISOString(), p.codice, p.qty, p.commessa||'', p.posizione||'']
      .map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
  }).join('\n');
  return head+body;
}
$('scaricaCSV').addEventListener('click', ()=>{
  if(!picks.length) return;
  const csv=toCSV();
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const fname = `scheda_picking_${($('commessaInput').value||'commessa')}_${($('operatoreInput').value||'op')}.csv`;
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=fname; a.click();
  URL.revokeObjectURL(url);
});

/* ===== Salvataggio manuale sessione & ripristino ===== */
function saveSessionManual(){
  if(!picks.length) return;
  const pack = {
    when: Date.now(),
    fields: {
      commessa: sanitize($('commessaInput').value,64),
      posizione: sanitize($('posizioneInput').value,64),
      operatore: sanitize($('operatoreInput').value,64)
    },
    rows: picks.map(p=>({ts:p.ts.getTime(), codice:p.codice, qty:p.qty, commessa:p.commessa, posizione:p.posizione}))
  };
  localStorage.setItem(LSKEY_SAVED_SESSION, JSON.stringify(pack));
  showToast('ğŸ’¾ Sessione salvata','ok',1400);
  updateBeforeUnloadGuard(); // ora non serve piÃ¹ bloccare se lâ€™utente ha deciso di salvare
}
$('saveSession').addEventListener('click', saveSessionManual);

function checkSavedSessionBanner(){
  const raw = localStorage.getItem(LSKEY_SAVED_SESSION);
  $('restoreBox').style.display = raw ? 'block' : 'none';
  if(raw){
    try{
      const s = JSON.parse(raw);
      const d = new Date(s.when);
      $('restoreInfo').textContent = `Sessione salvata il ${d.toLocaleString()} â€” ${s.rows?.length||0} righe.`;
    }catch{ $('restoreInfo').textContent = 'Sessione salvata trovata.'; }
  }
}
$('restoreSession').addEventListener('click', ()=>{
  try{
    const s = JSON.parse(localStorage.getItem(LSKEY_SAVED_SESSION)||'{}');
    if(!s.rows) return;
    $('commessaInput').value = s.fields?.commessa || '';
    $('posizioneInput').value = s.fields?.posizione || '';
    $('operatoreInput').value = s.fields?.operatore || '';
    saveFields();
    picks = s.rows.map(r=>({ts:new Date(r.ts), codice:r.codice, qty:r.qty, commessa:r.commessa, posizione:r.posizione}));
    renderRighe();
    activateTab('righe');
    showToast('ğŸ“‚ Ripristinata','ok',1400);
  }catch{}
});
$('deleteSaved').addEventListener('click', ()=>{
  localStorage.removeItem(LSKEY_SAVED_SESSION);
  checkSavedSessionBanner();
  showToast('Eliminata salvata','err',1200);
});

/* ===== PDF moderno (jsPDF + autoTable) ===== */
$('scaricaPDF').addEventListener('click', ()=>{
  if(!picks.length) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' }); // 72pt/in

  const dict = I18N[localStorage.getItem(LS_LANG)||'it'];
  const title = dict.pdf_title || 'Scheda Picking';
  const F = { h1:18, h2:12, small:10 };

  // Header barra scura
  doc.setFillColor(11,19,37); // #0b1325
  doc.rect(0,0,595,70,'F');
  doc.setTextColor(233,242,255); // chiaro
  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text(title, 40, 40);

  // Meta info box
  const op = $('operatoreInput').value || '-';
  const cm = $('commessaInput').value || '-';
  const ps = $('posizioneInput').value || '-';
  const now = new Date();
  const metaY = 88;
  doc.setFont('helvetica','bold'); doc.setFontSize(F.h2); doc.setTextColor(230,237,247);
  doc.text(`${dict.pdf_operatore||'Operatore'}:`, 40, metaY);
  doc.text(`${dict.pdf_commessa||'Commessa'}:`, 40, metaY+18);
  doc.text(`${dict.pdf_posizione||'Posizione'}:`,40, metaY+36);
  doc.text(`${dict.pdf_data||'Data'}:`,      340, metaY);

  doc.setFont('helvetica','normal'); doc.setTextColor(255,255,255);
  doc.text(op, 140, metaY);
  doc.text(cm, 140, metaY+18);
  doc.text(ps, 140, metaY+36);
  doc.text(now.toLocaleString(), 400, metaY);

  // Tabella
  const body = picks.map(p=>{
    const hh=p.ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    return [hh, p.codice, String(p.qty)];
  });

  doc.autoTable({
    startY: metaY+54,
    head: [[dict.pdf_ora||'Ora', dict.pdf_codice||'Codice', dict.pdf_qta||'Q.tÃ ']],
    body,
    styles: { font:'helvetica', fontSize:11, textColor:[230,237,247], fillColor:[13,24,47], cellPadding:6 },
    headStyles: { fillColor:[8,20,44], textColor:[233,242,255], fontStyle:'bold', halign:'left' },
    alternateRowStyles: { fillColor:[15,29,52] },
    columnStyles: {
      0:{ cellWidth:80 },
      1:{ cellWidth:360 },
      2:{ cellWidth:70, halign:'right' }
    },
    margin:{ left:40, right:40 }
  });

  // Totali
  const totRows = picks.length;
  const totPezzi = picks.reduce((a,b)=>a + Number(b.qty||0), 0);
  const endY = doc.autoTable.previous.finalY + 14;

  doc.setFillColor(8,20,44);
  doc.roundedRect(40, endY, 515, 40, 6, 6, 'F');
  doc.setTextColor(233,242,255); doc.setFont('helvetica','bold');
  doc.text(`${dict.pdf_totrighe||'Righe totali'}: ${totRows}`, 54, endY+26);
  doc.text(`${dict.pdf_totpezzi||'Pezzi totali'}: ${totPezzi}`, 260, endY+26);

  // Footer generato
  const footY = endY+70;
  doc.setFont('helvetica','normal'); doc.setFontSize(F.small); doc.setTextColor(183,198,220);
  doc.text(`${dict.pdf_generato||'Generato'}: ${now.toLocaleString()}`, 40, footY);

  const fname = `scheda_picking_${cm}_${op}.pdf`.replace(/\s+/g,'_');
  doc.save(fname);
});

/* ===== Modale quantitÃ  ===== */
const qtyModal=$('qtyModal'), qtyInput=$('qtyInput'), qtyMinus=$('qtyMinus'), qtyPlus=$('qtyPlus'), qtyOk=$('qtyOk'), qtyCancel=$('qtyCancel'), qtyInfo=$('qtyInfo');
function openQtyModal(code){
  qtyInfo.textContent = `${t('lbl_piece','Pezzo')}: ${code}`;
  qtyInput.value=''; // vuoto come richiesto
  qtyModal.style.display='flex';
  setTimeout(()=>qtyInput.focus(),50);
}
function closeQtyModal(){ qtyModal.style.display='none'; }
qtyMinus.onclick=()=>{ const n=parseInt(qtyInput.value||'0',10)||0; qtyInput.value = Math.max(1, n-1); };
qtyPlus.onclick =()=>{ const n=parseInt(qtyInput.value||'0',10)||0; qtyInput.value = Math.max(1, n+1); };
qtyCancel.onclick=()=>{ closeQtyModal(); };
qtyOk.onclick=()=>{
  let q = parseInt(qtyInput.value||'0',10);
  if(!q || q<1){ qtyInput.focus(); return; }
  if(!pendingOK){ closeQtyModal(); return; }
  const ts=new Date();
  const cm=sanitize($('commessaInput').value,64), ps=sanitize($('posizioneInput').value,64);
  picks.push({ts, codice: sanitize(pendingOK,128), qty:q, commessa:cm, posizione:ps});
  renderRighe(); showToast(I18N[localStorage.getItem(LS_LANG)||'it'].toast_riga_ok || 'Riga aggiunta','ok',1400);
  pendingOK=null; scanned=null; updateUI(); closeQtyModal();
};

/* ===== Reset ===== */
$('reset').addEventListener('click', ()=>{ expected=null; scanned=null; pendingOK=null; updateUI(); });

/* ===== Camera fullscreen (BarcodeDetector â‡’ ZXing) ===== */
const camFS=$('camFS'), camClose=$('camClose'), video=$('video'), overlay=$('overlay'), guide=$('guide'), laser=$('laser');
let stream=null, track=null;

camClose.addEventListener('click', stopCameraFS);
$('scanList').addEventListener('click', ()=>startScanFS('list'));
$('scanItem').addEventListener('click', ()=>startScanFS('item'));

function canAccept(){
  const now=performance.now();
  if(now-lastScanTs<600) return false;
  lastScanTs=now; return true;
}
async function startScanFS(which){
  activateTab('scanner');
  const cm=sanitize($('commessaInput').value,64), ps=sanitize($('posizioneInput').value,64);
  if(!cm || !ps){ alert('Inserisci Numero commessa e Posizione prima di scansionare.'); return; }

  currentMode=which;
  camFS.classList.add('active');
  try{ await startDetectorHybrid(); }
  catch(e){ await startZXingHybrid(); }
}
function stopCameraFS(){
  try{
    if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
    if(track) track.stop();
  }catch(e){}
  stream=null; track=null; camFS.classList.remove('active');
}

async function startDetectorHybrid(){
  const constraints={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720},focusMode:"continuous"}};
  const chosen=$('cameraSelect').value; if(chosen) constraints.video.deviceId={exact:chosen};

  stream=await navigator.mediaDevices.getUserMedia(constraints);
  track=stream.getVideoTracks()[0]; video.srcObject=stream; await video.play();

  const detector=new BarcodeDetector({formats:['qr_code','code_128','ean_13','ean_8','upc_a','code_39']});
  const ctx=overlay.getContext('2d');

  const loop=()=>{
    if(!stream){return;}
    if(video.readyState<2){ requestAnimationFrame(loop); return; }
    overlay.width=video.videoWidth; overlay.height=video.videoHeight; ctx.clearRect(0,0,overlay.width,overlay.height);

    detector.detect(video).then(codes=>{
      const g=guide.getBoundingClientRect(), v=video.getBoundingClientRect();
      const gx=g.left-v.left, gy=g.top-v.top, gw=g.width, gh=g.height;
      const sx=overlay.width/v.width, sy=overlay.height/v.height;

      let accepted=null;
      for(const c of codes){
        const r=c.boundingBox; const cx=r.x+r.width/2, cy=r.y+r.height/2;
        const domX=cx/sx, domY=cy/sy;
        const inGuide=(domX>=gx&&domX<=gx+gw&&domY>=gy&&domY<=gy+gh);
        const g2=laser.getBoundingClientRect();
        const lx=g2.left-v.left+g2.width/2, ly=g2.top-v.top+g2.height/2;
        const dist=Math.sqrt((domX-lx)**2+(domY-ly)**2);
        const radius=g2.width/2;
        if(inGuide && dist<radius){ accepted=c.rawValue; break; }
      }

      if(accepted && canAccept()){
        if(settings.confirm){
          if(lastVal===accepted){ confirmBuf.push(accepted); } else { confirmBuf=[accepted]; lastVal=accepted; }
          if(confirmBuf.length>=2){ processScan(accepted); return; }
        } else { processScan(accepted); return; }
      }
      requestAnimationFrame(loop);
    }).catch(()=>requestAnimationFrame(loop));
  };
  loop();
}
async function startZXingHybrid(){
  const constraints={video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}}};
  const chosen=$('cameraSelect').value; if(chosen) constraints.video.deviceId={ exact: chosen };

  stream=await navigator.mediaDevices.getUserMedia(constraints);
  track=stream.getVideoTracks()[0];

  const formats=[ZXing.BarcodeFormat.QR_CODE,ZXing.BarcodeFormat.CODE_128,ZXing.BarcodeFormat.EAN_13,ZXing.BarcodeFormat.UPC_A,ZXing.BarcodeFormat.CODE_39];
  const hints=new Map(); hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,formats);
  const reader=new ZXing.BrowserMultiFormatReader(hints);

  video.srcObject=stream; await video.play();

  const loop=async()=>{
    try{
      const res=await reader.decodeFromVideoElement(video);
      if(res && canAccept()){
        if(pointInGuideZXing(res,video)){ processScan(res.text); return; }
      }
    }catch(e){}
    requestAnimationFrame(loop);
  };
  loop();
}
function pointInGuideZXing(result,vidEl){
  try{
    const pts=result.resultPoints||[]; if(pts.length===0) return true;
    let cx=0,cy=0; for(const p of pts){ cx+=p.x; cy+=p.y; } cx/=pts.length; cy/=pts.length;

    const vrect=vidEl.getBoundingClientRect();
    const vw=vidEl.videoWidth, vh=vidEl.videoHeight;
    const scale=Math.min(vrect.width/vw, vrect.height/vh);
    const dispW=vw*scale, dispH=vh*scale;
    const offX=(vrect.width-dispW)/2, offY=(vrect.height-dispH)/2;

    const domX=offX+cx*scale, domY=offY+cy*scale;
    const g2=laser.getBoundingClientRect();
    const lx=g2.left-vrect.left+g2.width/2, ly=g2.top-vrect.top+g2.height/2;
    const dist=Math.sqrt((domX-lx)**2+(domY-ly)**2);
    return (dist < g2.width/2);
  }catch(e){ return true; }
}

/* Gestione lettura singola */
function processScan(text){
  const val = sanitize(text,128);
  if(currentMode==='list'){ expected=val; } else { scanned=val; }
  stopCameraFS(); // chiudi camera ma resta nella tab Scanner
  updateUI();
}

/* ===== Camera select ===== */
async function populateCameras(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const vids = devices.filter(d=>d.kind==='videoinput');
    $('cameraSelect').innerHTML = '<option value="">(automatica)</option>' +
      vids.map(v=>`<option value="${v.deviceId}">${v.label||'Fotocamera'}</option>`).join('');
  }catch(_){}
}
if(navigator.mediaDevices?.enumerateDevices){ populateCameras(); }

/* ===== Beforeunload guard (conferma refresh/chiudi) ===== */
let allowUnload = false; // diventa true se non abbiamo righe o se lâ€™utente ha salvato sessione
function updateBeforeUnloadGuard(){
  allowUnload = picks.length===0; // se non ci sono righe, ok; se ci sono, blocca
}
window.addEventListener('beforeunload', (e)=>{
  // Se ci sono righe non salvate in una sessione volontariamente salvata, potresti voler non bloccare.
  // Ma richiesta dell'utente: NO autosave. Quindi blocchiamo finchÃ© ci sono righe a schermo.
  if(!allowUnload && picks.length>0){
    e.preventDefault(); e.returnValue='';
  }
});

/* ===== Svuota ===== */
$('svuota').addEventListener('click', ()=>{
  if(!picks.length) return;
  if(confirm('Sicuro di svuotare la sessione corrente?')){
    picks=[]; renderRighe(); updateUI(); showToast('Sessione svuotata','err',1200);
  }
});

/* ===== CSV/PDF abilitazione giÃ  gestita in renderRighe ===== */

/* ===== Avvio ===== */
loadSettings();
loadFields();
renderRighe();
checkSavedSessionBanner();
updateUI();
</script>
</body>
</html>