<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Poka-Yoke PRO ‚Ä¢ Scanner IBRIDO</title>
<style>
  :root{
    --ok:#22c55e;          /* verde acceso */
    --err:#ef4444;         /* rosso acceso */
    --panel:#171f2e;       /* antracite leggibile */
    --panel-border:#2a3650;
    --fg:#f3f4f6;
    --muted:#9ca3af;
    --ink:#e5e7eb;
    --ink-soft:#cbd5e1;
    --ink-dim:#94a3b8;
    --bg:#0b1220;
    --brand:#1e293b;
  }
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{min-height:100%;display:flex;flex-direction:column}
  header{padding:10px 14px;background:#0a0f1d;border-bottom:1px solid #1f2937}
  .topbar{display:flex;gap:10px;align-items:center}
  .brand{font-weight:900;letter-spacing:.3px}
  nav.tabs{margin-left:12px;display:flex;gap:10px}
  .tabBtn{background:#101827;border:1px solid #22304a;color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:800}
  .tabBtn.active{background:#1f2a44}
  .spacer{flex:1}
  #netBadge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #334155}
  #netBadge.online{background:rgba(22,163,74,.12);color:#86efac;border-color:#14532d}
  #netBadge.offline{background:rgba(239,68,68,.12);color:#fecaca;border-color:#7f1d1d}
  #btnSettings{margin-left:10px;background:#101827;border:1px solid #22304a;color:#fff;padding:10px;border-radius:12px}

  main{flex:1;display:flex;flex-direction:column;gap:12px;padding:12px}

  .panel{
    background:var(--panel);
    border:1px solid var(--panel-border);
    border-radius:14px;
    padding:14px;
    box-shadow:0 6px 20px rgba(0,0,0,.25);
  }
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{flex:1 1 160px;padding:12px 14px;border-radius:12px;border:1px solid #243045;background:#111827;color:#fff;font-size:16px;font-weight:800}
  .btn:active{transform:scale(.98)}
  .btn-blue{background:#1e293b;border-color:#334155}
  .btn-green{background:#14532d;border-color:#14532d}
  .btn-outline{background:#0b1220;border-color:#334155}
  .small{font-size:12px;color:var(--ink-dim)}
  .input,select{background:#0b1220;border:1px solid #243045;border-radius:12px;color:var(--ink);padding:12px 14px;font-size:16px;flex:1 1 220px}
  .input::placeholder{color:#64748b}
  label.field{display:flex;flex-direction:column;gap:6px;flex:1 1 220px}
  label.field span{font-size:12px;color:var(--ink-dim);font-weight:700}

  /* Stato & Codici */
  .status{display:flex;flex-direction:column;gap:8px;align-items:center;text-align:center}
  .badge{display:inline-block;padding:6px 12px;border-radius:999px;border:1px solid #374151;font-weight:900}
  .badge.ok{background:rgba(34,197,94,.15);color:#86efac;border-color:#14532d}
  .badge.err{background:rgba(239,68,68,.15);color:#fecaca;border-color:#7f1d1d}
  #resultText{font-size:20px;margin:4px 0 2px}
  #codes{display:flex;flex-direction:column;gap:10px;align-items:stretch;margin-top:4px}
  .codeBox{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:12px 14px;border-radius:12px;
    border:2px solid #334155;
    background:#0f172a;
  }
  .codeLabel{font-size:14px;color:#9ca3af;font-weight:800}
  .codeValue{flex:1;text-align:right;font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:900;letter-spacing:.5px;font-size:clamp(22px,3.8vh,40px);color:var(--fg);word-break:break-all}
  .codeBox.ok{border-color:#14532d;background:rgba(34,197,94,.12);box-shadow:0 0 0 2px rgba(34,197,94,.15) inset}
  .codeBox.err{border-color:#7f1d1d;background:rgba(239,68,68,.10);box-shadow:0 0 0 2px rgba(239,68,68,.15) inset}
  .codeValue.ok{color:#86efac}
  .codeValue.err{color:#fecaca}

  /* Camera */
  #cameraArea{display:none}
  #preview{position:relative;width:100%;max-width:820px;height:66vh;margin:auto;border-radius:12px;overflow:hidden;background:#000}
  #video{position:absolute;inset:0;object-fit:cover;width:100%;height:100%}
  #overlay{position:absolute;inset:0;pointer-events:none}
  #guide{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:34%;height:34%;border:3px solid rgba(255,255,255,.95);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,.45) inset;pointer-events:none}
  #laser{position:absolute;left:50%;top:50%;width:56px;height:56px;border:2px solid rgba(255,60,60,.9);border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 12px rgba(255,60,60,.9);pointer-events:none}
  #flash{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .18s}

  /* Tab sections */
  .view{display:none}
  .view.active{display:block}

  /* Tab righe raccolte */
  #righeBox{max-height:48vh;overflow:auto;border:1px solid #1f2937;border-radius:12px}
  .tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{padding:10px 12px;border-bottom:1px solid #1f2937;font-size:14px}
  .tbl th{position:sticky;top:0;background:#0a0f1d;text-align:left;font-weight:900}

  /* Modal quantit√† */
  #qtyModal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999}
  .modalCard{background:#0b1220;border:1px solid #334155;border-radius:16px;padding:16px;min-width:280px;max-width:90vw;box-shadow:0 10px 30px rgba(0,0,0,.6)}
  .modalTitle{font-weight:900;margin-bottom:8px}
  .qtyRow{display:flex;gap:10px;align-items:center;justify-content:center;margin:12px 0}
  .qtyBtn{padding:10px 14px;border-radius:10px;border:1px solid #334155;background:#111827;color:#fff;font-weight:900;font-size:20px}
  .qtyInput{width:120px;text-align:center;font-size:22px;font-weight:900;padding:8px 10px;border-radius:10px;border:1px solid #334155;background:#0a0f1d;color:#fff}
  .modalActions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}

  /* Settings modal */
  #settings{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
  .setCard{background:#0b1220;border:1px solid #334155;border-radius:16px;padding:16px;min-width:280px;max-width:92vw}
  .setRow{display:flex;align-items:center;justify-content:space-between;gap:14px;margin:10px 0}
</style>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>
</head>
<body>
<div class="wrap">
  <header>
    <div class="topbar">
      <div class="brand">Poka-Yoke PRO</div>
      <nav class="tabs">
        <button class="tabBtn active" data-tab="commessa">Commessa</button>
        <button class="tabBtn" data-tab="scanner">Scanner</button>
        <button class="tabBtn" data-tab="righe">Righe raccolte</button>
      </nav>
      <div class="spacer"></div>
      <span id="netBadge" class="offline">Offline</span>
      <button id="btnSettings" title="Impostazioni">‚öôÔ∏è</button>
    </div>
  </header>

  <main>
    <!-- TAB 1: COMMESSA -->
    <section id="view-commessa" class="view active">
      <div class="panel">
        <div class="row">
          <label class="field">
            <span>Numero commessa</span>
            <input id="commessa" class="input" placeholder="Es. 024830" autocomplete="off"/>
          </label>
          <label class="field">
            <span>Posizione</span>
            <input id="posizione" class="input" placeholder="Es. POS 0020" autocomplete="off"/>
          </label>
        </div>
        <div class="small" style="margin-top:6px">Compila <b>commessa</b> e <b>posizione</b> e poi vai su <b>Scanner</b>.</div>
      </div>
    </section>

    <!-- TAB 2: SCANNER -->
    <section id="view-scanner" class="view">
      <div class="panel status">
        <div id="badge" class="badge">Pronto</div>
        <div id="resultText">Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b></div>
        <div id="codes"></div>
        <div class="small">Allinea il codice nel <b>quadrato</b> e centra nel cerchio rosso üî¥.</div>
      </div>

      <div class="panel">
        <div class="row" style="justify-content:center">
          <button id="scanList" class="btn">üìã LISTA</button>
          <button id="scanItem" class="btn">üì¶ PEZZO</button>
          <button id="reset" class="btn btn-outline" style="flex:0 0 180px">üîÑ Reset</button>
        </div>
      </div>

      <div id="cameraArea" class="panel">
        <div id="preview">
          <video id="video" muted playsinline></video>
          <canvas id="overlay"></canvas>
          <div id="guide"></div>
          <div id="laser"></div>
        </div>
        <div class="small" style="text-align:center;margin-top:6px">Per migliorare la lettura tieni fermo il codice al centro.</div>
      </div>
    </section>

    <!-- TAB 3: RIGHE RACCOLTE -->
    <section id="view-righe" class="view">
      <div class="panel">
        <div class="row" style="align-items:center;justify-content:space-between">
          <div class="small">Righe raccolte (salvate in locale)</div>
          <div class="row" style="gap:8px;flex:0 0 auto">
            <button id="scaricaCSV" class="btn btn-blue" disabled>‚¨áÔ∏è Scarica CSV</button>
            <button id="svuota" class="btn btn-outline" disabled>üóëÔ∏è Svuota</button>
          </div>
        </div>
        <div id="righeBox" style="margin-top:8px">
          <table class="tbl" id="righeTbl">
            <thead><tr><th>Ora</th><th>Codice</th><th>Q.t√†</th><th>Commessa</th><th>Posizione</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- MODALS -->
<div id="qtyModal">
  <div class="modalCard">
    <div class="modalTitle">Inserisci quantit√† prelevata</div>
    <div id="qtyInfo" class="small" style="margin-bottom:6px;color:#cbd5e1"></div>
    <div class="qtyRow">
      <button id="qtyMinus" class="qtyBtn">‚àí</button>
      <input id="qtyInput" class="qtyInput" type="number" min="1" step="1" value="1" />
      <button id="qtyPlus" class="qtyBtn">+</button>
    </div>
    <div class="modalActions">
      <button id="qtyCancel" class="btn btn-outline">Annulla</button>
      <button id="qtyOk" class="btn btn-green">Conferma</button>
    </div>
  </div>
</div>

<div id="settings">
  <div class="setCard">
    <h3 style="margin:0 0 6px 0">Impostazioni</h3>
    <div class="setRow">
      <div>Conferma doppia (anti false letture)</div>
      <label><input type="checkbox" id="confirm2" checked> Attiva</label>
    </div>
    <div class="setRow">
      <div>Annuncio vocale</div>
      <label><input type="checkbox" id="voice" checked> Attiva</label>
    </div>
    <div class="setRow" style="justify-content:flex-end">
      <button id="closeSettings" class="btn btn-blue" style="flex:0 0 auto">Chiudi</button>
    </div>
  </div>
</div>

<div id="flash"></div>

<script>
/* ===== rete (badge semplice locale/online) ===== */
const netBadge = document.getElementById('netBadge');
const setNetBadge = () => {
  const on = navigator.onLine;
  netBadge.textContent = on ? 'Online' : 'Offline';
  netBadge.className = on ? 'online' : 'offline';
};
addEventListener('online', setNetBadge);
addEventListener('offline', setNetBadge);
setNetBadge();

/* ===== tabs ===== */
const views = {
  commessa: document.getElementById('view-commessa'),
  scanner: document.getElementById('view-scanner'),
  righe: document.getElementById('view-righe')
};
function setTab(name){
  document.querySelectorAll('.tabBtn').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
  Object.entries(views).forEach(([k,el])=>el.classList.toggle('active', k===name));
}
document.querySelectorAll('.tabBtn').forEach(b=>b.onclick=()=>setTab(b.dataset.tab));
/* apertura impostazioni */
document.getElementById('btnSettings').onclick = ()=>{ document.getElementById('settings').style.display='flex'; };
document.getElementById('closeSettings').onclick = ()=>{ document.getElementById('settings').style.display='none'; };

/* ===== stato app ===== */
document.addEventListener('click',()=>{speechSynthesis.getVoices();},{once:true});
let expected=null, scanned=null, mode=null, stream, track, confirmBuf=[], lastVal=null;
let picks=[]; // {ts, codice, qty, commessa, posizione}
let pendingOK=null;
let lastScanTs=0;
let cameraIdleTimer=null;
let playedOKOnce = false;   // evita suono/voce ripetuti finch√© non si conferma la quantit√†

/* ===== elementi ===== */
const el=id=>document.getElementById(id);
const video=el('video'), overlay=el('overlay'), guide=el('guide'), laser=el('laser');
const badge=el('badge'), resultText=el('resultText'), codes=el('codes');
const cameraArea=el('cameraArea'), flash=el('flash');
const commessa=el('commessa'), posizione=el('posizione');
const qtyModal=el('qtyModal'), qtyInput=el('qtyInput'), qtyMinus=el('qtyMinus'), qtyPlus=el('qtyPlus'), qtyOk=el('qtyOk'), qtyCancel=el('qtyCancel'), qtyInfo=el('qtyInfo');
const scaricaCSV=el('scaricaCSV'), svuota=el('svuota');

/* ===== audio/voce ===== */
let actx;
function tone(f=880,d=150,t='sine',v=.25){try{if(!actx)actx=new (window.AudioContext||window.webkitAudioContext)();const o=actx.createOscillator(),g=actx.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(actx.destination);o.start();setTimeout(()=>o.stop(),d);}catch(e){}}
function okSound(){tone(900,120);setTimeout(()=>tone(1200,140),130)}
function errSound(){tone(250,240,'square',.22);setTimeout(()=>tone(180,250,'square',.20),220)}
function speak(msg,rate=1,pitch=1,vol=1){if(!el('voice').checked)return;try{const u=new SpeechSynthesisUtterance(msg);u.lang='it-IT';u.volume=vol;u.rate=rate;u.pitch=pitch;const v=speechSynthesis.getVoices().find(x=>x.lang.startsWith('it'));if(v)u.voice=v;speechSynthesis.cancel();speechSynthesis.speak(u);}catch(e){}}
function vibrate(p){if(navigator.vibrate)navigator.vibrate(p)}
function flashScreen(c){flash.style.background=c;flash.style.opacity=.6;setTimeout(()=>flash.style.opacity=0,160)}
function setBadge(t,cls){badge.textContent=t;badge.className='badge '+(cls==='ok'?'ok':cls==='err'?'err':'')}
function norm(s){return s?String(s).trim().toUpperCase():s}
function sanitize(s,max=64){return String(s||'').replace(/[^\w\-\. \/]/g,'').slice(0,max)}
function resetConfirm(){confirmBuf=[];lastVal=null;}

/* ===== UI codici e feedback ===== */
function updateUI(){
  const same = expected && scanned && (norm(expected) === norm(scanned));
  const stateClass = same ? 'ok' : (expected && scanned ? 'err' : '');

  const box = (label, val, cls) => `
    <div class="codeBox ${cls||''}">
      <div class="codeLabel">${label}</div>
      <div class="codeValue ${cls||''}">${val ? val : '-'}</div>
    </div>`;

  codes.innerHTML =
    box('LISTA', expected || '', same ? 'ok' : '') +
    box('PEZZO',  scanned  || '', stateClass);

  if (expected && scanned){
    if (same){
      setBadge('‚úÖ CORRETTO','ok');
      resultText.innerHTML = 'Match perfetto!';
      if(!playedOKOnce){
        flashScreen('rgba(34,197,94,.45)');
        okSound(); speak("Codice corretto",1,1.05,1); vibrate(60);
        playedOKOnce = true;
      }
      pendingOK = expected;
      openQtyModal(pendingOK);
    } else {
      setBadge('‚ùå ERRATO','err');
      resultText.innerHTML = 'Codice diverso!';
      flashScreen('rgba(239,68,68,.55)'); errSound(); speak("Errore, codice diverso",0.95,0.9,1); vibrate([60,60,180]);
      pendingOK = null;
      playedOKOnce = false;
    }
  } else {
    setBadge('Pronto');
    resultText.innerHTML = 'Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b>';
  }
}

/* ===== Modal quantit√† ===== */
function openQtyModal(code){
  qtyInfo.innerHTML = `Codice: <b>${code}</b>`;
  qtyInput.value = '1';
  qtyModal.style.display = 'flex';
  setTimeout(()=>qtyInput.focus(),50);
}
function closeQtyModal(){ qtyModal.style.display='none'; }
qtyMinus.onclick = ()=>{ const v=Math.max(1, parseInt(qtyInput.value||'1',10)-1); qtyInput.value=v; };
qtyPlus.onclick  = ()=>{ const v=Math.max(1, parseInt(qtyInput.value||'1',10)+1); qtyInput.value=v; };
qtyCancel.onclick= ()=>{ closeQtyModal(); playedOKOnce=false; };
qtyOk.onclick    = ()=>{
  const qty = Math.max(1, parseInt(qtyInput.value||'1',10));
  if(!pendingOK){ closeQtyModal(); playedOKOnce=false; return; }
  const ts = new Date();
  picks.push({
    ts,
    codice: sanitize(pendingOK,128),
    qty,
    commessa: sanitize(commessa.value,64),
    posizione: sanitize(posizione.value,64)
  });
  renderPicks();
  pendingOK = null;
  scanned = null;
  closeQtyModal();
  playedOKOnce = false;
  updateUI();
};

/* ===== tabella righe ===== */
function renderPicks(){
  const tb = document.querySelector('#righeTbl tbody');
  tb.innerHTML = picks.map(p=>{
    const hh = p.ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    return `<tr><td>${hh}</td><td>${p.codice}</td><td>${p.qty}</td><td>${p.commessa||'-'}</td><td>${p.posizione||'-'}</td></tr>`;
  }).join('');
  const has=picks.length>0;
  scaricaCSV.disabled=!has; svuota.disabled=!has;
}
function toCSV(){
  const head='timestamp_ms,iso,codice,quantita,commessa,posizione\n';
  const body=picks.map(p=>[p.ts.getTime(),p.ts.toISOString(),p.codice,p.qty,p.commessa||'',p.posizione||'']
    .map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  return head+body;
}
function downloadCSV(){
  if(!picks.length) return;
  const csv=toCSV(); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download=`scheda_picking_${(commessa.value||'commessa')}.csv`; a.click(); URL.revokeObjectURL(url);
}
function clearAll(){
  if(!picks.length) return; if(!confirm('Sicuro di svuotare la sessione corrente?')) return;
  picks=[]; renderPicks(); updateUI();
}
scaricaCSV.onclick=downloadCSV; svuota.onclick=clearAll;

/* ===== comandi scanner ===== */
el('scanList').onclick=()=>startScan('list');
el('scanItem').onclick=()=>startScan('item');
el('reset').onclick=()=>{expected=null;scanned=null;pendingOK=null;playedOKOnce=false;updateUI();};

function canAccept(){
  const now=performance.now(); if(now-lastScanTs<600) return false; lastScanTs=now; return true;
}

/* ===== apre camera ===== */
async function startScan(which){
  // restiamo sempre nella tab scanner
  setTab('scanner');

  const cm = sanitize(commessa.value,64), ps = sanitize(posizione.value,64);
  if(!cm || !ps){ alert('Inserisci Numero commessa e Posizione prima di scansionare.'); return; }
  commessa.value=cm; posizione.value=ps;

  mode=which; cameraArea.style.display='block'; resetConfirm(); playedOKOnce=false;

  // prova full screen
  try{
    const pr= document.documentElement.requestFullscreen?.() || document.body.requestFullscreen?.();
    await pr;
  }catch(_){/* ignorato */ }

  clearTimeout(cameraIdleTimer);
  cameraIdleTimer = setTimeout(()=>{ stopStream(); cameraArea.style.display='none'; }, 60_000);

  if('BarcodeDetector' in window){
    try{ await startDetectorHybrid(); return; }
    catch(e){}
  }
  await startZXingHybrid();
}

/* ===== detector nativo ===== */
async function startDetectorHybrid(){
  const constraints={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720},focusMode:"continuous"}};
  stream=await navigator.mediaDevices.getUserMedia(constraints).catch(()=>null);
  if(!stream){ alert('Fotocamera non disponibile o permesso negato.'); cameraArea.style.display='none'; return; }
  track=stream.getVideoTracks()[0]; video.srcObject=stream; await video.play();

  const detector=new BarcodeDetector({formats:['qr_code','code_128','ean_13','ean_8','upc_a','code_39']});
  const ctx=overlay.getContext('2d');

  const loop=()=>{
    if(!stream){return;}
    if(video.readyState<2){ requestAnimationFrame(loop); return; }
    overlay.width=video.videoWidth; overlay.height=video.videoHeight; ctx.clearRect(0,0,overlay.width,overlay.height);

    detector.detect(video).then(codes=>{
      const g=guide.getBoundingClientRect(), v=video.getBoundingClientRect();
      const gx=g.left-v.left, gy=g.top-v.top, gw=g.width, gh=g.height;
      const sx=overlay.width/v.width, sy=overlay.height/v.height;

      let accepted=null;
      for(const c of codes){
        const r=c.boundingBox; const cx=r.x+r.width/2, cy=r.y+r.height/2;
        const domX=cx/sx, domY=cy/sy;
        const inGuide=(domX>=gx&&domX<=gx+gw&&domY>=gy&&domY<=gy+gh);
        const g2=laser.getBoundingClientRect();
        const lx=g2.left-v.left+g2.width/2, ly=g2.top-v.top+g2.height/2;
        const dist=Math.sqrt((domX-lx)**2+(domY-ly)**2);
        const radius=g2.width/2;
        if(inGuide && dist<radius){ accepted=c.rawValue; break; }
      }

      if(accepted && canAccept()){
        if(el('confirm2').checked){
          if(lastVal===accepted){ confirmBuf.push(accepted); } else { confirmBuf=[accepted]; lastVal=accepted; }
          if(confirmBuf.length>=2){ processScan(accepted); return; }
        } else { processScan(accepted); return; }
      }
      requestAnimationFrame(loop);
    }).catch(()=>requestAnimationFrame(loop));
  };
  loop();
}

/* ===== ZXing fallback ===== */
async function startZXingHybrid(){
  const constraints={video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}}};
  const s=await navigator.mediaDevices.getUserMedia(constraints).catch(()=>null);
  if(!s){ alert('Fotocamera non disponibile o permesso negato.'); cameraArea.style.display='none'; return; }
  stream=s; track=stream.getVideoTracks()[0];

  const vid=document.createElement('video');
  vid.setAttribute('playsinline',''); vid.muted=true; vid.autoplay=true; vid.srcObject=stream;
  document.body.appendChild(vid);

  const formats=[ZXing.BarcodeFormat.QR_CODE,ZXing.BarcodeFormat.CODE_128,ZXing.BarcodeFormat.EAN_13,ZXing.BarcodeFormat.UPC_A,ZXing.BarcodeFormat.CODE_39];
  const hints=new Map(); hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,formats);
  const reader=new ZXing.BrowserMultiFormatReader(hints);

  await vid.play();

  const loop=async()=>{
    try{
      const res=await reader.decodeFromVideoElement(vid);
      if(res && canAccept()){ if(pointInGuideZXing(res,vid)){ processScan(res.text); return; } }
    }catch(e){}
    requestAnimationFrame(loop);
  };
  loop();
}
function pointInGuideZXing(result,vidEl){
  try{
    const pts=result.resultPoints||[]; if(pts.length===0) return true;
    let cx=0,cy=0; for(const p of pts){ cx+=p.x; cy+=p.y; } cx/=pts.length; cy/=pts.length;

    const vrect=vidEl.getBoundingClientRect();
    const vw=vidEl.videoWidth, vh=vidEl.videoHeight;
    const scale=Math.min(vrect.width/vw, vrect.height/vh);
    const dispW=vw*scale, dispH=vh*scale;
    const offX=(vrect.width-dispW)/2, offY=(vrect.height-dispH)/2;

    const domX=offX+cx*scale, domY=offY+cy*scale;
    const g2=document.getElementById('laser').getBoundingClientRect();
    const lx=g2.left-vrect.left+g2.width/2, ly=g2.top-vrect.top+g2.height/2;
    const dist=Math.sqrt((domX-lx)**2+(domY-ly)**2);
    return (dist < g2.width/2);
  }catch(e){ return true; }
}

/* ===== lettura singola ===== */
function processScan(text){
  const val = sanitize(text,128);
  if (mode==='list') expected = val; else scanned = val;

  stopStream();
  cameraArea.style.display='none';

  // resta nella tab scanner
  setTab('scanner');

  updateUI();
}

/* ===== stop camera ===== */
function stopStream(){
  try{
    if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
    if(track) track.stop();
  }catch(e){}
  clearTimeout(cameraIdleTimer); cameraIdleTimer=null;

  // esci da fullscreen se attivo
  try{ if(document.fullscreenElement) document.exitFullscreen?.(); }catch(_){}
}

/* ===== avvio ===== */
updateUI();
setTab('commessa');
</script>
</body>
</html>