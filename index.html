<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Poka-Yoke PRO ‚Ä¢ Scanner IBRIDO</title>

<!-- ZXing fallback -->
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>

<!-- jsPDF + AutoTable per PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --bg:#0F172A; --panel:#16223A; --border:#273449; --text:#E6EDF7;
    --muted:#9FB1CB; --accent:#38BDF8; --ok:#22C55E; --err:#EF4444; --warn:#F59E0B;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Inter,Segoe UI,Roboto,Arial}
  .app{min-height:100%;display:flex;flex-direction:column}

  header{padding:12px 16px;border-bottom:1px solid var(--border);background:#0B1325}
  .topbar{display:flex;align-items:center;gap:10px;justify-content:space-between}
  .brand{font-weight:800}
  #netBadge{font-size:12px;padding:4px 8px;border-radius:8px;border:1px solid var(--border)}
  #netBadge.online{background:rgba(34,197,94,.12);color:#86efac;border-color:#14532d}
  #netBadge.offline{background:rgba(245,158,11,.12);color:#FCD34D;border-color:#B45309}
  .lang{display:flex;gap:8px;align-items:center}
  .lang select{background:#0d182f;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:6px 10px}

  .tabs{display:flex;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);background:#0E1A32}
  .tab{padding:10px 14px;border-radius:999px;border:1px solid var(--border);color:var(--muted);cursor:pointer;font-weight:700}
  .tab.active{background:var(--accent);border-color:var(--accent);color:#05263A}

  main{flex:1;display:flex;flex-direction:column}
  .view{display:none;padding:14px}
  .view.active{display:block}

  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label.field{display:flex;flex-direction:column;gap:6px;flex:1 1 220px;min-width:200px}
  label.field span{font-size:12px;color:var(--muted)}
  .input, select{background:#0d182f;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px 12px;font-size:16px}
  .btn{padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#11203d;color:var(--text);font-weight:800;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .btn-primary{background:var(--accent);border-color:var(--accent);color:#05263A}
  .btn-ok{background:#0f2a1a;border-color:#14532d}
  .btn-outline{background:#0d182f}

  .status{display:flex;flex-direction:column;gap:8px;align-items:center;text-align:center}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;border:1px solid var(--border)}
  .badge.ok{background:rgba(34,197,94,.15);color:#86efac;border-color:#14532d}
  .badge.err{background:rgba(239,68,68,.15);color:#fecaca;border-color:#7f1d1d}

  #codes{display:flex;flex-direction:column;gap:10px;align-items:stretch;margin-top:4px;width:100%;max-width:680px}
  .codeBox{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0b162c}
  .codeLabel{font-size:13px;color:var(--muted);font-weight:800}
  .codeValue{flex:1;text-align:right;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-weight:900;letter-spacing:.5px;font-size:clamp(22px,3.6vh,40px);color:var(--text);word-break:break-all}
  .codeBox.ok{border-color:#14532d;background:rgba(34,197,94,.10)}
  .codeBox.err{border-color:#7f1d1d;background:rgba(239,68,68,.08)}
  .codeValue.ok{color:#86efac}.codeValue.err{color:#fecaca}

  #righeBox{max-height:50vh;overflow:auto;border:1px solid var(--border);border-radius:10px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:14px}
  th{position:sticky;top:0;background:#0f1b35;text-align:left;font-weight:800}
  .countPill{margin-left:8px;font-size:12px;padding:3px 8px;border-radius:10px;background:#0d2230;border:1px solid var(--border);color:var(--muted)}

  #camFS{position:fixed;inset:0;display:none;background:#000;z-index:9999}
  #camFS.active{display:block}
  .camTop{position:absolute;top:0;left:0;right:0;height:56px;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:linear-gradient(to bottom, rgba(0,0,0,.65), rgba(0,0,0,.0))}
  .camBtn{background:rgba(0,0,0,.45);color:#fff;border:1px solid rgba(255,255,255,.2);padding:8px 12px;border-radius:10px;font-weight:800}
  .camWrap{position:absolute;inset:0}
  #video{position:absolute;inset:0;object-fit:cover;width:100%;height:100%}
  #overlay{position:absolute;inset:0;pointer-events:none}
  #guide{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:34%;height:34%;border:3px solid rgba(255,255,255,.95);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,.35) inset;pointer-events:none}
  #laser{position:absolute;left:50%;top:50%;width:54px;height:54px;border:2px solid rgba(255,60,60,.9);border-radius:50%;transform:translate(-50%,-50%)}

  #qtyModal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:10000}
  .modalCard{background:#0b162c;border:1px solid var(--border);border-radius:14px;padding:16px;min-width:280px;max-width:92vw;box-shadow:0 10px 30px rgba(0,0,0,.6)}
  .modalTitle{font-weight:800;margin-bottom:8px}
  .qtyRow{display:flex;gap:10px;align-items:center;justify-content:center;margin:12px 0}
  .qtyBtn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#0f203c;color:var(--text);font-weight:800;font-size:20px;cursor:pointer}
  .qtyInput{width:110px;text-align:center;font-size:22px;font-weight:900;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0f1b35;color:var(--text)}
  .modalActions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
  .muted{color:var(--muted)}
  #toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);min-width:220px;max-width:90vw;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0d2230;color:var(--text);display:none;z-index:10001;text-align:center;font-weight:700}
  #toast.ok{background:rgba(34,197,94,.15);border-color:#14532d;color:#86efac}
  #toast.err{background:rgba(239,68,68,.15);border-color:#7f1d1d;color:#fecaca}
</style>
</head>

<body>
<div class="app">
  <header>
    <div class="topbar">
      <div class="brand">Poka-Yoke PRO ‚Ä¢ Scanner IBRIDO</div>
      <div class="lang">
        <span id="netBadge" class="offline">Offline</span>
        <select id="langSelect">
          <option value="it">Italiano</option>
          <option value="pt">Portugu√™s (BR)</option>
          <option value="en">English</option>
          <option value="ur">ÿßÿ±ÿØŸà</option>
        </select>
      </div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" data-tab="commessa" data-i18n="tab_commessa">Commessa</button>
    <button class="tab" data-tab="scanner" data-i18n="tab_scanner">Scanner</button>
    <button class="tab" data-tab="righe" data-i18n="tab_righe">Righe raccolte</button>
    <button class="tab" data-tab="impostazioni" data-i18n="tab_impostazioni">Impostazioni</button>
  </div>

  <main>
    <!-- COMMESSA -->
    <section id="commessa" class="view active">
      <div class="panel">
        <div class="row">
          <label class="field">
            <span data-i18n="lbl_operatore">Operatore</span>
            <input id="operatoreInput" class="input" placeholder="Nome e cognome"/>
          </label>
          <label class="field">
            <span data-i18n="lbl_commessa">Numero commessa</span>
            <input id="commessaInput" class="input" placeholder="Es. 024830" autocomplete="off"/>
          </label>
          <label class="field">
            <span data-i18n="lbl_posizione">Posizione</span>
            <input id="posizioneInput" class="input" placeholder="Es. POS 0020" autocomplete="off"/>
          </label>
          <label class="field" style="min-width:200px;flex:1 1 260px">
            <span data-i18n="lbl_camera">Fotocamera</span>
            <select id="cameraSelect" class="input">
              <option value="">(automatica)</option>
            </select>
          </label>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="goScanner" class="btn btn-primary" data-i18n="btn_goscanner">Vai allo Scanner</button>
        </div>
      </div>
      <div class="panel muted" data-i18n="hint_persist">Suggerimento: compila una volta sola; i dati restano salvati sul dispositivo.</div>
    </section>

    <!-- SCANNER -->
    <section id="scanner" class="view">
      <div class="panel status">
        <div id="badge" class="badge">Pronto</div>
        <div id="resultText" data-i18n-html="txt_istruzioni">Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b></div>
        <div id="codes"></div>
        <div class="muted" data-i18n-html="txt_help">Allinea il codice nel <b>quadrato</b> e centra nel cerchio rosso üî¥.</div>
      </div>
      <div class="panel">
        <div class="row">
          <button id="scanList" class="btn btn-primary" data-i18n="btn_lista">üìã LISTA (fullscreen)</button>
          <button id="scanItem" class="btn btn-primary" data-i18n="btn_pezzo">üì¶ PEZZO (fullscreen)</button>
          <button id="reset" class="btn btn-outline" data-i18n="btn_reset">üîÑ Reset</button>
        </div>
      </div>
    </section>

    <!-- RIGHE -->
    <section id="righe" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <div style="font-weight:800"><span data-i18n="tit_righe">Righe raccolte</span> <span class="countPill" id="countPill">0</span></div>
          <div class="row" style="gap:8px">
            <button id="scaricaCSV" class="btn btn-outline" disabled data-i18n="btn_csv">‚¨áÔ∏è Scarica CSV</button>
            <button id="scaricaPDF" class="btn btn-outline" disabled data-i18n="btn_pdf">‚¨áÔ∏è Scarica PDF</button>
            <button id="svuota" class="btn btn-outline" disabled data-i18n="btn_svuota">üóëÔ∏è Svuota</button>
          </div>
        </div>
        <div id="righeBox" style="margin-top:10px">
          <table>
            <thead><tr>
              <th data-i18n="th_ora">Ora</th>
              <th data-i18n="th_codice">Codice</th>
              <th data-i18n="th_qta">Q.t√†</th>
              <th data-i18n="th_commessa">Commessa</th>
              <th data-i18n="th_posizione">Posizione</th>
            </tr></thead>
            <tbody id="righeBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- IMPOSTAZIONI -->
    <section id="impostazioni" class="view">
      <div class="panel">
        <div style="font-weight:800;margin-bottom:8px" data-i18n="tit_impostazioni">Impostazioni</div>
        <div class="row">
          <label class="field" style="flex:0 0 260px">
            <span data-i18n="opt_confirm">Conferma doppia</span>
            <select id="optConfirm" class="input">
              <option value="on" selected data-i18n="opt_on">Attiva (pi√π sicuro)</option>
              <option value="off" data-i18n="opt_off">Disattiva (pi√π veloce)</option>
            </select>
          </label>
          <label class="field" style="flex:0 0 260px">
            <span data-i18n="opt_voice">Annuncio vocale</span>
            <select id="optVoice" class="input">
              <option value="on" selected data-i18n="opt_attivo">Attivo</option>
              <option value="off" data-i18n="opt_disattivo">Disattivo</option>
            </select>
          </label>
          <label class="field" style="flex:0 0 260px">
            <span data-i18n="opt_vibrate">Vibrazione</span>
            <select id="optVibrate" class="input">
              <option value="on" selected data-i18n="opt_attiva">Attiva</option>
              <option value="off" data-i18n="opt_disattiva">Disattiva</option>
            </select>
          </label>
        </div>
      </div>
      <div class="panel muted" data-i18n="foot_ui">Versione UI: 1.1 ‚Ä¢ Solo locale (nessun invio in rete). Aggiungi alla Home per esperienza tipo app.</div>
    </section>
  </main>
</div>

<!-- Fullscreen Camera -->
<div id="camFS">
  <div class="camTop">
    <button id="camClose" class="camBtn" data-i18n="btn_chiudi">‚úï Chiudi</button>
    <div id="camHint" class="camBtn" style="pointer-events:none" data-i18n="hint_scan">Inquadra e centra nel cerchio</div>
  </div>
  <div class="camWrap">
    <video id="video" muted playsinline></video>
    <canvas id="overlay"></canvas>
    <div id="guide"></div>
    <div id="laser"></div>
  </div>
</div>

<!-- Modale quantit√† -->
<div id="qtyModal">
  <div class="modalCard">
    <div class="modalTitle" data-i18n="mod_titolo">Inserisci quantit√† prelevata</div>
    <div id="qtyInfo" class="muted" style="margin-bottom:6px"></div>
    <div class="qtyRow">
      <button id="qtyMinus" class="qtyBtn">‚àí</button>
      <input id="qtyInput" class="qtyInput" type="number" min="1" step="1" placeholder=""/>
      <button id="qtyPlus" class="qtyBtn">+</button>
    </div>
    <div class="modalActions">
      <button id="qtyCancel" class="btn btn-outline" data-i18n="btn_annulla">Annulla</button>
      <button id="qtyOk" class="btn btn-ok" disabled data-i18n="btn_conferma">Conferma</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* ===== i18n (PT/IT/EN/UR) ===== */
const I18N = {
  it:{
    tab_commessa:"Commessa", tab_scanner:"Scanner", tab_righe:"Righe raccolte", tab_impostazioni:"Impostazioni",
    lbl_operatore:"Operatore", lbl_commessa:"Numero commessa", lbl_posizione:"Posizione", lbl_camera:"Fotocamera",
    btn_goscanner:"Vai allo Scanner", hint_persist:"Suggerimento: compila una volta sola; i dati restano salvati sul dispositivo.",
    txt_istruzioni:"Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b>", txt_help:"Allinea il codice nel <b>quadrato</b> e centra nel cerchio rosso üî¥.",
    btn_lista:"üìã LISTA (fullscreen)", btn_pezzo:"üì¶ PEZZO (fullscreen)", btn_reset:"üîÑ Reset",
    tit_righe:"Righe raccolte", btn_csv:"‚¨áÔ∏è Scarica CSV", btn_pdf:"‚¨áÔ∏è Scarica PDF", btn_svuota:"üóëÔ∏è Svuota",
    th_ora:"Ora", th_codice:"Codice", th_qta:"Q.t√†", th_commessa:"Commessa", th_posizione:"Posizione",
    tit_impostazioni:"Impostazioni", opt_confirm:"Conferma doppia", opt_on:"Attiva (pi√π sicuro)", opt_off:"Disattiva (pi√π veloce)",
    opt_voice:"Annuncio vocale", opt_attivo:"Attivo", opt_disattivo:"Disattivo", opt_vibrate:"Vibrazione", opt_attiva:"Attiva", opt_disattiva:"Disattiva",
    foot_ui:"Versione UI: 1.1 ‚Ä¢ Solo locale (nessun invio in rete). Aggiungi alla Home per esperienza tipo app.",
    btn_chiudi:"‚úï Chiudi", hint_scan:"Inquadra e centra nel cerchio",
    mod_titolo:"Inserisci quantit√† prelevata", btn_annulla:"Annulla", btn_conferma:"Conferma",
    toast_added:"Riga aggiunta", toast_cleared:"Sessione svuotata",
    err_fields:"Inserisci Operatore, Numero commessa e Posizione prima di scansionare."
  },
  pt:{
    tab_commessa:"Pedido", tab_scanner:"Scanner", tab_righe:"Linhas coletadas", tab_impostazioni:"Config.",
    lbl_operatore:"Operador", lbl_commessa:"N¬∫ do pedido", lbl_posizione:"Posi√ß√£o", lbl_camera:"C√¢mera",
    btn_goscanner:"Ir para o Scanner", hint_persist:"Dica: preencha uma vez; os dados ficam salvos no dispositivo.",
    txt_istruzioni:"Escaneie primeiro a <b>LISTA</b>, depois a <b>PE√áA</b>", txt_help:"Alinhe o c√≥digo no <b>quadrado</b> e centralize no c√≠rculo vermelho üî¥.",
    btn_lista:"üìã LISTA (tela cheia)", btn_pezzo:"üì¶ PE√áA (tela cheia)", btn_reset:"üîÑ Resetar",
    tit_righe:"Linhas coletadas", btn_csv:"‚¨áÔ∏è Baixar CSV", btn_pdf:"‚¨áÔ∏è Baixar PDF", btn_svuota:"üóëÔ∏è Esvaziar",
    th_ora:"Hora", th_codice:"C√≥digo", th_qta:"Qtd.", th_commessa:"Pedido", th_posizione:"Posi√ß√£o",
    tit_impostazioni:"Configura√ß√µes", opt_confirm:"Confirma√ß√£o dupla", opt_on:"Ativar (mais seguro)", opt_off:"Desativar (mais r√°pido)",
    opt_voice:"An√∫ncio de voz", opt_attivo:"Ativo", opt_disattivo:"Inativo", opt_vibrate:"Vibra√ß√£o", opt_attiva:"Ativar", opt_disattiva:"Desativar",
    foot_ui:"Vers√£o UI: 1.1 ‚Ä¢ Somente local (sem internet). Adicione √† Tela Inicial para modo app.",
    btn_chiudi:"‚úï Fechar", hint_scan:"Aponte e centralize no c√≠rculo",
    mod_titolo:"Insira a quantidade retirada", btn_annulla:"Cancelar", btn_conferma:"Confirmar",
    toast_added:"Linha adicionada", toast_cleared:"Sess√£o esvaziada",
    err_fields:"Preencha Operador, N¬∫ do pedido e Posi√ß√£o antes de escanear."
  },
  en:{
    tab_commessa:"Job", tab_scanner:"Scanner", tab_righe:"Collected rows", tab_impostazioni:"Settings",
    lbl_operatore:"Operator", lbl_commessa:"Job number", lbl_posizione:"Position", lbl_camera:"Camera",
    btn_goscanner:"Go to Scanner", hint_persist:"Tip: fill it once; data stays on this device.",
    txt_istruzioni:"Scan the <b>LIST</b> first, then the <b>ITEM</b>", txt_help:"Align the code in the <b>square</b> and center in the red circle üî¥.",
    btn_lista:"üìã LIST (fullscreen)", btn_pezzo:"üì¶ ITEM (fullscreen)", btn_reset:"üîÑ Reset",
    tit_righe:"Collected rows", btn_csv:"‚¨áÔ∏è Download CSV", btn_pdf:"‚¨áÔ∏è Download PDF", btn_svuota:"üóëÔ∏è Clear",
    th_ora:"Time", th_codice:"Code", th_qta:"Qty", th_commessa:"Job", th_posizione:"Position",
    tit_impostazioni:"Settings", opt_confirm:"Double confirm", opt_on:"Enable (safer)", opt_off:"Disable (faster)",
    opt_voice:"Voice announcement", opt_attivo:"On", opt_disattivo:"Off", opt_vibrate:"Vibration", opt_attiva:"On", opt_disattiva:"Off",
    foot_ui:"UI version: 1.1 ‚Ä¢ Local only (no network). Add to Home for app-like experience.",
    btn_chiudi:"‚úï Close", hint_scan:"Aim and center in the circle",
    mod_titolo:"Enter picked quantity", btn_annulla:"Cancel", btn_conferma:"Confirm",
    toast_added:"Row added", toast_cleared:"Session cleared",
    err_fields:"Enter Operator, Job number and Position before scanning."
  },
  ur:{
    tab_commessa:"ÿ¢ÿ±⁄àÿ±", tab_scanner:"ÿßÿ≥⁄©€åŸÜÿ±", tab_righe:"ÿß⁄©Ÿπ⁄æ€å ŸÇÿ∑ÿßÿ±€å⁄∫", tab_impostazioni:"ÿ≥€åŸπŸÜ⁄Øÿ≤",
    lbl_operatore:"ÿ¢Ÿæÿ±€åŸπÿ±", lbl_commessa:"ÿ¢ÿ±⁄àÿ± ŸÜŸÖÿ®ÿ±", lbl_posizione:"ŸæŸàÿ≤€åÿ¥ŸÜ", lbl_camera:"⁄©€åŸÖÿ±€Å",
    btn_goscanner:"ÿßÿ≥⁄©€åŸÜÿ± Ÿæÿ± ÿ¨ÿßÿ¶€å⁄∫", hint_persist:"ŸÖÿ¥Ÿàÿ±€Å: ÿß€å⁄© ÿ®ÿßÿ± ÿ®⁄æÿ± ÿØ€å⁄∫ÿõ ⁄à€åŸπÿß ÿßÿ≥€å ⁄à€åŸàÿßÿ¶ÿ≥ ŸÖ€å⁄∫ ŸÖÿ≠ŸÅŸàÿ∏ ÿ±€Å€í ⁄Øÿß€î",
    txt_istruzioni:"Ÿæ€ÅŸÑ€í <b>ŸÑÿ≥Ÿπ</b> ÿßÿ≥⁄©€åŸÜ ⁄©ÿ±€å⁄∫ÿå Ÿæ⁄æÿ± <b>Ÿæ€åŸêÿ≥Ÿà</b>", txt_help:"⁄©Ÿà⁄à ⁄©Ÿà <b>ŸÖÿ±ÿ®ÿπ</b> ŸÖ€å⁄∫ ÿ≥€åÿØ⁄æÿß ⁄©ÿ±€å⁄∫ ÿßŸàÿ± ÿ≥ÿ±ÿÆ ÿØÿßÿ¶ÿ±€í ŸÖ€å⁄∫ ŸÖÿ±⁄©ÿ≤ ⁄©ÿ±€å⁄∫ üî¥€î",
    btn_lista:"üìã ŸÑÿ≥Ÿπ (ŸÅŸÑ ÿßÿ≥⁄©ÿ±€åŸÜ)", btn_pezzo:"üì¶ Ÿæ€åÿ≥Ÿà (ŸÅŸÑ ÿßÿ≥⁄©ÿ±€åŸÜ)", btn_reset:"üîÑ ÿ±€å ÿ≥€åŸπ",
    tit_righe:"ÿß⁄©Ÿπ⁄æ€å ŸÇÿ∑ÿßÿ±€å⁄∫", btn_csv:"‚¨áÔ∏è CSV ⁄àÿßÿ§ŸÜ ŸÑŸà⁄à", btn_pdf:"‚¨áÔ∏è PDF ⁄àÿßÿ§ŸÜ ŸÑŸà⁄à", btn_svuota:"üóëÔ∏è ÿÆÿßŸÑ€å ⁄©ÿ±€å⁄∫",
    th_ora:"ŸàŸÇÿ™", th_codice:"⁄©Ÿà⁄à", th_qta:"ÿ™ÿπÿØÿßÿØ", th_commessa:"ÿ¢ÿ±⁄àÿ±", th_posizione:"ŸæŸàÿ≤€åÿ¥ŸÜ",
    tit_impostazioni:"ÿ≥€åŸπŸÜ⁄Øÿ≤", opt_confirm:"⁄àÿ®ŸÑ ⁄©ŸÜŸÅÿ±ŸÖ", opt_on:"ÿ¢ŸÜ (ŸÖÿ≠ŸÅŸàÿ∏)", opt_off:"ÿ¢ŸÅ (ÿ™€åÿ≤)",
    opt_voice:"Ÿàÿßÿ¶ÿ≥ ÿßÿπŸÑÿßŸÜ", opt_attivo:"ÿ¢ŸÜ", opt_disattivo:"ÿ¢ŸÅ", opt_vibrate:"Ÿàÿßÿ¶ÿ®ÿ±€åÿ¥ŸÜ", opt_attiva:"ÿ¢ŸÜ", opt_disattiva:"ÿ¢ŸÅ",
    foot_ui:"UI 1.1 ‚Ä¢ ÿµÿ±ŸÅ ŸÖŸÇÿßŸÖ€å€î ÿß€åŸæ ÿ¨€åÿ≥€í ÿ™ÿ¨ÿ±ÿ®€Å ⁄©€í ŸÑ€å€í €ÅŸàŸÖ ŸÖ€å⁄∫ ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫€î",
    btn_chiudi:"‚úï ÿ®ŸÜÿØ ⁄©ÿ±€å⁄∫", hint_scan:"Ÿπÿßÿ±⁄ØŸπ ⁄©ÿ±€å⁄∫ ÿßŸàÿ± ÿØÿßÿ¶ÿ±€í ⁄©€í ŸÖÿ±⁄©ÿ≤ ŸÖ€å⁄∫ ŸÑÿßÿ¶€å⁄∫",
    mod_titolo:"Ÿæ⁄© ⁄©€å ⁄Øÿ¶€å ŸÖŸÇÿØÿßÿ± ÿØÿ±ÿ¨ ⁄©ÿ±€å⁄∫", btn_annulla:"ŸÖŸÜÿ≥ŸàÿÆ", btn_conferma:"ÿ™ÿµÿØ€åŸÇ",
    toast_added:"ÿµŸÅ ÿ¥ÿßŸÖŸÑ €ÅŸàÿ¶€å", toast_cleared:"ÿ≥€åÿ¥ŸÜ ÿÆÿßŸÑ€å",
    err_fields:"ÿßÿ≥⁄©€åŸÜ ÿ≥€í Ÿæ€ÅŸÑ€í ÿ¢Ÿæÿ±€åŸπÿ±ÿå ÿ¢ÿ±⁄àÿ± ŸÜŸÖÿ®ÿ± ÿßŸàÿ± ŸæŸàÿ≤€åÿ¥ŸÜ ÿØÿ±ÿ¨ ⁄©ÿ±€å⁄∫€î"
  }
};
const LS_LANG='poka_lang_v1';
function applyI18n(lang){
  const tr=I18N[lang]||I18N.it;
  document.querySelectorAll('[data-i18n]').forEach(n=>{ n.textContent=tr[n.dataset.i18n]||n.textContent; });
  document.querySelectorAll('[data-i18n-html]').forEach(n=>{ n.innerHTML=tr[n.dataset.i18nHtml]||n.innerHTML; });
}
const langSel=document.getElementById('langSelect');
langSel.addEventListener('change',()=>{ localStorage.setItem(LS_LANG,langSel.value); applyI18n(langSel.value); });
langSel.value = localStorage.getItem(LS_LANG)||'it'; applyI18n(langSel.value);

/* ===== Stato rete ===== */
const netBadge=document.getElementById('netBadge');
function setNetBadge(){ const on=navigator.onLine; netBadge.textContent=on?'Online':'Offline'; netBadge.className=on?'online':'offline';}
window.addEventListener('online',setNetBadge);window.addEventListener('offline',setNetBadge);setNetBadge();

/* ===== Helper ===== */
const $=id=>document.getElementById(id);
const tabs=Array.from(document.querySelectorAll('.tab'));
const views={commessa:$('commessa'),scanner:$('scanner'),righe:$('righe'),impostazioni:$('impostazioni')};
function activateTab(name){ tabs.forEach(t=>t.classList.toggle('active',t.dataset.tab===name)); Object.entries(views).forEach(([k,el])=>el.classList.toggle('active',k===name)); }
tabs.forEach(t=> t.addEventListener('click',()=>activateTab(t.dataset.tab)));
$('goScanner').addEventListener('click',()=>activateTab('scanner'));

/* ===== Stato app ===== */
let expected=null, scanned=null, mode=null, pendingOK=null, confirmBuf=[], lastVal=null, lastScanTs=0;
let picks=[];

/* ===== Settings + Persist ===== */
const LSKEY_SETTINGS='poka_settings_v1', LSKEY_SESSION='poka_session_v1';
const settings={confirm:true,voice:true,vibrate:true};
function loadSettings(){ try{Object.assign(settings,JSON.parse(localStorage.getItem(LSKEY_SETTINGS)||'{}'));}catch{} 
  $('optConfirm').value=settings.confirm?'on':'off'; $('optVoice').value=settings.voice?'on':'off'; $('optVibrate').value=settings.vibrate?'on':'off';}
function saveSettings(){ localStorage.setItem(LSKEY_SETTINGS,JSON.stringify(settings)); }
$('optConfirm').onchange=e=>{settings.confirm=(e.target.value==='on');saveSettings();};
$('optVoice').onchange=e=>{settings.voice=(e.target.value==='on');saveSettings();};
$('optVibrate').onchange=e=>{settings.vibrate=(e.target.value==='on');saveSettings();};

function sanitize(s,max=64){return String(s||'').replace(/[^\w\-\. \/]/g,'').slice(0,max)}
function loadSessionFields(){ try{const s=JSON.parse(localStorage.getItem(LSKEY_SESSION)||'{}');
  $('operatoreInput').value=s.operatore||''; $('commessaInput').value=s.commessa||''; $('posizioneInput').value=s.posizione||'';}catch{} }
function saveSessionFields(){ const data={operatore:sanitize($('operatoreInput').value,64),commessa:sanitize($('commessaInput').value,64),posizione:sanitize($('posizioneInput').value,64)}; localStorage.setItem(LSKEY_SESSION,JSON.stringify(data)); }
['operatoreInput','commessaInput','posizioneInput'].forEach(id=>$(id).addEventListener('change',saveSessionFields));

/* ===== Audio/Voce/Vibra ===== */
let actx; function tone(f=880,d=120,t='sine',v=.25){try{if(!actx)actx=new (window.AudioContext||window.webkitAudioContext)();const o=actx.createOscillator(),g=actx.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(actx.destination);o.start();setTimeout(()=>o.stop(),d);}catch(e){}}
function okSound(){tone(900,120);setTimeout(()=>tone(1200,140),130)}
function errSound(){tone(250,220,'square',.22);setTimeout(()=>tone(180,230,'square',.20),200)}
function speak(msg){ if(!settings.voice) return; try{ const u=new SpeechSynthesisUtterance(msg); u.lang= (langSel.value==='pt'?'pt-BR':langSel.value==='en'?'en-US':langSel.value==='ur'?'ur-PK':'it-IT'); speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} }
function vibrate(p){ if(settings.vibrate && navigator.vibrate) navigator.vibrate(p) }

/* ===== UI scanner ===== */
const codesEl=$('codes'), badge=$('badge'), resultText=$('resultText');
function norm(s){return s?String(s).trim().toUpperCase():s}
function box(label,val,cls){return `<div class="codeBox ${cls||''}"><div class="codeLabel">${label}</div><div class="codeValue ${cls||''}">${val?val:'-'}</div></div>`;}
function updateUI(){
  const same=expected && scanned && (norm(expected)===norm(scanned));
  const stateClass = same ? 'ok' : (expected && scanned ? 'err' : '');
  const L = I18N[langSel.value]||I18N.it;
  codesEl.innerHTML = box('LISTA', expected||'', same?'ok':'') + box('PEZZO', scanned||'', stateClass);
  if(expected && scanned){
    if(same){
      badge.textContent='‚úÖ CORRETTO'; badge.className='badge ok'; resultText.innerHTML=L.txt_istruzioni;
      okSound(); speak(langSel.value==='en'?'Code ok':langSel.value==='pt'?'C√≥digo correto':langSel.value==='ur'?'⁄©Ÿà⁄à ÿØÿ±ÿ≥ÿ™':'Codice corretto'); vibrate(60);
      pendingOK=expected; openQtyModal(pendingOK);
    }else{
      badge.textContent='‚ùå ERRATO'; badge.className='badge err'; resultText.innerHTML=L.txt_istruzioni;
      errSound(); speak(langSel.value==='en'?'Different code':langSel.value==='pt'?'C√≥digo diferente':langSel.value==='ur'?'ŸÖÿÆÿ™ŸÑŸÅ ⁄©Ÿà⁄à':'Codice diverso'); vibrate([60,60,180]);
      pendingOK=null;
    }
  }else{ badge.textContent='Pronto'; badge.className='badge'; resultText.innerHTML=L.txt_istruzioni; }
}

/* ===== Toast ===== */
const toast=$('toast'); let toastTimer=null;
function showToast(text,kind='ok',ms=1800){ toast.textContent=text; toast.className=''; toast.classList.add(kind); toast.style.display='block'; clearTimeout(toastTimer); toastTimer=setTimeout(()=>toast.style.display='none',ms); }

/* ===== Righe ===== */
function renderRighe(){
  const tb=$('righeBody');
  tb.innerHTML=picks.map(p=>{const hh=p.ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'}); return `<tr><td>${hh}</td><td>${p.codice}</td><td>${p.qty}</td><td>${p.commessa||'-'}</td><td>${p.posizione||'-'}</td></tr>`;}).join('');
  $('scaricaCSV').disabled = $('scaricaPDF').disabled = picks.length===0;
  $('svuota').disabled = picks.length===0;
  $('countPill').textContent=String(picks.length);
}
function toCSV(){
  const head='timestamp_ms,iso,codice,quantita,commessa,posizione\n';
  const body=picks.map(p=>[p.ts.getTime(), p.ts.toISOString(), p.codice, p.qty, p.commessa||'', p.posizione||''].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  return head+body;
}
$('scaricaCSV').onclick=()=>{ if(!picks.length) return; const csv=toCSV(); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); const op=$('operatoreInput').value||'operatore'; a.href=url; a.download=`scheda_picking_${($('commessaInput').value||'commessa')}_${op}.csv`; a.click(); URL.revokeObjectURL(url); };
$('svuota').onclick=()=>{ if(!picks.length) return; if(confirm((I18N[langSel.value]||I18N.it).btn_svuota+'?')){ picks=[]; renderRighe(); updateUI(); showToast((I18N[langSel.value]||I18N.it).toast_cleared,'err',1400);} };

/* ===== PDF ===== */
$('scaricaPDF').onclick=()=>{
  if(!picks.length) return;
  const L=I18N[langSel.value]||I18N.it;
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF({unit:'pt',format:'a4'});
  const op=sanitize($('operatoreInput').value,64)||'-';
  const cm=sanitize($('commessaInput').value,64)||'-';
  const ps=sanitize($('posizioneInput').value,64)||'-';
  const now=new Date(); const iso=now.toLocaleString();

  // Header
  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text('Poka-Yoke PRO ‚Ä¢ Picking',40,40);
  doc.setFontSize(11); doc.setFont('helvetica','normal');
  doc.text(`${L.lbl_operatore}: ${op}`,40,62);
  doc.text(`${L.lbl_commessa}: ${cm}`,40,78);
  doc.text(`${L.lbl_posizione}: ${ps}`,40,94);
  doc.text(`Data/Ora: ${iso}`,40,110);

  // Tabella
  const head=[[L.th_ora,L.th_codice,L.th_qta,L.th_commessa,L.th_posizione]];
  const data=picks.map(p=>[
    p.ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'}),
    p.codice, String(p.qty), p.commessa||'', p.posizione||''
  ]);
  doc.autoTable({
    startY:130, head:head, body:data,
    styles:{font:'helvetica',fontSize:10,cellPadding:6,lineColor:[39,52,73],lineWidth:0.5},
    headStyles:{fillColor:[22,34,58],textColor:255},
    alternateRowStyles:{fillColor:[17,32,61]}
  });

  const filename=`scheda_picking_${cm}_${op}.pdf`;
  doc.save(filename);
};

/* ===== Modale quantit√† ===== */
const qtyModal=$('qtyModal'), qtyInput=$('qtyInput'), qtyMinus=$('qtyMinus'), qtyPlus=$('qtyPlus'), qtyOk=$('qtyOk'), qtyCancel=$('qtyCancel'), qtyInfo=$('qtyInfo');
function openQtyModal(code){
  qtyInfo.innerHTML = `Codice: <b>${code}</b>`;
  qtyInput.value=''; qtyOk.disabled=true;
  qtyModal.style.display='flex'; setTimeout(()=>qtyInput.focus(),50);
}
function closeQtyModal(){ qtyModal.style.display='none'; }
qtyInput.addEventListener('input',()=>{ const v=parseInt(qtyInput.value,10); qtyOk.disabled = !(v>=1); });
qtyMinus.onclick=()=>{ const n=Math.max(1,(parseInt(qtyInput.value||'0',10)||0)-1); qtyInput.value=String(n); qtyOk.disabled=false; };
qtyPlus.onclick =()=>{ const n=Math.max(1,(parseInt(qtyInput.value||'0',10)||0)+1); qtyInput.value=String(n); qtyOk.disabled=false; };
qtyCancel.onclick=()=>{ closeQtyModal(); };
qtyOk.onclick=()=>{
  const v=parseInt(qtyInput.value,10); if(!(v>=1)) return;
  if(!pendingOK){ closeQtyModal(); return; }
  const ts=new Date(); const cm=sanitize($('commessaInput').value,64), ps=sanitize($('posizioneInput').value,64);
  picks.push({ts, codice:sanitize(pendingOK,128), qty:v, commessa:cm, posizione:ps});
  renderRighe(); showToast((I18N[langSel.value]||I18N.it).toast_added,'ok',1400);
  pendingOK=null; scanned=null; updateUI(); closeQtyModal();
};

/* ===== Reset ===== */
$('reset').onclick=()=>{ expected=null; scanned=null; pendingOK=null; updateUI(); };

/* ===== Camera Fullscreen ===== */
const camFS=$('camFS'), camClose=$('camClose'), video=$('video'), overlay=$('overlay'), guide=$('guide'), laser=$('laser');
let stream=null, track=null, currentMode=null;
camClose.onclick=stopCameraFS;
$('scanList').onclick = ()=>startScanFS('list');
$('scanItem').onclick = ()=>startScanFS('item');

function canAccept(){ const now=performance.now(); if(now-lastScanTs<600) return false; lastScanTs=now; return true; }

async function startScanFS(which){
  // fields required
  const L=I18N[langSel.value]||I18N.it;
  saveSessionFields();
  const op=sanitize($('operatoreInput').value,64), cm=sanitize($('commessaInput').value,64), ps=sanitize($('posizioneInput').value,64);
  if(!op || !cm || !ps){ alert(L.err_fields); activateTab('commessa'); return; }

  activateTab('scanner');
  currentMode=which; camFS.classList.add('active');

  try{ await startDetectorHybrid(); }catch(e){ await startZXingHybrid(); }
}
function stopCameraFS(){
  try{ if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; } if(track) track.stop(); }catch(e){}
  stream=null; track=null; camFS.classList.remove('active');
}

/* Detector nativo */
async function startDetectorHybrid(){
  const constraints={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720},focusMode:"continuous"}};
  const chosen=$('cameraSelect').value; if(chosen) constraints.video.deviceId={exact:chosen};
  stream=await navigator.mediaDevices.getUserMedia(constraints); track=stream.getVideoTracks()[0]; video.srcObject=stream; await video.play();

  const detector=new BarcodeDetector({formats:['qr_code','code_128','ean_13','ean_8','upc_a','code_39']});
  const ctx=overlay.getContext('2d');
  const loop=()=>{
    if(!stream){return;}
    if(video.readyState<2){ requestAnimationFrame(loop); return; }
    overlay.width=video.videoWidth; overlay.height=video.videoHeight; ctx.clearRect(0,0,overlay.width,overlay.height);

    detector.detect(video).then(codes=>{
      const g=guide.getBoundingClientRect(), v=video.getBoundingClientRect();
      const gx=g.left-v.left, gy=g.top-v.top, gw=g.width, gh=g.height;
      const sx=overlay.width/v.width, sy=overlay.height/v.height;
      let accepted=null;
      for(const c of codes){
        const r=c.boundingBox; const cx=r.x+r.width/2, cy=r.y+r.height/2;
        const domX=cx/sx, domY=cy/sy;
        const inGuide=(domX>=gx&&domX<=gx+gw&&domY>=gy&&domY<=gy+gh);
        const g2=laser.getBoundingClientRect(); const lx=g2.left-v.left+g2.width/2, ly=g2.top-v.top+g2.height/2;
        const dist=Math.sqrt((domX-lx)**2+(domY-ly)**2), radius=g2.width/2;
        if(inGuide && dist<radius){ accepted=c.rawValue; break; }
      }
      if(accepted && canAccept()){
        if(settings.confirm){
          if(lastVal===accepted){ confirmBuf.push(accepted);} else {confirmBuf=[accepted]; lastVal=accepted;}
          if(confirmBuf.length>=2){ processScan(accepted); return; }
        } else { processScan(accepted); return; }
      }
      requestAnimationFrame(loop);
    }).catch(()=>requestAnimationFrame(loop));
  };
  loop();
}

/* ZXing fallback */
async function startZXingHybrid(){
  const constraints={video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}}};
  const chosen=$('cameraSelect').value; if(chosen) constraints.video.deviceId={ exact: chosen };
  stream=await navigator.mediaDevices.getUserMedia(constraints); track=stream.getVideoTracks()[0];
  const formats=[ZXing.BarcodeFormat.QR_CODE,ZXing.BarcodeFormat.CODE_128,ZXing.BarcodeFormat.EAN_13,ZXing.BarcodeFormat.UPC_A,ZXing.BarcodeFormat.CODE_39];
  const hints=new Map(); hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,formats);
  const reader=new ZXing.BrowserMultiFormatReader(hints);
  video.srcObject=stream; await video.play();
  const loop=async()=>{ try{ const res=await reader.decodeFromVideoDevice(null, video); if(res && canAccept()){ if(pointInGuideZXing(res,video)){ processScan(res.text); return; } } }catch(e){} requestAnimationFrame(loop); }; loop();
}
function pointInGuideZXing(result,vidEl){
  try{
    const pts=result.resultPoints||[]; if(pts.length===0) return true;
    let cx=0,cy=0; for(const p of pts){ cx+=p.x; cy+=p.y; } cx/=pts.length; cy/=pts.length;
    const vrect=vidEl.getBoundingClientRect(); const vw=vidEl.videoWidth, vh=vidEl.videoHeight;
    const scale=Math.min(vrect.width/vw, vrect.height/vh); const dispW=vw*scale, dispH=vh*scale;
    const offX=(vrect.width-dispW)/2, offY=(vrect.height-dispH)/2;
    const domX=offX+cx*scale, domY=offY+cy*scale;
    const g2=laser.getBoundingClientRect(); const lx=g2.left-vrect.left+g2.width/2, ly=g2.top-vrect.top+g2.height/2;
    const dist=Math.sqrt((domX-lx)**2+(domY-ly)**2); return (dist < g2.width/2);
  }catch(e){ return true; }
}

/* Lettura singola */
function processScan(text){
  const val=sanitize(text,128);
  if(currentMode==='list'){ expected=val; } else { scanned=val; }
  stopCameraFS(); updateUI();
}

/* Camera select */
async function populateCameras(){ try{ const devices=await navigator.mediaDevices.enumerateDevices(); const vids=devices.filter(d=>d.kind==='videoinput');
  $('cameraSelect').innerHTML='<option value="">(automatica)</option>'+vids.map(v=>`<option value="${v.deviceId}">${v.label||'Fotocamera'}</option>`).join(''); }catch(_){} }
if(navigator.mediaDevices?.enumerateDevices){ populateCameras(); }

/* Avvio */
loadSettings(); loadSessionFields(); updateUI(); renderRighe();
</script>
</body>
</html>