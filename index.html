<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Poka-Yoke OFFLINE ‚Ä¢ Scanner IBRIDO (PIN)</title>
<style>
  :root{--ok:#16a34a;--err:#dc2626;--panel:#0f172a;--fg:#e5e7eb;--muted:#94a3b8}
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{min-height:100%;display:flex;flex-direction:column}
  header{padding:12px 16px;background:#0a0f1d;border-bottom:1px solid #1f2937}
  header h1{margin:0;font-size:18px}
  main{flex:1;display:flex;flex-direction:column;gap:12px;padding:12px}
  .panel{background:var(--panel);border:1px solid #1f2937;border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{flex:1 1 150px;padding:12px 14px;border-radius:12px;border:1px solid #243045;background:#111827;color:#fff;font-size:16px;font-weight:700;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .btn-sm{flex:0 0 auto;font-size:14px;padding:10px 12px}
  .btn-blue{background:#1e293b;border-color:#334155}
  .btn-green{background:#14532d;border-color:#14532d}
  .btn-outline{background:#0b1220;border-color:#334155}
  .status{display:flex;flex-direction:column;gap:6px;align-items:center;text-align:center}
  #resultText{font-size:20px;margin:4px 0 2px}
  #codes{display:flex;flex-direction:column;gap:10px;align-items:stretch;margin-top:4px}
  .codeBox{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-radius:12px;border:1px solid #334155;background:#0b1220}
  .codeLabel{font-size:14px;color:#9ca3af;font-weight:700}
  .codeValue{flex:1;text-align:right;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-weight:900;letter-spacing:.5px;font-size:clamp(22px,3.8vh,40px);color:var(--fg);word-break:break-all}
  .codeBox.ok{border-color:#14532d;background:rgba(22,163,74,.12)}
  .codeBox.err{border-color:#7f1d1d;background:rgba(220,38,38,.10)}
  .codeValue.ok{color:#86efac}.codeValue.err{color:#fecaca}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;border:1px solid #374151}
  .ok{background:rgba(22,163,74,.15);color:#86efac;border-color:#14532d}
  .err{background:rgba(220,38,38,.15);color:#fecaca;border-color:#7f1d1d}
  .muted{color:var(--muted)}
  #cameraArea{display:none}
  #preview{position:relative;width:100%;max-width:520px;height:62vh;margin:auto;border-radius:12px;overflow:hidden;background:#000}
  #video{position:absolute;inset:0;object-fit:cover;width:100%;height:100%}
  #overlay{position:absolute;inset:0;pointer-events:none}
  #guide{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:30%;height:30%;border:3px solid rgba(255,255,255,.95);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,.4) inset;pointer-events:none}
  #laser{position:absolute;left:50%;top:50%;width:50px;height:50px;border:2px solid rgba(255,50,50,.85);border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 12px rgba(255,60,60,.85);pointer-events:none}
  #flash{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .18s}
  footer{padding:10px 16px;color:#94a3b8;font-size:12px;text-align:center;border-top:1px solid #1f2937}
  .small{font-size:12px;color:#9ca3af}
  #statusLine{font-size:12px;color:#cbd5e1;text-align:center;margin-top:6px;min-height:1em}
  .input,select{background:#0b1220;border:1px solid #243045;border-radius:10px;color:#e5e7eb;padding:10px 12px;font-size:16px;flex:1 1 180px}
  .input::placeholder{color:#64748b}
  label.field{display:flex;flex-direction:column;gap:6px;flex:1 1 180px}
  label.field span{font-size:12px;color:#9ca3af}
  #righeBox{max-height:28vh;overflow:auto;border:1px solid #1f2937;border-radius:10px}
  .tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{padding:8px 10px;border-bottom:1px solid #1f2937;font-size:14px}
  .tbl th{position:sticky;top:0;background:#0a0f1d;text-align:left;font-weight:800}

  /* ===== PIN Gate ===== */
  #pinGate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.85);z-index:99999}
  .pinCard{background:#0b1220;border:1px solid #334155;border-radius:16px;padding:18px;min-width:300px;max-width:92vw;box-shadow:0 10px 30px rgba(0,0,0,.6);display:flex;flex-direction:column;gap:10px}
  .pinTitle{font-size:18px;font-weight:800}
  .pinInput{font-size:22px;letter-spacing:4px;text-align:center;padding:10px;border-radius:10px;border:1px solid #334155;background:#0a0f1d;color:#fff}
  .pinGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:6px}
  .pinBtn{padding:14px 0;border-radius:12px;border:1px solid #334155;background:#111827;color:#fff;font-weight:800;font-size:18px}
  .pinRow{display:flex;gap:8px;justify-content:center}
  .pinMsg{min-height:1em;font-size:12px;color:#cbd5e1;text-align:center}
  .cooldown{color:#fecaca}
  .pinRemember{display:flex;align-items:center;gap:8px;justify-content:center;font-size:12px;color:#cbd5e1}
</style>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>
</head>
<body>
<!-- ====== PIN / Licenza ====== -->
<div id="pinGate">
  <div class="pinCard">
    <div class="pinTitle">üîí Accesso protetto</div>
    <input id="pinInput" class="pinInput" type="password" inputmode="numeric" autocomplete="one-time-code" placeholder="PIN" maxlength="8"/>
    <div class="pinGrid">
      <button class="pinBtn">1</button><button class="pinBtn">2</button><button class="pinBtn">3</button>
      <button class="pinBtn">4</button><button class="pinBtn">5</button><button class="pinBtn">6</button>
      <button class="pinBtn">7</button><button class="pinBtn">8</button><button class="pinBtn">9</button>
    </div>
    <div class="pinRow">
      <button id="pinClear" class="pinBtn" style="flex:1">Cancella</button>
      <button class="pinBtn" style="flex:1">0</button>
      <button id="pinOk" class="pinBtn btn-green" style="flex:1">OK</button>
    </div>
    <label class="pinRemember"><input id="remember" type="checkbox" /> Ricordami su questo dispositivo (30 giorni)</label>
    <div id="pinMsg" class="pinMsg"></div>
  </div>
</div>

<div class="wrap" aria-hidden="true">
  <header>
    <div class="row" style="justify-content:space-between">
      <h1 style="flex:0 1 auto">Poka-Yoke OFFLINE ‚Ä¢ Scanner IBRIDO</h1>
      <div class="row" style="gap:8px">
        <span id="licenzaInfo" class="small muted"></span>
        <button id="lockNow" class="btn btn-sm btn-outline">üîí Blocca ora</button>
      </div>
    </div>
  </header>

  <!-- Testata -->
  <div class="panel">
    <div class="row">
      <label class="field">
        <span>Numero commessa</span>
        <input id="commessa" class="input" placeholder="Es. 024830" autocomplete="off"/>
      </label>
      <label class="field">
        <span>Posizione</span>
        <input id="posizione" class="input" placeholder="Es. POS 0020" autocomplete="off"/>
      </label>
      <label class="field" style="min-width:180px;flex:1 1 220px">
        <span>Fotocamera</span>
        <select id="cameraSelect" class="input"><option value="">(automatico)</option></select>
      </label>
      <button id="finalizza" class="btn btn-blue" style="flex:0 0 220px">üßæ Esporta / Condividi CSV</button>
    </div>
    <div class="small" style="margin-top:6px">Compila <b>commessa</b> e <b>posizione</b> prima di iniziare.</div>
  </div>

  <main>
    <div class="panel status">
      <div id="badge" class="badge">Pronto</div>
      <div id="resultText">Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b></div>
      <div id="codes"></div>
      <div class="small">Allinea il codice nel <b>quadrato</b> e centra nel cerchio rosso üî¥.</div>
    </div>

    <div class="panel">
      <div class="row">
        <button id="scanList" class="btn">üìã LISTA</button>
        <button id="scanItem" class="btn">üì¶ PEZZO</button>
        <button id="reset" class="btn">üîÑ Reset</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="torch" class="btn btn-sm" disabled>üî¶ LED</button>
        <button id="zoomIn" class="btn btn-sm" disabled>üîé +</button>
        <button id="zoomOut" class="btn btn-sm" disabled>üîç ‚àí</button>
        <label class="small"><input type="checkbox" id="confirm2" checked> Conferma doppia</label>
        <label class="small"><input type="checkbox" id="voice" checked> Annuncio vocale</label>
        <div class="row" style="gap:8px;flex:0 0 auto">
          <button id="saveSession" class="btn btn-sm btn-outline">üíæ Salva sessione</button>
          <button id="loadSession" class="btn btn-sm btn-outline">üìÇ Carica sessione</button>
          <button id="shareCSV" class="btn btn-sm btn-green">üì§ Condividi CSV</button>
        </div>
        <span id="statusLine"></span>
      </div>
    </div>

    <div id="cameraArea" class="panel">
      <div id="preview">
        <video id="video" muted playsinline></video>
        <canvas id="overlay"></canvas>
        <div id="guide"></div>
        <div id="laser"></div>
      </div>
      <div class="small" style="text-align:center;margin-top:6px">Se fatica: usa <b>Zoom</b> o attiva <b>LED</b>.</div>
    </div>

    <div class="panel">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="small">Righe raccolte (scheda in tempo reale)</div>
        <div class="row" style="gap:8px;flex:0 0 auto">
          <button id="scaricaCSV" class="btn btn-sm btn-blue" disabled>‚¨áÔ∏è Scarica CSV</button>
          <button id="svuota" class="btn btn-sm btn-outline" disabled>üóëÔ∏è Svuota</button>
        </div>
      </div>
      <div id="righeBox" style="margin-top:8px">
        <table class="tbl" id="righeTbl">
          <thead><tr><th>Ora</th><th>Codice</th><th>Q.t√†</th><th>Commessa</th><th>Posizione</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="small muted" style="margin-top:6px">Dati salvati solo sul dispositivo. Nessun invio in rete.</div>
    </div>
  </main>

  <footer id="footerNote">Consenti fotocamera ‚Ä¢ Funziona meglio in Chrome Android (aggiungi alla Home) ‚Ä¢ Modalit√† OFFLINE</footer>
</div>

<div id="flash"></div>

<script>
/* ======= LICENZA (per test: SCADUTA) ======= */
const LICENSE_OWNER  = "Demo Cliente";
const LICENSE_EXPIRY = "2025-10-01"; // <-- SCADUTA: vedrai il blocco subito

/* ===== PIN CONFIG ===== */
const PIN_MODE   = 'fixed';
const PIN_HASH   = 'srLxBNMsY4kD4VGpsg1uJ7QdjAyEz4RYc4+Dyi8d10Q='; // SHA-256 base64 del PIN "2025"
const DAILY_SECRET = 'CAMBIA_QUESTA_CHIAVE_LUNGA';

// Auto-lock & Remember
const AUTOLOCK_MS = 5 * 60 * 1000;
const REMEMBER_DAYS = 30;
const LS_AUTH = 'pokaYokeAuth_v2';

/* ===== NO TIME TRAVEL =====
   - Salva "ultimo tempo visto" in localStorage.
   - Se l'orologio va INDIETRO oltre 2 minuti rispetto a quel valore, blocca. */
const LS_LAST_SEEN = 'pokaLastSeen_v1';
const TRAVEL_TOLERANCE_MS = 2 * 60 * 1000; // 2 minuti

function hardBlock(message){
  document.body.innerHTML = `
    <div style="text-align:center;margin-top:35vh;color:#f33;font-family:system-ui;padding:0 16px">
      <h2>‚õî Accesso bloccato</h2>
      <p>${message||'Errore di licenza o orologio di sistema non valido.'}</p>
    </div>`;
  throw new Error(message||'Blocked');
}

function checkLicenseAndTime(){
  // 1) Licenza
  if(LICENSE_EXPIRY){
    const expiry = new Date(LICENSE_EXPIRY + "T23:59:59Z").getTime();
    const nowUTC = Date.now();
    if(nowUTC > expiry){
      hardBlock('Licenza scaduta. Contatta lo sviluppatore per il rinnovo.');
    }
  }
  // 2) No Time Travel
  try{
    const lastRaw = localStorage.getItem(LS_LAST_SEEN);
    const now = Date.now();
    if(lastRaw){
      const last = parseInt(lastRaw,10);
      if(isFinite(last) && (now + TRAVEL_TOLERANCE_MS) < last){
        hardBlock('Data/ora di sistema non valida (spostata indietro).');
      }
    }
    // aggiorna last seen
    localStorage.setItem(LS_LAST_SEEN, String(now));
  }catch(_){}
}

// Esegui controllo SUBITO (prima di qualsiasi UI)
checkLicenseAndTime();

/* ====== AUTENTICAZIONE PIN & LICENZA INFO ====== */
const pinGate = document.getElementById('pinGate');
const pinInput = document.getElementById('pinInput');
const pinMsg = document.getElementById('pinMsg');
const pinButtons = Array.from(document.querySelectorAll('.pinBtn'));
const pinClear = document.getElementById('pinClear');
const pinOk = document.getElementById('pinOk');
const remember = document.getElementById('remember');
let pinAttempts = 0;
let pinLockedUntil = 0;
let _autolockTimer = null;

(function showLicenseInfo(){
  const f = document.getElementById('footerNote');
  const top = document.getElementById('licenzaInfo');
  let extra = [];
  if(LICENSE_OWNER) extra.push(`Licenza: ${LICENSE_OWNER}`);
  if(LICENSE_EXPIRY){
    const d = new Date(LICENSE_EXPIRY+"T23:59:59Z");
    extra.push(`Scadenza: ${d.toLocaleDateString()}`);
  }
  const txt = extra.join(' ‚Ä¢ ');
  if(txt){ top.textContent = txt; f.innerHTML += ` ‚Ä¢ ${txt}`; }
})();

function resetAutolock(){
  clearTimeout(_autolockTimer);
  _autolockTimer = setTimeout(()=> lockApp('Sessione scaduta. Inserisci di nuovo il PIN.'), AUTOLOCK_MS);
}
['click','touchstart','keydown'].forEach(ev=>{
  document.addEventListener(ev, ()=>{ if(pinGate.style.display==='none') resetAutolock(); }, {passive:true});
});
document.getElementById('lockNow').addEventListener('click', ()=> lockApp('Sessione bloccata.'));

pinButtons.forEach(b=>{
  b.addEventListener('click', ()=>{
    if(b === pinOk) return;
    if(b === pinClear) return;
    pinInput.value = (pinInput.value || '') + b.textContent.trim();
  });
});
pinClear.addEventListener('click', ()=> pinInput.value='');
pinOk.addEventListener('click', checkPIN);

async function checkPIN(){
  const now = Date.now();
  if (now < pinLockedUntil){
    const left = Math.ceil((pinLockedUntil - now)/1000);
    pinMsg.innerHTML = `‚è≥ Attendi ${left}s per riprovare.`;
    pinMsg.classList.add('cooldown');
    return;
  }
  pinMsg.classList.remove('cooldown');

  const entered = (pinInput.value||'').trim();
  if(!entered){ pinMsg.textContent = 'Inserisci il PIN'; return; }

  let valid = false;
  if(PIN_MODE === 'fixed'){
    const h = await sha256B64(entered);
    valid = (h === PIN_HASH);
  }else{
    const expected = await dailyPin();
    valid = (entered === expected);
  }

  if(valid){
    // ulteriore check anti-time-travel al momento dello sblocco
    checkLicenseAndTime();
    unlockApp();
    if(remember.checked){
      const until = Date.now() + REMEMBER_DAYS*24*60*60*1000;
      const token = { hash: PIN_HASH, until };
      localStorage.setItem(LS_AUTH, JSON.stringify(token));
    }else{
      localStorage.removeItem(LS_AUTH);
    }
  }else{
    pinAttempts++;
    if(pinAttempts >= 5){
      pinLockedUntil = Date.now() + 60*1000;
      pinMsg.textContent = 'Troppi tentativi. Attendi 60s.';
      pinMsg.classList.add('cooldown');
      pinAttempts = 0;
    }else{
      pinMsg.textContent = `PIN errato. Tentativi: ${pinAttempts}/5`;
    }
    pinInput.value='';
  }
}

function tryAutoLogin(){
  try{
    const raw = localStorage.getItem(LS_AUTH);
    if(!raw) return false;
    const tok = JSON.parse(raw);
    // controlla licenza e time travel anche in auto-login
    checkLicenseAndTime();
    if(tok.hash === PIN_HASH && Date.now() < (tok.until||0)){
      unlockApp();
      return true;
    }
  }catch(_){}
  return false;
}

function lockApp(msg){
  document.querySelector('.wrap').setAttribute('aria-hidden','true');
  pinGate.style.display = 'flex';
  pinMsg.textContent = msg || '';
  pinInput.value='';
}
function unlockApp(){
  pinGate.style.display = 'none';
  document.querySelector('.wrap').removeAttribute('aria-hidden');
  pinMsg.textContent='';
  pinAttempts = 0;
  pinLockedUntil = 0;
  // aggiorna last seen ad ogni sblocco
  try{ localStorage.setItem(LS_LAST_SEEN, String(Date.now())); }catch(_){}
  resetAutolock();
}

/* SHA-256 ‚Üí base64 */
async function sha256B64(str){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
  let bin = ''; const bytes = new Uint8Array(buf);
  for(let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]);
  return btoa(bin);
}

/* PIN giornaliero */
async function dailyPin(){
  const d = new Date();
  const ymd = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
  const enc = new TextEncoder();
  const key = await crypto.subtle.importKey('raw', enc.encode('CAMBIA_QUESTA_CHIAVE_LUNGA'), {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
  const sig = await crypto.subtle.sign('HMAC', key, enc.encode(ymd));
  const view = new DataView(sig);
  const n = (view.getUint32(0, false) % 10000);
  return String(n).padStart(4,'0');
}

/* Avvio bloccato o auto-login */
if(!tryAutoLogin()){ lockApp(); }

/* ======= App scanner OFFLINE (funzioni principali) ======= */
document.addEventListener('click',()=>{speechSynthesis.getVoices();},{once:true});
let expected=null, scanned=null, mode=null, stream, track, confirmBuf=[], lastVal=null;
let picks=[]; // {ts, codice, qty, commessa, posizione}
let pendingOK=null;
let lastScanTs=0;
let cameraIdleTimer=null;

const el=id=>document.getElementById(id);
const video=el('video'), overlay=el('overlay'), guide=el('guide'), laser=el('laser');
const badge=el('badge'), resultText=el('resultText'), codes=el('codes');
const btnTorch=el('torch'), btnZoomIn=el('zoomIn'), btnZoomOut=el('zoomOut');
const confirm2=el('confirm2'), voice=el('voice'), cameraArea=el('cameraArea'), statusLine=el('statusLine'), flash=el('flash');
const commessa=el('commessa'), posizione=el('posizione');
const scaricaCSV=el('scaricaCSV'), finalizza=el('finalizza'), shareCSV=el('shareCSV');
const saveSession=el('saveSession'), loadSession=el('loadSession'), svuota=el('svuota');
const cameraSelect=el('cameraSelect');

/* Audio + voce */
let actx;
function tone(f=880,d=150,t='sine',v=.25){try{if(!actx)actx=new (window.AudioContext||window.webkitAudioContext)();const o=actx.createOscillator(),g=actx.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(actx.destination);o.start();setTimeout(()=>o.stop(),d);}catch(e){}}
function okSound(){tone(900,120);setTimeout(()=>tone(1200,140),130)}
function errSound(){tone(250,240,'square',.22);setTimeout(()=>tone(180,250,'square',.20),220)}
function speak(msg,rate=1,pitch=1,vol=1){if(!voice.checked)return;try{const u=new SpeechSynthesisUtterance(msg);u.lang='it-IT';u.volume=vol;u.rate=rate;u.pitch=pitch;const v=speechSynthesis.getVoices().find(x=>x.lang.startsWith('it'));if(v)u.voice=v;speechSynthesis.cancel();speechSynthesis.speak(u);}catch(e){}}
function vibrate(p){if(navigator.vibrate)navigator.vibrate(p)}
function flashScreen(c){flash.style.background=c;flash.style.opacity=.6;setTimeout(()=>flash.style.opacity=0,160)}
function setBadge(t,cls){badge.textContent=t;badge.className='badge '+(cls==='ok'?'ok':cls==='err'?'err':'')}
function norm(s){return s?String(s).trim().toUpperCase():s}
function status(m){statusLine.textContent=m||''}
function resetConfirm(){confirmBuf=[];lastVal=null;}
function sanitize(s,max=64){return String(s||'').replace(/[^\w\-\. \/]/g,'').slice(0,max)}

/* UI codici grandi */
function updateUI(){
  const same = expected && scanned && (norm(expected) === norm(scanned));
  const stateClass = same ? 'ok' : (expected && scanned ? 'err' : '');

  const box = (label, val, cls) => `
    <div class="codeBox ${cls||''}">
      <div class="codeLabel">${label}</div>
      <div class="codeValue ${cls||''}">${val ? val : '-'}</div>
    </div>`;

  codes.innerHTML = box('LISTA', expected || '', same ? 'ok' : '') +
                    box('PEZZO', scanned  || '', stateClass);

  if (expected && scanned){
    if (same){
      setBadge('‚úÖ CORRETTO','ok');
      resultText.innerHTML = 'Match perfetto!';
      flashScreen('rgba(22,163,74,.5)'); okSound(); speak("Codice corretto",1,1.1,1); vibrate(60);
      pendingOK = expected;
      openQtyModal(pendingOK);
    } else {
      setBadge('‚ùå ERRATO','err');
      resultText.innerHTML = 'Codice diverso!';
      flashScreen('rgba(220,38,38,.55)'); errSound(); speak("Errore, codice diverso",0.9,0.8,1); vibrate([60,60,180]);
      pendingOK = null;
    }
  } else {
    setBadge('Pronto');
    resultText.innerHTML = 'Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b>';
  }
}

/* Modal quantit√† minimale */
function openQtyModal(code){
  const qty = prompt(`Quantit√† per ${code}`, '1');
  const v = Math.max(1, parseInt(qty||'1',10));
  const ts = new Date();
  picks.push({ts, codice: sanitize(code,128), qty:v, commessa: sanitize(commessa.value,64), posizione: sanitize(posizione.value,64)});
  renderPicks();
  pendingOK=null; scanned=null; updateUI();
}

/* Tabella righe raccolte */
function renderPicks(){
  const tb = document.querySelector('#righeTbl tbody');
  tb.innerHTML = picks.map(p=>{
    const hh = p.ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    return `<tr><td>${hh}</td><td>${p.codice}</td><td>${p.qty}</td><td>${p.commessa||'-'}</td><td>${p.posizione||'-'}</td></tr>`;
  }).join('');
  const has = picks.length>0;
  document.getElementById('scaricaCSV').disabled = !has;
  document.getElementById('svuota').disabled = !has;
}

/* CSV */
function toCSV(){
  const head = 'timestamp_ms,iso,codice,quantita,commessa,posizione\n';
  const body = picks.map(p=>{
    return [p.ts.getTime(), p.ts.toISOString(), p.codice, p.qty, p.commessa||'', p.posizione||'']
      .map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
  }).join('\n');
  return head+body;
}
function downloadCSV(){
  if(!picks.length) return;
  const csv = toCSV();
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `scheda_picking_${(commessa.value||'commessa')}.csv`; a.click();
  URL.revokeObjectURL(url);
}
async function shareCSVFile(){
  try{
    if(!('share' in navigator) || !picks.length) return downloadCSV();
    const csv = toCSV();
    const file = new File([csv], `scheda_picking_${(commessa.value||'commessa')}.csv`, {type:'text/csv'});
    await navigator.share({ files: [file], title: 'Scheda picking', text: 'Dati picking esportati' });
  }catch(_){ downloadCSV(); }
}

/* Sessione locale */
const SKEY='poka_session_v1';
function saveLocal(){
  const data = {
    when: Date.now(),
    commessa: sanitize(commessa.value,64),
    posizione: sanitize(posizione.value,64),
    picks: picks.map(p=>({ts:p.ts.getTime(), codice:p.codice, qty:p.qty, commessa:p.commessa, posizione:p.posizione}))
  };
  localStorage.setItem(SKEY, JSON.stringify(data));
  alert('‚úÖ Sessione salvata sul dispositivo.');
}
function loadLocal(){
  try{
    const raw = localStorage.getItem(SKEY); if(!raw){ alert('Nessuna sessione salvata.'); return; }
    const data = JSON.parse(raw);
    commessa.value = data.commessa||'';
    posizione.value = data.posizione||'';
    picks = (data.picks||[]).map(x=>({ts:new Date(x.ts), codice:x.codice, qty:x.qty, commessa:x.commessa, posizione:x.posizione}));
    renderPicks();
    alert('üìÇ Sessione caricata.');
  }catch(e){ alert('Errore nel caricamento sessione.'); }
}
function clearAll(){
  if(!picks.length) return;
  if(!confirm('Sicuro di svuotare la sessione corrente?')) return;
  picks = [];
  renderPicks();
  updateUI();
}

/* Pulsanti */
document.getElementById('scanList').onclick=()=>startScan('list');
document.getElementById('scanItem').onclick=()=>startScan('item');
document.getElementById('reset').onclick=()=>{expected=null;scanned=null;pendingOK=null;updateUI();};
document.getElementById('scaricaCSV').onclick = downloadCSV;
document.getElementById('finalizza').onclick = ()=>shareCSVFile();
document.getElementById('shareCSV').onclick  = ()=>shareCSVFile();
document.getElementById('saveSession').onclick = ()=>saveLocal();
document.getElementById('loadSession').onclick = ()=>loadLocal();
document.getElementById('svuota').onclick = ()=>clearAll();

/* Elenco fotocamere */
async function populateCameras(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const vids = devices.filter(d=>d.kind==='videoinput');
    cameraSelect.innerHTML = '<option value="">(automatico)</option>' +
      vids.map(v=>`<option value="${v.deviceId}">${v.label||'Fotocamera'}</option>`).join('');
  }catch(_){}
}
if(navigator.mediaDevices?.enumerateDevices){ populateCameras(); }

/* Scansione: Detector ‚Üí ZXing */
async function startScan(which){
  const cm = sanitize(commessa.value,64), ps = sanitize(posizione.value,64);
  if(!cm || !ps){ alert('Inserisci Numero commessa e Posizione prima di scansionare.'); return; }
  commessa.value = cm; posizione.value = ps;

  mode=which; cameraArea.style.display='block'; resetConfirm(); status('Avvio camera‚Ä¶');

  clearTimeout(cameraIdleTimer);
  cameraIdleTimer = setTimeout(()=>{ stopStream(); cameraArea.style.display='none'; }, 60_000);

  if('BarcodeDetector' in window){
    try{ await startDetectorHybrid(); return; } catch(e){}
  }
  await startZXingHybrid();
}

/* Debounce */
function canAccept(){
  const now = performance.now();
  if(now - lastScanTs < 600) return false;
  lastScanTs = now;
  return true;
}

/* Detector nativo */
async function startDetectorHybrid(){
  const constraints={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720},focusMode:"continuous"}};
  const chosen = cameraSelect.value;
  if(chosen) constraints.video.deviceId = { exact: chosen };

  stream=await navigator.mediaDevices.getUserMedia(constraints).catch(()=>null);
  if(!stream){ alert('Fotocamera non disponibile o permesso negato.'); cameraArea.style.display='none'; return; }
  track=stream.getVideoTracks()[0]; video.srcObject=stream; await video.play(); setupControls(track);

  const detector=new BarcodeDetector({formats:['qr_code','code_128','ean_13','ean_8','upc_a','code_39']});
  const ctx=overlay.getContext('2d');

  const loop=()=>{
    if(!stream){return;}
    if(video.readyState<2){ requestAnimationFrame(loop); return; }
    overlay.width=video.videoWidth; overlay.height=video.videoHeight; ctx.clearRect(0,0,overlay.width,overlay.height);

    detector.detect(video).then(codes=>{
      const g=guide.getBoundingClientRect(), v=video.getBoundingClientRect();
      const gx=g.left-v.left, gy=g.top-v.top, gw=g.width, gh=g.height;
      const sx=overlay.width/v.width, sy=overlay.height/v.height;

      let accepted=null;
      for(const c of codes){
        const r=c.boundingBox; const cx=r.x+r.width/2, cy=r.y+r.height/2;
        const domX=cx/sx, domY=cy/sy;
        const inGuide=(domX>=gx&&domX<=gx+gw&&domY>=gy&&domY<=gy+gh);
        const g2=laser.getBoundingClientRect();
        const lx=g2.left-v.left+g2.width/2, ly=g2.top-v.top+g2.height/2;
        const dist=Math.sqrt((domX-lx)**2+(domY-ly)**2);
        const radius=g2.width/2;
        if(inGuide && dist<radius){ accepted=c.rawValue; break; }
      }

      if(accepted && canAccept()){
        if(confirm2.checked){
          if(lastVal===accepted){ confirmBuf.push(accepted); } else { confirmBuf=[accepted]; lastVal=accepted; }
          if(confirmBuf.length>=2){ processScan(accepted); return; }
        } else { processScan(accepted); return; }
      }
      requestAnimationFrame(loop);
    }).catch(()=>requestAnimationFrame(loop));
  };
  loop();
}

/* ZXing fallback */
async function startZXingHybrid(){
  const constraints={video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}}};
  const chosen = cameraSelect.value;
  if(chosen) constraints.video.deviceId = { exact: chosen };

  const s=await navigator.mediaDevices.getUserMedia(constraints).catch(()=>null);
  if(!s){ alert('Fotocamera non disponibile o permesso negato.'); cameraArea.style.display='none'; return; }
  stream=s; track=stream.getVideoTracks()[0]; setupControls(track);

  const vid=document.createElement('video');
  vid.setAttribute('playsinline',''); vid.muted=true; vid.autoplay=true; vid.srcObject=stream;
  document.body.appendChild(vid);

  const formats=[ZXing.BarcodeFormat.QR_CODE,ZXing.BarcodeFormat.CODE_128,ZXing.BarcodeFormat.EAN_13,ZXing.BarcodeFormat.UPC_A,ZXing.BarcodeFormat.CODE_39];
  const hints=new Map(); hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,formats);
  const reader=new ZXing.BrowserMultiFormatReader(hints);

  await vid.play(); status('Inquadra il codice nel cerchio rosso‚Ä¶');

  const loop=async()=>{
    try{
      const res=await reader.decodeFromVideoElement(vid);
      if(res && canAccept()){ if(pointInGuideZXing(res,vid)){ processScan(res.text); return; } }
    }catch(e){}
    requestAnimationFrame(loop);
  };
  loop();
}

function pointInGuideZXing(result,vidEl){
  try{
    const pts=result.resultPoints||[]; if(pts.length===0) return true;
    let cx=0,cy=0; for(const p of pts){ cx+=p.x; cy+=p.y; } cx/=pts.length; cy/=pts.length;
    const vrect=vidEl.getBoundingClientRect();
    const vw=vidEl.videoWidth, vh=vidEl.videoHeight;
    const scale=Math.min(vrect.width/vw, vrect.height/vh);
    const dispW=vw*scale, dispH=vh*scale;
    const offX=(vrect.width-dispW)/2, offY=(vrect.height-dispH)/2;
    const domX=offX+cx*scale, domY=offY+cy*scale;
    const g2=laser.getBoundingClientRect();
    const lx=g2.left-vrect.left+g2.width/2, ly=g2.top-vrect.top+g2.height/2;
    const dist=Math.sqrt((domX-lx)**2+(domY-ly)**2);
    return (dist < g2.width/2);
  }catch(e){ return true; }
}

/* Gestione lettura singola */
function processScan(text){
  const val = sanitize(text,128);
  if(mode==='list') expected = val; else scanned = val;
  stopStream(); cameraArea.style.display='none'; updateUI();
}

/* Stop camera */
function stopStream(){
  try{
    if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
    if(track) track.stop();
  }catch(e){}
  status('');
  clearTimeout(cameraIdleTimer); cameraIdleTimer=null;
}

/* LED / Zoom */
function setupControls(track){
  btnTorch.disabled=true;
  try{
    const caps=track.getCapabilities?.()||{};
    if('torch' in caps){
      btnTorch.disabled=false; let on=false;
      btnTorch.onclick=async()=>{
        on=!on;
        try{ await track.applyConstraints({advanced:[{torch:on}]}); status(on?'LED: ON':'LED: OFF'); }
        catch(e){ status('LED non disponibile'); on=false; }
      };
    }
  }catch(e){}

  btnZoomIn.disabled=true; btnZoomOut.disabled=true;
  try{
    const caps=track.getCapabilities?.()||{};
    if(caps.zoom){
      let z=track.getSettings().zoom||1, step=caps.zoom.step||0.25;
      const min=caps.zoom.min||1, max=caps.zoom.max||z||1;
      btnZoomIn.disabled=false; btnZoomOut.disabled=false;
      btnZoomIn.onclick=()=>applyZoom(Math.min(max,(z||1)+step));
      btnZoomOut.onclick=()=>applyZoom(Math.max(min,(z||1)-step));
      async function applyZoom(nv){
        try{ await track.applyConstraints({advanced:[{zoom:nv}]}); z=nv; status('Zoom: '+nv.toFixed(2)); }
        catch(e){}
      }
    }
  }catch(e){}
}

/* Utilit√† */
function status(m){ document.getElementById('statusLine').textContent = m||''; }
function updateUI(){
  const same = expected && scanned && (norm(expected) === norm(scanned));
  const stateClass = same ? 'ok' : (expected && scanned ? 'err' : '');
  const box = (label, val, cls) => `
    <div class="codeBox ${cls||''}">
      <div class="codeLabel">${label}</div>
      <div class="codeValue ${cls||''}">${val ? val : '-'}</div>
    </div>`;
  document.getElementById('codes').innerHTML = box('LISTA', expected || '', same ? 'ok' : '') +
                                               box('PEZZO', scanned  || '', stateClass);
  if (expected && scanned){
    if (same){
      document.getElementById('badge').textContent='‚úÖ CORRETTO';
      document.getElementById('badge').className='badge ok';
      document.getElementById('resultText').innerHTML='Match perfetto!';
      flashScreen('rgba(22,163,74,.5)'); okSound(); speak("Codice corretto",1,1.1,1); vibrate(60);
      pendingOK = expected;
      openQtyModal(pendingOK);
    } else {
      document.getElementById('badge').textContent='‚ùå ERRATO';
      document.getElementById('badge').className='badge err';
      document.getElementById('resultText').innerHTML='Codice diverso!';
      flashScreen('rgba(220,38,38,.55)'); errSound(); speak("Errore, codice diverso",0.9,0.8,1); vibrate([60,60,180]);
      pendingOK=null;
    }
  } else {
    document.getElementById('badge').textContent='Pronto';
    document.getElementById('badge').className='badge';
    document.getElementById('resultText').innerHTML='Scansiona prima la <b>LISTA</b>, poi il <b>PEZZO</b>';
  }
}
updateUI();
</script>
</body>
</html>